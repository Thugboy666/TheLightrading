<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>TheLight24 Universe ‚Äì B2B Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: light;
      --accent-color: #ff7b00;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      color: #000000;
      overflow: hidden;
      height: 100dvh;
    }
    #app {
      position: relative;
      width: 100vw;
      height: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
    }
    #universe-canvas {
      position: absolute;
      inset: 0;
      touch-action: none;
      z-index: 0;
    }

    /* Top bar */
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 8px 10px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.9);
      z-index: 50;
      gap: 6px;
      min-height: 46px;
    }
    #brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    #brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      white-space: nowrap;
      display: none;
    }
    #brand-logo {
      max-width: 140px;
      height: auto;
      display: block;
      cursor: pointer;
    }
    #brand-sub {
      font-size: 10px;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
      color: #000000;
    }
    #user-panel {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
    }
    .daily-offer-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border-width: 1px;
      max-width: 220px;
      text-align: left;
    }

    .daily-offer-icon {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .daily-offer-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .daily-offer-line1 {
      font-size: 11px;
      font-weight: 700;
    }

    .daily-offer-line2 {
      font-size: 9px;
      opacity: 0.8;
    }
    .pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      color: #000000;
    }
    .pill span.label { opacity: 0.7; }
    .btn {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--accent-color);
      color: #000000;
      background: #ffffff;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.secondary {
      background: #ffffff;
      border: 1px solid var(--accent-color);
      color: #000000;
    }
    .btn:active { transform: scale(0.97); }

    @media (max-width: 480px) {
      #top-bar { padding: 4px 6px; }
      #brand-title { font-size: 11px; }
      #brand-sub { display: none; }
      #user-panel { gap: 4px; }
      #btn-orders, #btn-login, #btn-register {
        padding-inline: 6px;
        font-size: 10px;
      }
      #tier-pill { display: none; }
    }

    /* Top-right controls (Indietro + Chat AI) */
    #top-right-controls {
      position: absolute;
      top: 52px;
      right: 10px;
      z-index: 25;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      pointer-events: none; /* noi riabilitiamo sui bottoni */
    }
    .top-ctrl-btn {
      pointer-events: auto;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .top-ctrl-btn span.icon {
      font-size: 11px;
      opacity: 0.9;
    }

    @media (max-width: 480px) {
      #top-right-controls {
        top: 72px;
        right: 8px;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: flex-end;
      }
    }

    /* Bottom info panel */
    #info-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px;
      z-index: 15;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(255,255,255,0.9);
    }
    #zoom-level { font-size: 11px; opacity: 0.8; }
    #location-path { font-size: 11px; opacity: 0.9; }
    #hint { font-size: 10px; opacity: 0.7; }
    #entity-card {
      margin-top: 4px;
      background: #ffffff;
      border-radius: 14px;
      padding: 8px;
      border: 1px solid var(--accent-color);
      display: none;
      flex-direction: column;
      gap: 4px;
      color: #000000;
    }
    #entity-type {
      font-size: 10px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    #entity-title { font-size: 12px; font-weight: 600; }
    #entity-meta { font-size: 10px; opacity: 0.85; }
    #entity-rating { font-size: 11px; }
    #entity-price-line {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #entity-price {
      font-size: 13px;
      font-weight: 600;
      color: #000000;
    }
    #entity-qty {
      width: 60px;
      border-radius: 999px;
      padding: 3px 6px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 11px;
    }
    #entity-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    #entity-offer-box {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px dashed var(--accent-color);
      background: rgba(255,123,0,0.06);
      font-size: 11px;
      color: #000000;
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    #discount-sim-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #discount-sim-row label {
      font-size: 11px;
      opacity: 0.8;
    }
    #discount-sim-input {
      border-radius: 10px;
      border: 1px solid var(--accent-color);
      padding: 6px 8px;
      background: #ffffff;
      color: #000000;
      font-size: 12px;
    }
    #discount-sim-output {
      font-size: 11px;
      color: #000000;
      opacity: 0.9;
    }

    /* Promo points sheet */
    #promo-points-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 6px;
      padding: 8px 4px 2px;
    }
    #promo-points-value {
      font-size: 28px;
      font-weight: 700;
      color: #000000;
    }
    #promo-points-status {
      font-size: 12px;
      color: #0f172a;
    }
    #promo-points-inactive {
      font-size: 12px;
      text-align: center;
      color: #0f172a;
      padding: 8px 4px 0;
    }
    .tag {
      border-radius: 999px;
      font-size: 9px;
      padding: 2px 6px;
      background: rgba(30,64,175,0.4);
      border: 1px solid rgba(96,165,250,0.5);
    }
    #entity-admin-actions {
      display: none;
      justify-content: flex-end;
      margin-top: 4px;
    }

    /* Floating nav buttons */
    #nav-buttons {
      margin-top: 4px;
      align-self: flex-end;
      display: flex;
      flex-direction: row;
      gap: 6px;
      position: static;
    }
    .icon-btn {
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 12px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .icon-btn span { font-size: 13px; }

    .floating-tag {
      position: absolute;
      padding: 4px 8px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--accent-color);
      font-size: 11px;
      color: #000000;
      pointer-events: none;
      text-align: center;
      transform: translate(-50%, -50%);
      z-index: 30;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      will-change: transform;
    }

    .floating-badge {
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .floating-badge.active {
      background: rgba(22,163,74,0.9);
      color: #ffffff;
      border-color: rgba(22,163,74,1);
    }
    .floating-badge.inactive {
      background: rgba(148,163,184,0.9);
      color: #ffffff;
      border-color: rgba(148,163,184,1);
    }

    /* Modal / sheets */
    .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
    }
    .sheet {
      width: 100%;
      max-height: 88dvh;
      background: #ffffff;
      border-radius: 18px 18px 0 0;
      padding: 10px 14px 14px;
      border: 1px solid var(--accent-color);
      overflow-y: auto;
      color: #000000;
    }
    .sheet h2 {
      font-size: 14px;
      margin: 0 0 4px;
    }
    .sheet p {
      font-size: 11px;
      margin: 0 0 8px;
      opacity: 0.8;
    }
    .field {
      margin-bottom: 6px;
    }
    .field label {
      font-size: 11px;
      display: block;
      margin-bottom: 2px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 12px;
    }
    .field textarea {
      min-height: 60px;
      resize: vertical;
    }
    .field small {
      font-size: 9px;
      opacity: 0.6;
    }
    .sheet-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .two-cols {
      display: flex;
      gap: 8px;
    }
    .two-cols .field { flex: 1; }
    @media (max-width: 640px) {
      .two-cols { flex-direction: column; }
    }

    .html-preview {
      border-radius: 8px;
      border: 1px solid var(--accent-color);
      padding: 6px 8px;
      font-size: 11px;
      background: #ffffff;
      max-height: 160px;
      overflow-y: auto;
      color: #000000;
    }

    /* Orders */
    .orders-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 10px 0;
    }
    .orders-filters .field { flex: 1; min-width: 140px; }
    .orders-filters label { font-size: 10px; }
    .orders-filters input,
    .orders-filters select {
      border-color: rgba(0,0,0,0.15);
    }

    .orders-table-wrapper {
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      overflow-x: auto;
      background: #ffffff;
    }
    table.orders-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .orders-table th,
    .orders-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .orders-table th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(0,0,0,0.02);
    }
    .orders-table tr:last-child td { border-bottom: none; }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      border: 1px solid transparent;
    }
    .badge-success { background: #dcfce7; color: #166534; border-color: #86efac; }
    .badge-danger { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
    .badge-neutral { background: #f3f4f6; color: #111827; border-color: #e5e7eb; }
    .badge-purple { background: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }

    .orders-empty {
      text-align: center;
      font-size: 11px;
      padding: 10px;
      color: #4b5563;
    }

    .orders-cards { display: none; flex-direction: column; gap: 8px; }
    .order-card {
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 10px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .order-card-header { display: flex; justify-content: space-between; gap: 8px; font-weight: 600; }
    .order-card-meta { font-size: 10px; color: #4b5563; }
    .order-card-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .order-card strong { font-size: 11px; }

    @media (max-width: 720px) {
      .orders-table-wrapper { display: none; }
      .orders-cards { display: flex; }
    }

    #toast {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22,163,74,0.9);
      color: #000000;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
      z-index: 60;
    }

    /* LLM CHAT SHEET */
    #sheet-llm-chat .sheet {
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }
    #llm-chat-log {
      border-radius: 10px;
      border: 1px solid var(--accent-color);
      padding: 6px 8px;
      font-size: 11px;
      background: #ffffff;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .llm-msg {
      padding: 4px 6px;
      border-radius: 8px;
      max-width: 92%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .llm-msg.user {
      align-self: flex-end;
      background: rgba(255,123,0,0.15);
      border: 1px solid var(--accent-color);
    }
    .llm-msg.bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid var(--accent-color);
    }
    #llm-status {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }
    #llm-chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    #llm-chat-input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 11px;
    }
    #btn-llm-send {
      font-size: 11px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 0;
      background: #22c55e;
      color: #000000;
      cursor: pointer;
    }
  </style>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
</head>
<body>
<div id="app">
  <canvas id="universe-canvas"></canvas>

  <!-- TOP BAR -->
  <div id="top-bar">
    <div id="brand">
      <a href="https://www.ormanet.it" target="_blank">
        <img id="brand-logo" src="/assets/logo_ormanet.png" alt="Ormanet" />
      </a>
      <div id="brand-sub">powered by thelight24</div>
      <div id="brand-title"></div>
    </div>

    <button class="btn daily-offer-btn" id="btn-daily-offer">
      <span class="daily-offer-icon">
        <img src="/assets/textures/coupon.png" alt="Coupon" style="width:18px;height:18px;object-fit:contain;" />
      </span>
      <span class="daily-offer-text">
        <span class="daily-offer-line1">Offerta daily</span>
        <span class="daily-offer-line2">prodotto del giorno in sconto</span>
      </span>
    </button>
    <div id="user-panel">
      <div class="pill" id="tier-pill">
        <span class="label">Listino:</span>
        <span id="tier-label">ospite</span>
      </div>
      <button class="btn secondary" id="btn-admin" style="display:none;">Admin</button>
      <button class="btn secondary" id="btn-orders">üìÑ Ordini</button>
      <button class="btn secondary" id="btn-login">Login</button>
      <button class="btn secondary" id="btn-logout" style="display:none;">Logout</button>
      <button class="btn" id="btn-register">Registrati</button>
    </div>
  </div>

  <!-- TOP RIGHT: INDIETRO + CHAT AI -->
  <div id="top-right-controls">
    <button id="btn-back" class="top-ctrl-btn">
      <span class="icon">‚Üê</span><span>Indietro</span>
    </button>
    <button id="btn-open-llm" class="top-ctrl-btn">
      <span class="icon">‚ú¶</span><span>Chat AI</span>
    </button>
  </div>

  <!-- BOTTOM PANEL -->
  <div id="info-panel">
    <div id="zoom-level">Livello: GALASSIA</div>
    <div id="location-path">Posizione: /</div>
    <div id="hint">Pinch/zoom o tap per esplorare. Tocca sistemi, stelle, pianeti e satelliti per scendere di livello.</div>

    <div id="daily-coupon-box" class="coupon-box" style="display:none; margin-top:6px; padding:6px; border-radius:8px; border:1px solid var(--accent-color); background:#fffbe6;">
      <div style="font-size:11px;font-weight:600;margin-bottom:4px;">Offerta daily ‚Äì prodotto del giorno</div>
      <div id="daily-coupon-code" style="font-size:16px;font-weight:700;margin-bottom:4px;"></div>
      <div id="daily-coupon-product" style="font-size:11px;margin-bottom:4px;"></div>
      <div id="daily-coupon-validity" style="font-size:10px;opacity:0.7;margin-bottom:4px;"></div>

      <div style="font-size:10px;margin-bottom:6px;">
        <strong>IMPORTANTE:</strong> per utilizzare il coupon devi:
        <ol style="margin:4px 0 0 14px;padding:0;">
          <li>Essere gi√† loggato sul sito Ormanet.</li>
          <li>Inserire nel carrello il prodotto corrispondente all'offerta daily.</li>
          <li>Incollare il codice coupon nel campo dedicato, nella pagina carrello.</li>
          <li>Lo sconto verr√† applicato solo se l'ordine verr√† evaso nella stessa giornata.</li>
        </ol>
      </div>

      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button class="btn" id="btn-copy-coupon">Copia coupon</button>
        <button class="btn" id="btn-go-cart">Vai al tuo carrello</button>
      </div>
    </div>

    <div id="entity-card">
      <div id="entity-type"></div>
      <div id="entity-image-wrapper" style="display:none; margin-bottom:4px;">
        <img id="entity-image" src="" alt="" style="width:72px;height:72px;object-fit:contain;border-radius:10px;border:1px solid var(--accent-color);background:#fff;" />
      </div>
      <div id="entity-title"></div>
      <div id="entity-meta"></div>
      <div id="entity-rating"></div>
      <div id="entity-price-line">
        <div id="entity-price"></div>
        <div id="entity-qty-wrapper" style="display:none; align-items:center; gap:4px;">
          <span style="font-size:10px;opacity:0.7;">Qt√†</span>
          <input id="entity-qty" type="number" min="1" step="1" value="1" />
          <button class="btn" id="btn-orders-shortcut" style="font-size:10px;padding-inline:8px;">Storico ordini</button>
        </div>
      </div>
      <div id="entity-tags"></div>
      <div id="entity-offer-box">
        <div id="entity-offer-title" style="font-weight:600;"></div>
        <div id="discount-sim-row">
          <label id="discount-sim-label"></label>
          <input id="discount-sim-input" type="number" min="0" step="1" placeholder="Inserisci importo" />
          <button id="promo-discount-sim-btn" class="btn" style="display:none; font-size:10px;padding-inline:8px;">Calcola sconto</button>
          <div id="discount-sim-output"></div>
        </div>
        <div id="entity-promo-summary"></div>
      </div>
      <div id="entity-admin-actions">
        <button class="btn secondary" id="btn-edit-product" style="font-size:10px;padding-inline:8px;">Modifica scheda</button>
      </div>
    </div>

    <div id="nav-buttons">
      <button class="icon-btn" id="btn-up">
        <span>‚Üë</span><span>Livello su</span>
      </button>
    </div>
  </div>

  <!-- MODAL: REGISTRAZIONE -->
  <div class="backdrop" id="sheet-register">
    <div class="sheet">
      <h2>Registrazione B2B / B2C</h2>
      <p>Per vedere i prezzi devi creare un account. Dopo la verifica ti assegneremo il listino commerciale pi√π adatto al tuo profilo.</p>

      <div class="field">
        <label>Sei un‚Äôazienda o un privato?</label>
        <select id="reg-type">
          <option value="azienda">Azienda</option>
          <option value="privato">Privato</option>
        </select>
      </div>

      <div class="field">
        <label>Ragione sociale / Nome completo</label>
        <input id="reg-name" placeholder="Es. Ormanet S.r.l. / Mario Rossi" />
      </div>

      <div class="field">
        <label>Partita IVA</label>
        <input id="reg-piva" placeholder="ITXXXXXXXXXXX" />
        <small>Obbligatoria per aziende. Per privati puoi lasciare vuoto.</small>
      </div>

      <div class="field">
        <label>Codice SDI / PEC</label>
        <input id="reg-sdi" placeholder="Codice destinatario o PEC" />
      </div>

      <div class="field">
        <label>Regime fiscale</label>
        <select id="reg-regime">
          <option value="ordinario">Ordinario</option>
          <option value="forfettario">Forfettario</option>
          <option value="minimi">Regime dei minimi</option>
          <option value="privato">Privato / no P.IVA</option>
        </select>
      </div>

      <div class="field">
        <label>Indirizzo completo attivit√†</label>
        <textarea id="reg-address" placeholder="Via, numero civico, CAP, citt√†, provincia, nazione"></textarea>
      </div>

      <div class="field">
        <label>Email</label>
        <input id="reg-email" type="email" placeholder="esempio@azienda.it" />
      </div>

      <div class="field">
        <label>Telefono / WhatsApp</label>
        <input id="reg-phone" placeholder="+39‚Ä¶" />
      </div>

      <div class="field">
        <label>Come ci hai conosciuti?</label>
        <input id="reg-source" placeholder="Google, passaparola, Amazon, fiera, agente, ecc." />
      </div>

      <div class="field">
        <label>Link o note visura camerale</label>
        <textarea id="reg-visura" placeholder="URL alla visura o note (es. allegata via email, disponibile su richiesta)."></textarea>
      </div>

      <div class="field">
        <label>Metodo di pagamento preferito</label>
        <select id="reg-payment">
          <option value="bonifico">Bonifico bancario (default)</option>
          <option value="contrassegno">Contrassegno</option>
          <option value="carta">Carta / POS virtuale</option>
          <option value="altro">Altro (da concordare)</option>
        </select>
      </div>

      <div class="field">
        <label>
          <input type="checkbox" id="reg-terms" />
          Accetto termini & condizioni, informativa privacy e condizioni di pagamento.
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-reg-cancel">Annulla</button>
        <button class="btn" id="btn-reg-submit">Crea account</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGIN -->
  <div class="backdrop" id="sheet-login">
    <div class="sheet">
      <h2>Login</h2>
      <p>Accedi con la tua email e la password impostata dopo l‚Äôattivazione account.</p>

      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="login-password" type="password" />
      </div>

      <div class="field">
        <label>
          <input type="checkbox" id="login-remember" />
          Ricordami su questo dispositivo
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-login-cancel">Annulla</button>
        <button class="btn" id="btn-login-submit">Entra</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ACCOUNT UTENTE -->
  <div class="backdrop" id="sheet-account">
    <div class="sheet">
      <h2>Account</h2>
      <p>Gestisci i dati del tuo account e la password.</p>

      <div class="field">
        <label>Email</label>
        <input id="account-email" type="email" readonly />
      </div>

      <div class="sheet-actions" style="justify-content:space-between;">
        <button class="btn secondary" id="btn-account-close">Chiudi</button>
        <div style="display:flex; gap:6px;">
          <button class="btn secondary" id="btn-account-change-password">Cambia password</button>
          <button class="btn" id="btn-account-logout">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: RESET PASSWORD -->
  <div class="backdrop" id="sheet-password-reset">
    <div class="sheet">
      <h2>Reset password</h2>
      <p>Per sicurezza inserisci la password attuale e scegli una nuova password.</p>

      <div class="field">
        <label>Password attuale</label>
        <input id="pwd-current" type="password" autocomplete="current-password" />
      </div>

      <div class="field">
        <label>Nuova password</label>
        <input id="pwd-new" type="password" autocomplete="new-password" />
      </div>

      <div class="field">
        <label>Conferma nuova password</label>
        <input id="pwd-new-confirm" type="password" autocomplete="new-password" />
      </div>

      <small style="font-size:10px;opacity:0.7;">
        Suggerimento: usa almeno 8 caratteri, con lettere e numeri.
      </small>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-pwd-reset-cancel">Annulla</button>
        <button class="btn" id="btn-pwd-reset-submit">Salva nuova password</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PROMO PUNTI -->
  <div class="backdrop" id="sheet-promo-points">
    <div class="sheet">
      <h2>Promo Natale ‚Äì Stato punti</h2>
      <div id="promo-points-card">
        <div id="promo-points-value">0 punti</div>
        <div id="promo-points-status">Aggiorniamo il tuo saldo punti‚Ä¶</div>
      </div>
      <div id="promo-points-inactive" style="display:none;">
        Non risulti attivo sulla Promo Natale. Contatta il tuo referente commerciale Ormanet per essere abilitato.
      </div>
      <div class="sheet-actions" style="justify-content:flex-end;">
        <button class="btn secondary" id="btn-promo-points-close">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ORDINI -->
  <div class="backdrop" id="sheet-orders">
    <div class="sheet">
      <h2>Storico ordini</h2>
      <p>Qui trovi gli ordini dell‚Äôultimo mese.</p>

      <div class="orders-filters">
        <div class="field">
          <label>Dal</label>
          <input type="date" id="orders-date-from" />
        </div>
        <div class="field">
          <label>Al</label>
          <input type="date" id="orders-date-to" />
        </div>
        <div class="field">
          <label>Stato</label>
          <select id="orders-status-filter">
            <option value="">Tutti</option>
            <option value="evaso">Evaso</option>
            <option value="da evadere">Da evadere</option>
          </select>
        </div>
        <div class="field">
          <label>Causale</label>
          <select id="orders-cause-filter">
            <option value="">Tutte</option>
            <option value="richiesta in elaborazione">Richiesta in elaborazione</option>
            <option value="disponibile">Disponibile</option>
            <option value="in arrivo">In arrivo</option>
          </select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="btn" id="btn-orders-apply">Applica filtri</button>
        </div>
      </div>

      <div class="orders-table-wrapper">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Data ordine</th>
              <th>Numero documento</th>
              <th>Stato</th>
              <th>Causale</th>
              <th>Ragione sociale</th>
              <th>Email</th>
              <th>Totale</th>
            </tr>
          </thead>
          <tbody id="orders-table-body"></tbody>
        </table>
      </div>

      <div class="orders-cards" id="orders-cards"></div>
      <div class="orders-empty" id="orders-empty" style="display:none;">Non sono presenti ordini per questo periodo.</div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-orders-close">Chiudi</button>
        <button class="btn" id="btn-orders-refresh">Aggiorna</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PRODUCT EDITOR -->
  <div class="backdrop" id="sheet-product-editor">
    <div class="sheet">
      <h2>Editor scheda prodotto</h2>
      <p>Modifica contenuti, immagini HD e listini partendo dal listino madre.</p>

      <div class="two-cols">
        <div class="field">
          <label>SKU (bloccato)</label>
          <input id="prod-sku" readonly />
        </div>
        <div class="field">
          <label>Codice articolo</label>
          <input id="prod-code" type="text" />
        </div>
      </div>

      <div class="field">
        <label>Nome prodotto</label>
        <input id="prod-name" />
      </div>

      <div class="two-cols">
        <div class="field">
          <label>URL immagine HD principale</label>
          <input id="prod-image-hd" placeholder="https://..." />
        </div>
        <div class="field">
          <label>URL immagine thumbnail</label>
          <input id="prod-image-thumb" placeholder="https://..." />
        </div>
      </div>

      <div class="field">
        <label>Gallery immagini (una URL per riga)</label>
        <textarea id="prod-gallery" placeholder="https://img1...\nhttps://img2..."></textarea>
      </div>

      <div class="field">
        <label>Descrizione HTML (sorgente)</label>
        <textarea id="prod-desc-html" placeholder="<h2>Caratteristiche</h2>..."></textarea>
      </div>
      <div class="field">
        <label>Preview descrizione</label>
        <div id="prod-desc-preview" class="html-preview"></div>
      </div>

      <h2>Listini & ricarichi</h2>
      <p>Imposta il listino madre e le % di ricarico per i listini figli. I prezzi vengono ricalcolati automaticamente.</p>

      <div class="two-cols">
        <div class="field">
          <label>Prezzo listino madre (base)</label>
          <input id="prod-base-price" type="number" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Unit√† di misura (solo nota)</label>
          <input id="prod-unit" placeholder="es. pz, risma, conf, kg" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore +10%"</label>
          <input id="prod-markup-riv10" type="number" step="0.1" />
          <small>Es. 10 = +10% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore +10%</label>
          <input id="prod-price-riv10" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore"</label>
          <input id="prod-markup-riv" type="number" step="0.1" />
          <small>Es. 20 = +20% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore</label>
          <input id="prod-price-riv" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "distributore"</label>
          <input id="prod-markup-dist" type="number" step="0.1" />
          <small>Puoi anche usare valori negativi per sconti (-5 = -5%).</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato distributore</label>
          <input id="prod-price-dist" type="text" readonly />
        </div>
      </div>

      <h2>Prezzi per listino</h2>
      <p>Imposta i prezzi finali per ciascun listino. Questi valori possono differire dal calcolo teorico dei ricarichi.</p>

      <div class="two-cols">
        <div class="field">
          <label>Prezzo distributore</label>
          <input id="prod-price-dist-final" type="number" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Prezzo rivenditore</label>
          <input id="prod-price-riv-final" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>Prezzo rivenditore +10%</label>
          <input id="prod-price-riv10-final" type="number" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Quantit√† stock</label>
          <input id="prod-stock-qty" type="number" min="0" step="1" />
        </div>
      </div>

      <h2>Sconti di prodotto per listino (%)</h2>
      <p>Queste percentuali rappresentano lo sconto predefinito associato al prodotto per ciascun listino.</p>

      <div class="two-cols">
        <div class="field">
          <label>% sconto distributore</label>
          <input id="prod-discount-dist" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>% sconto rivenditore</label>
          <input id="prod-discount-riv" type="number" step="0.1" />
        </div>
      </div>

      <div class="field">
        <label>% sconto rivenditore +10%</label>
        <input id="prod-discount-riv10" type="number" step="0.1" />
      </div>

      <div class="field">
        <label>Status prodotto</label>
        <select id="prod-status">
          <option value="attivo">Attivo</option>
          <option value="non_disponibile">Non disponibile</option>
          <option value="in_arrivo">In arrivo</option>
          <option value="fuori_listino">Fuori listino</option>
        </select>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-prod-cancel">Annulla</button>
        <button class="btn" id="btn-prod-save">Salva scheda</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LLM CHAT -->
  <div class="backdrop" id="sheet-llm-chat">
    <div class="sheet">
      <h2>AI Assistant ‚Äì TheLight24</h2>
      <p>Chat locale con il modello Phi-3 Mini in esecuzione sul tuo dispositivo.</p>

      <div id="llm-chat-log"></div>
      <div id="llm-status"></div>

      <div id="llm-chat-input-row">
        <input id="llm-chat-input" type="text" placeholder="Scrivi una domanda (es. suggerimento prodotti HP)..." />
        <button id="btn-llm-send">Invia</button>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-llm-close">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADMIN -->
  <div class="backdrop" id="sheet-admin">
    <div class="sheet">
      <h2>Pannello Admin</h2>
      <div style="display:flex; gap:6px; margin-bottom:8px;">
        <button class="btn" id="admin-tab-clients">Clienti</button>
        <button class="btn secondary" id="admin-tab-offers">Macro Offerte</button>
        <button class="btn secondary" id="admin-tab-import">Import Listino</button>
        <button class="btn secondary" id="admin-tab-promo">Promo Natale</button>
      </div>
      <div id="admin-section-clients">
        <h3 style="margin:4px 0;">Gestione clienti</h3>
        <div class="two-cols">
          <div class="field">
            <label>Nome / Ragione sociale</label>
            <input id="client-name" />
          </div>
          <div class="field">
            <label>P.IVA</label>
            <input id="client-piva" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Email</label>
            <input id="client-email" type="email" />
          </div>
          <div class="field">
            <label>Telefono</label>
            <input id="client-phone" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Listino</label>
            <select id="client-listino">
              <option value="distributore">distributore</option>
              <option value="rivenditore">rivenditore</option>
              <option value="rivenditore10">rivenditore10</option>
            </select>
          </div>
          <div class="field">
            <label>Stato</label>
            <select id="client-stato">
              <option value="attivo">attivo</option>
              <option value="sospeso">sospeso</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Note</label>
          <textarea id="client-note"></textarea>
        </div>
        <div class="field">
          <label><input id="client-promo-enabled" type="checkbox" /> Partecipa promo Natale</label>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Punti promo</label>
            <input id="client-promo-points" type="number" readonly />
          </div>
          <div class="field">
            <label>Biglietto regalo</label>
            <input id="client-promo-ticket" type="text" readonly />
          </div>
        </div>
        <div class="sheet-actions">
          <button class="btn secondary" id="btn-client-reset">Nuovo</button>
          <button class="btn" id="btn-client-save">Salva</button>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Filtra per listino</label>
          <select id="client-filter">
            <option value="all">Tutti</option>
            <option value="distributore">distributore</option>
            <option value="rivenditore">rivenditore</option>
            <option value="rivenditore10">rivenditore10</option>
          </select>
        </div>
        <div class="html-preview" style="max-height:200px;">
          <table style="width:100%; font-size:11px; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:2px 4px;">Nome</th>
                <th style="text-align:left; padding:2px 4px;">P.IVA</th>
                <th style="text-align:left; padding:2px 4px;">Email</th>
                <th style="text-align:left; padding:2px 4px;">Listino</th>
                <th style="text-align:left; padding:2px 4px;">Promo</th>
                <th style="text-align:right; padding:2px 4px;">Azioni</th>
              </tr>
            </thead>
            <tbody id="clients-table"></tbody>
          </table>
        </div>
      </div>
      <div id="admin-section-offers" style="display:none;">
        <h3 style="margin:4px 0;">Macro Offerte</h3>
        <div class="field">
          <label>Offerta corrente</label>
          <select id="discount-offer-select"></select>
        </div>
        <div class="field">
          <label>Segmento</label>
          <select id="discount-segment">
            <option value="distributore">distributore</option>
            <option value="rivenditore">rivenditore</option>
            <option value="rivenditore10">rivenditore10</option>
          </select>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Min importo</label>
            <input id="discount-min" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Max importo</label>
            <input id="discount-max" type="number" step="0.01" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>% Sconto</label>
            <input id="discount-percent" type="number" step="0.1" />
          </div>
          <div class="field">
            <label>Validit√† fino a</label>
            <input id="discount-valid" type="date" />
          </div>
        </div>
        <div class="sheet-actions">
          <button class="btn secondary" id="btn-discount-remove">Rimuovi fascia</button>
          <button class="btn" id="btn-discount-add">Aggiungi / Aggiorna fascia</button>
        </div>
        <div class="html-preview" style="max-height:200px;" id="discount-rules-preview"></div>

        <div class="field" style="margin-top:12px;">
          <label><input id="mini-offer-toggle" type="checkbox" /> Mostra mini offerte (Admin)</label>
        </div>
        <div class="html-preview" id="mini-offer-panel"></div>

        <hr style="margin:12px 0;" />
        <h3 style="margin:4px 0;">Offerta Daily</h3>

        <div class="field">
          <label>Ricerca prodotto</label>
          <input id="daily-product-search" type="text" placeholder="Cerca per SKU, codice o nome prodotto..." />
          <small>La ricerca viene effettuata sugli articoli caricati da listino.</small>
        </div>

        <div class="field">
          <label>Prodotto in offerta daily</label>
          <select id="daily-product-select"></select>
          <small>Seleziona uno dei prodotti caricati da listino.</small>
        </div>

        <div class="two-cols">
          <div class="field">
            <label>Data/ora inizio</label>
            <input id="daily-start" type="datetime-local" />
          </div>
          <div class="field">
            <label>Data/ora fine</label>
            <input id="daily-end" type="datetime-local" />
          </div>
        </div>

        <div class="two-cols">
          <div class="field">
            <label>% sconto distributore</label>
            <input id="daily-discount-dist" type="number" step="0.1" />
          </div>
          <div class="field">
            <label>% sconto rivenditore</label>
            <input id="daily-discount-riv" type="number" step="0.1" />
          </div>
        </div>

        <div class="field">
          <label>% sconto rivenditore +10%</label>
          <input id="daily-discount-riv10" type="number" step="0.1" />
        </div>

        <div class="field">
          <label>Codice coupon (da mostrare ai clienti)</label>
          <input id="daily-coupon-code" type="text" placeholder="Es. DAILY-ORMANET-10" />
        </div>

        <div class="field">
          <label>Stato offerta</label>
          <select id="daily-active-flag">
            <option value="1">On (attiva)</option>
            <option value="0">Off (spenta)</option>
          </select>
        </div>

        <div class="sheet-actions">
          <button class="btn" id="btn-daily-save">Salva / Aggiorna daily</button>
          <button class="btn secondary" id="btn-daily-toggle">Attiva / Disattiva</button>
          <button class="btn secondary" id="btn-daily-delete">Elimina daily</button>
        </div>

        <div class="html-preview" id="daily-summary" style="margin-top:6px;"></div>
      </div>
      <div id="admin-section-import" style="display:none;">
        <h3 style="margin:4px 0;">Import Listino .XLSX</h3>
        <div class="field">
          <label>Carica file .xlsx (Excel moderno)</label>
          <input id="price-list-file" type="file" accept=".xlsx" />
          <small>
            Campi richiesti nel file .xlsx (intestazioni colonna, minuscolo/maiuscolo indifferente):<br />
            - <strong>codice</strong> (codice articolo interno, es: "codice", "codice_articolo", "codice articolo")<br />
            - <strong>nome</strong> o <strong>descrizione</strong> articolo<br />
            - <strong>prezzo_distributore</strong><br />
            - <strong>prezzo_rivenditore</strong><br />
            - <strong>prezzo_rivenditore10</strong><br />
            - <strong>quantit√†_stock</strong><br />
            - <strong>status</strong>
          </small>
        </div>
        <div class="sheet-actions">
          <button class="btn" id="btn-price-list-upload">Carica listino</button>
        </div>
        <div class="field" style="margin-top:8px;">
          <label>Ricerca prodotti</label>
          <input id="price-list-search" type="text" placeholder="Cerca per nome, descrizione, codice o SKU (match in qualsiasi punto della stringa)" />
        </div>

        <div class="html-preview" id="price-list-table-wrapper" style="max-height:220px; overflow:auto; margin-top:6px;">
          <!-- Tabella listino generata via JS -->
        </div>
      </div>
      <div id="admin-section-promo" style="display:none;">
        <h3 style="margin:4px 0;">Promo Natale / Biglietto regalo</h3>
        <div class="two-cols">
          <div class="field">
            <label>Data inizio promo</label>
            <input id="promo-start-date" type="date" />
          </div>
          <div class="field">
            <label>Data fine promo</label>
            <input id="promo-end-date" type="date" />
          </div>
        </div>
        <div class="sheet-actions" style="margin-top:4px;">
          <button class="btn" id="btn-promo-save-config">Salva config promo</button>
        </div>
        <div class="field">
          <label>Import anagrafiche aderenti (.xlsx)</label>
          <input id="promo-clients-file" type="file" accept=".xlsx" />
          <small>Ordine colonne senza intestazione: tipo, ragione sociale / nome, P.IVA, SDI/PEC, regime fiscale, indirizzo completo, email, telefono, come ci hai conosciuti, metodo di pagamento preferito, listino.</small>
        </div>
        <div class="sheet-actions" style="margin-top:4px;">
          <button class="btn" id="btn-promo-clients-upload">Importa aderenti promo</button>
        </div>
        <div class="html-preview" id="promo-clients-preview"></div>

        <h4 style="margin:10px 0 4px 0;">Gestione punti</h4>
        <div class="two-cols">
          <div class="field">
            <label>Cliente promo</label>
            <select id="promo-client-select"></select>
          </div>
          <div class="field">
            <label>Punti attuali</label>
            <input id="promo-client-points" type="text" readonly />
          </div>
        </div>
        <div class="field">
          <label>Azione</label>
          <select id="promo-action-select">
            <option value="">Seleziona azione</option>
            <option value="FOLLOW_SOCIAL">FOLLOW_SOCIAL ‚Äì +5 punti</option>
            <option value="ADD_BROADCAST">ADD_BROADCAST ‚Äì +50 punti</option>
            <option value="ORDER_REMAN">ORDER_REMAN ‚Äì +100 punti</option>
            <option value="REACH_AVG_REVENUE">REACH_AVG_REVENUE ‚Äì +200 punti</option>
            <option value="UPSELL_REVENUE">UPSELL_REVENUE ‚Äì +500 punti</option>
            <option value="BRING_NEW_COMPANY">BRING_NEW_COMPANY ‚Äì +1000 punti</option>
          </select>
        </div>
        <div class="sheet-actions" style="margin-top:4px;">
          <button class="btn" id="btn-promo-add-points">Aggiungi punti</button>
        </div>
        <div class="html-preview" id="promo-summary"></div>
        <div class="html-preview" id="promo-rules-static"></div>
      </div>
      <div class="sheet-actions">
        <button class="btn secondary" id="btn-admin-close">Chiudi</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>
</div>

<script>
  const BASE_URL = "http://127.0.0.1:8080"; // API ecom locale (Termux / backend thelight24)
  const LLM_URL = "http://127.0.0.1:8081/completion";

  const SYSTEM_TEXTURES = {
    ormanet: "/assets/textures/1.png",
  };

  const CATEGORY_TEXTURES = {
    "batterie": "/assets/textures/2.png",
    "cancelleria": "/assets/textures/3.png",
    "carta-stampa": "/assets/textures/4.png",
    "carta_stampa": "/assets/textures/4.png",
    "consumabili-originali": "/assets/textures/5.png",
    "consumabili_originali": "/assets/textures/5.png",
    "elettronica": "/assets/textures/6.png",
    "eliminacode": "/assets/textures/7.png",
    "rotoli-termici": "/assets/textures/8.png",
    "rotoli_termici": "/assets/textures/8.png",
    "stampanti": "/assets/textures/9.png",
    "storage": "/assets/textures/10.png",
    "consumabili-remanufactured": "/assets/textures/11.png",
    "consumabili_remanufactured": "/assets/textures/11.png",
  };

  const PROMO_TEXTURES = {
    natale: "/assets/textures/offerta_natale.png"
  };

  const adminSettings = {
    miniOfferEnabled: false,
  };

  let promoConfig = { start_date: null, end_date: null };
  let priceList = [];
  let dailyOffer = null;
  let clients = [];
  const offersUniverse = [
    {
      id: "ormanet",
      name: "Ormanet B2B",
      title: "Ormanet ‚Äì Universe B2B",
      texture: SYSTEM_TEXTURES["ormanet"],
      position: { x: 0, y: 1, z: -8 },
      tags: ["B2B", "Smart purchasing"],
      categories: [
        {
          id: "batterie",
          name: "Batterie",
          tags: ["energia", "ricarica"],
          subcategories: []
        },
        {
          id: "cancelleria",
          name: "Cancelleria",
          tags: ["ufficio"],
          subcategories: []
        },
        {
          id: "carta-stampa",
          name: "Carta per stampa",
          tags: ["risme", "ufficio"],
          subcategories: []
        },
        {
          id: "consumabili-originali",
          name: "Consumabili originali",
          tags: ["toner", "inkjet", "originali"],
          offerId: "offerta-consumabili-originali",
          subcategories: []
        },
        {
          id: "elettronica",
          name: "Elettronica",
          tags: ["device", "pc", "monitor"],
          subcategories: []
        },
        {
          id: "eliminacode",
          name: "Eliminacode",
          tags: ["gestione flussi"],
          subcategories: []
        },
        {
          id: "rotoli-termici",
          name: "Rotoli termici",
          tags: ["pos", "ricevute"],
          subcategories: []
        },
        {
          id: "stampanti",
          name: "Stampanti",
          tags: ["laser", "inkjet"],
          subcategories: []
        },
        {
          id: "storage",
          name: "Storage",
          tags: ["ssd", "hdd", "backup"],
          subcategories: []
        },
        {
          id: "consumabili-remanufactured",
          name: "Remanufactured",
          tags: ["green", "remanufactured"],
          subcategories: []
        }
      ]
    }
  ];
  let discountConfigs = [];

  let currentUser = {
    logged: false,
    tier: "ospite",
    name: null,
    token: null,
    email: null,
    is_admin: false,
  };

  let zoomLevel = "GALASSIA";
  let currentPath = [];
  let currentSystem = null;
  let currentCategory = null;
  let currentSubcategory = null;
  let currentEntity = null;
  let currentEntityType = null;

  let currentProductPrice = 0;

  const canvas = document.getElementById("universe-canvas");
  const appEl = document.getElementById("app");
  const tierLabel = document.getElementById("tier-label");
  const zoomLevelLabel = document.getElementById("zoom-level");
  const locationPathLabel = document.getElementById("location-path");
  const toast = document.getElementById("toast");

  const entityCard = document.getElementById("entity-card");
  const entityTypeEl = document.getElementById("entity-type");
  const entityTitleEl = document.getElementById("entity-title");
  const entityMetaEl = document.getElementById("entity-meta");
  const entityImageWrapper = document.getElementById("entity-image-wrapper");
  const entityImage = document.getElementById("entity-image");
  const entityRatingEl = document.getElementById("entity-rating");
  const entityPriceEl = document.getElementById("entity-price");
  const entityTagsEl = document.getElementById("entity-tags");
  const entityOfferBox = document.getElementById("entity-offer-box");
  const entityOfferTitle = document.getElementById("entity-offer-title");
  const entityPromoSummary = document.getElementById("entity-promo-summary");
  const discountSimLabel = document.getElementById("discount-sim-label");
  const discountSimInput = document.getElementById("discount-sim-input");
  const discountSimOutput = document.getElementById("discount-sim-output");
  const discountSimRow = document.getElementById("discount-sim-row");
  const promoDiscountSimBtn = document.getElementById("promo-discount-sim-btn");
  const entityQtyWrapper = document.getElementById("entity-qty-wrapper");
  const entityQtyInput = document.getElementById("entity-qty");
  const entityAdminActions = document.getElementById("entity-admin-actions");
  const btnAdmin = document.getElementById("btn-admin");

  const btnDailyOffer = document.getElementById("btn-daily-offer");
  const dailyCouponBox = document.getElementById("daily-coupon-box");
  const dailyCouponCodeEl = document.getElementById("daily-coupon-code");
  const dailyCouponProductEl = document.getElementById("daily-coupon-product");
  const dailyCouponValidityEl = document.getElementById("daily-coupon-validity");
  const btnCopyCoupon = document.getElementById("btn-copy-coupon");
  const btnGoCart = document.getElementById("btn-go-cart");

  const sheetRegister = document.getElementById("sheet-register");
  const sheetLogin = document.getElementById("sheet-login");
  const sheetAccount = document.getElementById("sheet-account");
  const sheetPasswordReset = document.getElementById("sheet-password-reset");
  const sheetPromoPoints = document.getElementById("sheet-promo-points");
  const sheetOrders = document.getElementById("sheet-orders");
  const ordersTableBody = document.getElementById("orders-table-body");
  const ordersCards = document.getElementById("orders-cards");
  const ordersEmpty = document.getElementById("orders-empty");
  const btnOrders = document.getElementById("btn-orders");
  const btnOrdersClose = document.getElementById("btn-orders-close");
  const btnOrdersRefresh = document.getElementById("btn-orders-refresh");
  const btnOrdersApply = document.getElementById("btn-orders-apply");
  const ordersStatusFilter = document.getElementById("orders-status-filter");
  const ordersCauseFilter = document.getElementById("orders-cause-filter");
  const ordersDateFrom = document.getElementById("orders-date-from");
  const ordersDateTo = document.getElementById("orders-date-to");
  const btnOrdersShortcut = document.getElementById("btn-orders-shortcut");

  const accountEmailInput = document.getElementById("account-email");
  const btnAccountClose = document.getElementById("btn-account-close");
  const btnAccountLogout = document.getElementById("btn-account-logout");
  const btnAccountChangePwd = document.getElementById("btn-account-change-password");

  const pwdCurrentInput = document.getElementById("pwd-current");
  const pwdNewInput = document.getElementById("pwd-new");
  const pwdNewConfirmInput = document.getElementById("pwd-new-confirm");
  const btnPwdResetCancel = document.getElementById("btn-pwd-reset-cancel");
  const btnPwdResetSubmit = document.getElementById("btn-pwd-reset-submit");

  const sheetProduct = document.getElementById("sheet-product-editor");
  const sheetAdmin = document.getElementById("sheet-admin");
  const skuInput = document.getElementById("prod-sku");
  const codeInput = document.getElementById("prod-code");
  const nameInput = document.getElementById("prod-name");
  const imageHdInput = document.getElementById("prod-image-hd");
  const imageThumbInput = document.getElementById("prod-image-thumb");
  const galleryInput = document.getElementById("prod-gallery");
  const descHtmlInput = document.getElementById("prod-desc-html");
  const descPreview = document.getElementById("prod-desc-preview");

  const basePriceInput = document.getElementById("prod-base-price");
  const unitInput = document.getElementById("prod-unit");
  const markupRiv10Input = document.getElementById("prod-markup-riv10");
  const markupRivInput = document.getElementById("prod-markup-riv");
  const markupDistInput = document.getElementById("prod-markup-dist");

  const priceDistFinalInput = document.getElementById("prod-price-dist-final");
  const priceRivFinalInput = document.getElementById("prod-price-riv-final");
  const priceRiv10FinalInput = document.getElementById("prod-price-riv10-final");
  const stockQtyInput = document.getElementById("prod-stock-qty");
  const discountDistInput = document.getElementById("prod-discount-dist");
  const discountRivInput = document.getElementById("prod-discount-riv");
  const discountRiv10Input = document.getElementById("prod-discount-riv10");
  const statusInput = document.getElementById("prod-status");

  const priceRiv10Output = document.getElementById("prod-price-riv10");
  const priceRivOutput = document.getElementById("prod-price-riv");
  const priceDistOutput = document.getElementById("prod-price-dist");

  const btnProdCancel = document.getElementById("btn-prod-cancel");
  const btnProdSave = document.getElementById("btn-prod-save");
  const btnEditProduct = document.getElementById("btn-edit-product");
  const adminTabClients = document.getElementById("admin-tab-clients");
  const adminTabOffers = document.getElementById("admin-tab-offers");
  const adminTabImport = document.getElementById("admin-tab-import");
  const adminTabPromo = document.getElementById("admin-tab-promo");
  const adminSectionClients = document.getElementById("admin-section-clients");
  const adminSectionOffers = document.getElementById("admin-section-offers");
  const adminSectionImport = document.getElementById("admin-section-import");
  const adminSectionPromo = document.getElementById("admin-section-promo");
  const clientsTable = document.getElementById("clients-table");
  const clientNameInput = document.getElementById("client-name");
  const clientPivaInput = document.getElementById("client-piva");
  const clientEmailInput = document.getElementById("client-email");
  const clientPhoneInput = document.getElementById("client-phone");
  const clientListinoInput = document.getElementById("client-listino");
  const clientStatoInput = document.getElementById("client-stato");
  const clientNoteInput = document.getElementById("client-note");
  const clientPromoEnabledInput = document.getElementById("client-promo-enabled");
  const clientPromoPointsInput = document.getElementById("client-promo-points");
  const clientPromoTicketInput = document.getElementById("client-promo-ticket");
  const clientFilterSelect = document.getElementById("client-filter");
  const btnClientSave = document.getElementById("btn-client-save");
  const btnClientReset = document.getElementById("btn-client-reset");
  const discountOfferSelect = document.getElementById("discount-offer-select");
  const discountSegmentSelect = document.getElementById("discount-segment");
  const discountMinInput = document.getElementById("discount-min");
  const discountMaxInput = document.getElementById("discount-max");
  const discountPercentInput = document.getElementById("discount-percent");
  const discountValidInput = document.getElementById("discount-valid");
  const btnDiscountAdd = document.getElementById("btn-discount-add");
  const btnDiscountRemove = document.getElementById("btn-discount-remove");
  const discountPreview = document.getElementById("discount-rules-preview");
  const miniOfferToggle = document.getElementById("mini-offer-toggle");
  const miniOfferPanel = document.getElementById("mini-offer-panel");
  const priceListFileInput = document.getElementById("price-list-file");
  const btnPriceListUpload = document.getElementById("btn-price-list-upload");
  const priceListSearchInput = document.getElementById("price-list-search");
  const priceListTableWrapper = document.getElementById("price-list-table-wrapper");
  const promoClientsFileInput = document.getElementById("promo-clients-file");
  const btnPromoClientsUpload = document.getElementById("btn-promo-clients-upload");
  const promoClientsPreview = document.getElementById("promo-clients-preview");
  const promoClientSelect = document.getElementById("promo-client-select");
  const promoClientPoints = document.getElementById("promo-client-points");
  const promoActionSelect = document.getElementById("promo-action-select");
  const btnPromoAddPoints = document.getElementById("btn-promo-add-points");
  const btnPromoSaveConfig = document.getElementById("btn-promo-save-config");
  const promoStartDateInput = document.getElementById("promo-start-date");
  const promoEndDateInput = document.getElementById("promo-end-date");
  const promoSummaryBox = document.getElementById("promo-summary");
  const promoRulesStatic = document.getElementById("promo-rules-static");

  const dailyProductSearchInput = document.getElementById("daily-product-search");
  const dailyProductSelect = document.getElementById("daily-product-select");
  const dailyStartInput = document.getElementById("daily-start");
  const dailyEndInput = document.getElementById("daily-end");
  const dailyDiscountDistInput = document.getElementById("daily-discount-dist");
  const dailyDiscountRivInput = document.getElementById("daily-discount-riv");
  const dailyDiscountRiv10Input = document.getElementById("daily-discount-riv10");
  const dailyCouponCodeInput = document.getElementById("daily-coupon-code");
  const dailyActiveFlagInput = document.getElementById("daily-active-flag");
  const dailySummaryBox = document.getElementById("daily-summary");
  const btnDailySave = document.getElementById("btn-daily-save");
  const btnDailyToggle = document.getElementById("btn-daily-toggle");
  const btnDailyDelete = document.getElementById("btn-daily-delete");

  const btnBack = document.getElementById("btn-back");
  const btnOpenLlm = document.getElementById("btn-open-llm");

  const sheetLlm = document.getElementById("sheet-llm-chat");
  const llmLog = document.getElementById("llm-chat-log");
  const llmStatus = document.getElementById("llm-status");
  const llmInput = document.getElementById("llm-chat-input");
  const btnLlmSend = document.getElementById("btn-llm-send");
  const btnLlmClose = document.getElementById("btn-llm-close");
  const btnAdminClose = document.getElementById("btn-admin-close");
  const btnPromoPointsClose = document.getElementById("btn-promo-points-close");

  const promoPointsCard = document.getElementById("promo-points-card");
  const promoPointsValue = document.getElementById("promo-points-value");
  const promoPointsStatus = document.getElementById("promo-points-status");
  const promoPointsInactive = document.getElementById("promo-points-inactive");

  let editingProduct = null;
  let editingClientId = null;

  const showSheet = (el) => { el.style.display = "flex"; };
  const hideSheet = (el) => { el.style.display = "none"; };

  document.getElementById("btn-register").addEventListener("click", () => showSheet(sheetRegister));
  document.getElementById("btn-reg-cancel").addEventListener("click", () => hideSheet(sheetRegister));
  document.getElementById("btn-login").addEventListener("click", () => {
    if (currentUser.logged) {
      accountEmailInput.value = currentUser.email || "";
      showSheet(sheetAccount);
    } else {
      showSheet(sheetLogin);
    }
  });
  document.getElementById("btn-login-cancel").addEventListener("click", () => hideSheet(sheetLogin));
  document.getElementById("btn-logout").addEventListener("click", logout);
  if (btnAccountClose) {
    btnAccountClose.addEventListener("click", () => hideSheet(sheetAccount));
  }
  if (btnAccountLogout) {
    btnAccountLogout.addEventListener("click", () => {
      hideSheet(sheetAccount);
      logout();
    });
  }
  if (btnAccountChangePwd) {
    btnAccountChangePwd.addEventListener("click", () => {
      hideSheet(sheetAccount);
      showSheet(sheetPasswordReset);
    });
  }
  if (btnPromoPointsClose) {
    btnPromoPointsClose.addEventListener("click", () => hideSheet(sheetPromoPoints));
  }
  if (btnOrders) {
    btnOrders.addEventListener("click", () => openOrders());
  }
  if (btnOrdersShortcut) {
    btnOrdersShortcut.addEventListener("click", () => openOrders());
  }
  if (btnAdmin) {
    btnAdmin.addEventListener("click", () => showSheet(sheetAdmin));
  }
  if (btnAdminClose) {
    btnAdminClose.addEventListener("click", () => hideSheet(sheetAdmin));
  }
  if (btnOrdersClose) {
    btnOrdersClose.addEventListener("click", () => hideSheet(sheetOrders));
  }
  if (btnOrdersRefresh) {
    btnOrdersRefresh.addEventListener("click", () => fetchOrders());
  }
  if (btnOrdersApply) {
    btnOrdersApply.addEventListener("click", () => fetchOrders());
  }
  document.getElementById("btn-up").addEventListener("click", goUpOneLevel);

  adminTabClients.addEventListener("click", () => switchAdminTab("clients"));
  adminTabOffers.addEventListener("click", () => switchAdminTab("offers"));
  adminTabImport.addEventListener("click", () => switchAdminTab("import"));
  if (adminTabPromo) {
    adminTabPromo.addEventListener("click", () => switchAdminTab("promo"));
  }

  btnClientReset.addEventListener("click", () => fillClientForm());
  btnClientSave.addEventListener("click", saveClient);
  clientFilterSelect.addEventListener("change", renderClientsTable);

  discountOfferSelect.addEventListener("change", renderDiscountPreview);
  discountSegmentSelect.addEventListener("change", renderDiscountPreview);

  btnDiscountAdd.addEventListener("click", addDiscountRule);
  btnDiscountRemove.addEventListener("click", removeDiscountRule);
  if (miniOfferToggle) {
    miniOfferToggle.addEventListener("change", () => {
      adminSettings.miniOfferEnabled = miniOfferToggle.checked;
      const productData =
        currentEntityType === "product"
          ? currentEntity
          : priceList.find((p) => p) || null;
      toggleMiniOffer(adminSettings, productData);
    });
  }
  btnPriceListUpload.addEventListener("click", uploadPriceList);
  if (priceListSearchInput) {
    priceListSearchInput.addEventListener("input", (e) => {
      renderPriceListTable(e.target.value);
    });
  }
  if (dailyProductSearchInput) {
    dailyProductSearchInput.addEventListener("input", (e) => {
      refreshDailyProductSelect(e.target.value);
    });
  }
  if (priceListTableWrapper) {
    priceListTableWrapper.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const sku = btn.getAttribute("data-sku");
      if (!action || !sku) return;

      const product = priceList.find((p) => String(p.sku) === String(sku));
      if (!product) {
        showToast("Prodotto non trovato in memoria.");
        return;
      }

      if (action === "edit-product") {
        if (window.TheLightUniverse && typeof window.TheLightUniverse.openProductEditor === "function") {
          window.TheLightUniverse.openProductEditor(product);
        }
        return;
      }

      if (action === "delete-product") {
        const ok = window.confirm(`Eliminare definitivamente il prodotto ${sku}?`);
        if (!ok) return;

        try {
          const token = currentUser?.token;
          const res = await fetch(`${BASE_URL}/admin/products/${encodeURIComponent(sku)}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              ...(token ? { Authorization: `Bearer ${token}` } : {})
            }
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          priceList = priceList.filter((p) => String(p.sku) !== String(sku));
          renderPriceListTable(priceListSearchInput ? priceListSearchInput.value : "");
          showToast("Prodotto eliminato dal listino.");
        } catch (err) {
          console.error("Errore eliminazione prodotto", err);
          showToast("Errore durante l'eliminazione del prodotto.");
        }
      }
    });
  }
  if (btnPromoClientsUpload) {
    btnPromoClientsUpload.addEventListener("click", uploadPromoClients);
  }
  if (btnPromoAddPoints) {
    btnPromoAddPoints.addEventListener("click", addPromoPoints);
  }
  if (btnPromoSaveConfig) {
    btnPromoSaveConfig.addEventListener("click", savePromoConfig);
  }
  if (promoClientSelect) {
    promoClientSelect.addEventListener("change", () => {
      const id = promoClientSelect.value;
      if (id) {
        fetchPromoSummary(id);
      }
    });
  }
  if (btnDailySave) {
    btnDailySave.addEventListener("click", async () => {
      const sku = dailyProductSelect.value;
      if (!sku) {
        showToast("Seleziona un prodotto per l'offerta daily.");
        return;
      }
      const token = currentUser?.token;
      const payload = {
        sku,
        start_at: fromInputDateTimeLocal(dailyStartInput.value),
        end_at: fromInputDateTimeLocal(dailyEndInput.value),
        discount_dist_percent: dailyDiscountDistInput.value ? Number(dailyDiscountDistInput.value) : 0,
        discount_riv_percent: dailyDiscountRivInput.value ? Number(dailyDiscountRivInput.value) : 0,
        discount_riv10_percent: dailyDiscountRiv10Input.value ? Number(dailyDiscountRiv10Input.value) : 0,
        coupon_code: dailyCouponCodeInput.value.trim(),
        active: dailyActiveFlagInput.value === "1"
      };

      try {
        const res = await fetch(BASE_URL + "/admin/daily-offer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {})
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        dailyOffer = json || payload;
        const product = priceList.find((p) => String(p.sku) === String(sku));
        if (product) {
          dailyOffer.product_name = product.name || dailyOffer.product_name;
        }
        fillDailyFormFromOffer();
        showToast("Offerta daily salvata.");
      } catch (err) {
        console.error("Errore salvataggio daily", err);
        showToast("Errore durante il salvataggio dell'offerta daily.");
      }
    });
  }
  if (btnDailyToggle) {
    btnDailyToggle.addEventListener("click", async () => {
      if (!dailyOffer) {
        showToast("Nessuna offerta daily da attivare/disattivare.");
        return;
      }
      const token = currentUser?.token;
      const newActive = !dailyOffer.active;
      try {
        const res = await fetch(BASE_URL + "/admin/daily-offer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {})
          },
          body: JSON.stringify({ ...dailyOffer, active: newActive })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        dailyOffer = json || { ...dailyOffer, active: newActive };
        fillDailyFormFromOffer();
        showToast(newActive ? "Offerta daily attivata." : "Offerta daily disattivata.");
      } catch (err) {
        console.error("Errore toggle daily", err);
        showToast("Errore attivazione/disattivazione offerta daily.");
      }
    });
  }
  if (btnDailyDelete) {
    btnDailyDelete.addEventListener("click", async () => {
      if (!dailyOffer) {
        showToast("Nessuna offerta daily da eliminare.");
        return;
      }
      const ok = window.confirm("Eliminare definitivamente l'offerta daily?");
      if (!ok) return;
      const token = currentUser?.token;
      try {
        const res = await fetch(BASE_URL + "/admin/daily-offer", {
          method: "DELETE",
          headers: {
            ...(token ? { Authorization: `Bearer ${token}` } : {})
          }
        });
        if (!res.ok && res.status !== 404) throw new Error("HTTP " + res.status);
        dailyOffer = null;
        fillDailyFormFromOffer();
        showToast("Offerta daily eliminata.");
      } catch (err) {
        console.error("Errore eliminazione daily", err);
        showToast("Errore durante l'eliminazione dell'offerta daily.");
      }
    });
  }
  if (btnDailyOffer) {
    btnDailyOffer.addEventListener("click", () => {
      openDailyOfferForUser();
    });
  }
  if (btnCopyCoupon && dailyCouponCodeEl) {
    btnCopyCoupon.addEventListener("click", async () => {
      const code = (dailyCouponCodeEl.textContent || "").trim();
      if (!code) {
        showToast("Nessun coupon da copiare.");
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(code);
          showToast("Codice coupon copiato.");
        } else {
          const temp = document.createElement("textarea");
          temp.value = code;
          document.body.appendChild(temp);
          temp.select();
          document.execCommand("copy");
          document.body.removeChild(temp);
          showToast("Codice coupon copiato.");
        }
      } catch (err) {
        console.error("Errore copia coupon", err);
        showToast("Non √® stato possibile copiare il coupon.");
      }
    });
  }
  if (btnGoCart) {
    btnGoCart.addEventListener("click", () => {
      window.open("https://www.ormanet.it/default.asp?cmd=showCart", "_blank");
    });
  }

  function showToast(msg, ok = true) {
    toast.textContent = msg;
    toast.style.background = ok ? "rgba(22,163,74,0.9)" : "rgba(185,28,28,0.9)";
    toast.style.display = "block";
    setTimeout(() => { toast.style.display = "none"; }, 2500);
  }

  function buildAuthHeaders(contentType = "application/json") {
    const headers = {};
    if (contentType) headers["Content-Type"] = contentType;
    if (currentUser.token) headers["Authorization"] = "Bearer " + currentUser.token;
    return headers;
  }

  function saveSessionToStorage(user, token, remember) {
    const payload = {
      name: user.name,
      tier: user.tier,
      token,
      email: user.email || null,
      is_admin: !!user.is_admin,
    };
    const storage = remember ? window.localStorage : window.sessionStorage;
    storage.setItem("thelight24_session", JSON.stringify(payload));
  }

  function clearSessionStorage() {
    window.localStorage.removeItem("thelight24_session");
    window.sessionStorage.removeItem("thelight24_session");
  }

  function restoreSessionFromStorage() {
    const raw = window.localStorage.getItem("thelight24_session") ||
                window.sessionStorage.getItem("thelight24_session");
    if (!raw) return;

    try {
      const sess = JSON.parse(raw);
      if (!sess || !sess.token) return;
      currentUser.logged = true;
      currentUser.name = sess.name || sess.email || "utente";
      currentUser.tier = sess.tier || "rivenditore10";
      currentUser.token = sess.token;
      currentUser.email = sess.email || null;
      currentUser.is_admin = !!sess.is_admin;
      updateUserUI();
    } catch (e) {
      console.error("Errore restoreSessionFromStorage", e);
    }
  }

  async function validateSession() {
    if (!currentUser.logged || !currentUser.token) return;
    try {
      const res = await fetch(BASE_URL + "/auth/me", {
        headers: buildAuthHeaders()
      });
      if (!res.ok) {
        clearSessionStorage();
        currentUser = { logged: false, tier: "ospite", name: null, token: null, email: null };
        updateUserUI();
        return;
      }
      const me = await res.json();
      currentUser.name = me.name || currentUser.name;
      currentUser.tier = me.tier || currentUser.tier;
      currentUser.email = me.email || currentUser.email;
      currentUser.is_admin = !!me.is_admin || !!(me.user && me.user.is_admin);
      updateUserUI();
    } catch (e) {
      console.warn("Impossibile validare la sessione, mantengo lo stato locale", e);
    }
  }

  function logout() {
    currentUser = { logged: false, tier: "ospite", name: null, token: null, email: null, is_admin: false };
    clearSessionStorage();
    updateUserUI();
    showToast("Sei uscito dall'account.");
  }

  function toggleMiniOffer(adminSettings, productData) {
    if (!miniOfferPanel) return;
    miniOfferPanel.innerHTML = "";
    if (!adminSettings.miniOfferEnabled || !productData) return;

    const offerBox = document.createElement("div");
    offerBox.style.display = "flex";
    offerBox.style.alignItems = "center";
    offerBox.style.gap = "8px";
    offerBox.innerHTML = `
      <img src="${productData.image || productData.image_hd || ""}" alt="${productData.name || ""}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;" />
      <div>
        <strong>${productData.name || "Prodotto"}</strong>
        <p style="margin:2px 0;">Prezzo: ‚Ç¨${(productData.price || productData.base_price || 0) - (productData.discount || 0)}</p>
      </div>
    `;
    miniOfferPanel.appendChild(offerBox);
  }

  function switchAdminTab(target) {
    [adminSectionClients, adminSectionOffers, adminSectionImport, adminSectionPromo]
      .forEach((sec) => sec && (sec.style.display = "none"));
    [adminTabClients, adminTabOffers, adminTabImport, adminTabPromo]
      .forEach((btn) => btn && btn.classList.add("secondary"));
    if (target === "clients") {
      adminSectionClients.style.display = "block";
      adminTabClients.classList.remove("secondary");
    } else if (target === "offers") {
      adminSectionOffers.style.display = "block";
      adminTabOffers.classList.remove("secondary");
    } else if (target === "promo") {
      adminSectionPromo.style.display = "block";
      adminTabPromo.classList.remove("secondary");
    } else {
      adminSectionImport.style.display = "block";
      adminTabImport.classList.remove("secondary");
    }
  }

  function renderClientsTable() {
    if (!clientsTable) return;
    clientsTable.innerHTML = "";
    const filter = clientFilterSelect.value;
    const filtered = clients.filter(c => filter === "all" || c.listino === filter);
    filtered.forEach((c) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:2px 4px;">${c.ragione_sociale || c.name || ""}</td>
        <td style="padding:2px 4px;">${c.piva || ""}</td>
        <td style="padding:2px 4px;">${c.email || ""}</td>
        <td style="padding:2px 4px;">${c.listino || ""}</td>
        <td style="padding:2px 4px;">${c.promo_enabled ? `<span class="tag">XMAS ¬∑ ${c.promo_points || 0} pt</span>` : ""}</td>
        <td style="padding:2px 4px; text-align:right;">
          <button class="btn secondary" data-id="${c.id}" data-action="edit" style="font-size:10px;">Modifica</button>
          <button class="btn secondary" data-id="${c.id}" data-action="delete" style="font-size:10px;">Elimina</button>
        </td>`;
      clientsTable.appendChild(tr);
    });
    clientsTable.querySelectorAll("button").forEach((btn) => {
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      btn.addEventListener("click", () => {
        if (action === "edit") {
          const client = clients.find((c) => c.id == id);
          fillClientForm(client);
        } else {
          deleteClient(id);
        }
      });
    });
  }

  function getCurrentClientRecord() {
    if (!currentUser?.email) return null;
    const emailLower = String(currentUser.email).toLowerCase();
    return clients.find((c) => (c.email || "").toLowerCase() === emailLower) || null;
  }

  function refreshPromoClientsSelect() {
    if (!promoClientSelect) return;
    const promoClients = clients.filter((c) => c.promo_enabled);
    if (!promoClients.length) {
      promoClientSelect.innerHTML = '<option value="">Nessun cliente promo</option>';
      if (promoClientPoints) promoClientPoints.value = "";
      if (promoSummaryBox) promoSummaryBox.innerHTML = "";
      return;
    }
    promoClientSelect.innerHTML = promoClients
      .map(
        (c) =>
          `<option value="${c.id}">${c.ragione_sociale || c.email || "Cliente"} (${c.email || "-"}) ‚Äì ${c.promo_points || 0} pt</option>`
      )
      .join("");
    if (promoClientSelect.value) {
      fetchPromoSummary(promoClientSelect.value);
    }
  }

  function refreshDailyProductSelect(filterText = "") {
    if (!dailyProductSelect) return;
    const term = (filterText || "").toLowerCase().trim();

    dailyProductSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Seleziona prodotto...";
    dailyProductSelect.appendChild(placeholder);

    (priceList || []).forEach((p) => {
      const sku = (p.sku || "").toLowerCase();
      const codice = (p.codice || "").toLowerCase();
      const name = (p.name || "").toLowerCase();
      const desc = (p.desc_html || p.description || "").toLowerCase();

      if (term) {
        const match = sku.includes(term) || codice.includes(term) || name.includes(term) || desc.includes(term);
        if (!match) return;
      }

      const opt = document.createElement("option");
      const codeLabel = p.codice ? ` [${p.codice}]` : "";
      opt.value = p.sku;
      opt.textContent = `${p.sku}${codeLabel} ‚Äì ${p.name || ""}`;
      dailyProductSelect.appendChild(opt);
    });

    if (dailyOffer && dailyOffer.sku) {
      dailyProductSelect.value = dailyOffer.sku;
    }
  }

  function toInputDateTimeLocal(value) {
    if (!value) return "";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return "";
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function fromInputDateTimeLocal(value) {
    if (!value) return null;
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return null;
    return d.toISOString();
  }

  function renderDailySummary() {
    if (!dailySummaryBox) return;
    if (!dailyOffer) {
      dailySummaryBox.innerHTML = "<div style=\"font-size:11px;opacity:0.7;\">Nessuna offerta daily configurata.</div>";
      return;
    }
    const activeLabel = dailyOffer.active ? "ATTIVA" : "SPENTA";
    const sku = dailyOffer.sku || "-";
    const name = dailyOffer.product_name || "-";
    const startLabel = dailyOffer.start_at || "-";
    const endLabel = dailyOffer.end_at || "-";
    const coupon = dailyOffer.coupon_code || "-";

    dailySummaryBox.innerHTML = `
    <div style="font-size:11px;">
      <div><strong>Stato:</strong> ${activeLabel}</div>
      <div><strong>Prodotto:</strong> ${sku} ‚Äì ${name}</div>
      <div><strong>Periodo:</strong> ${startLabel} ‚Üí ${endLabel}</div>
      <div><strong>Coupon:</strong> ${coupon}</div>
      <div><strong>Sconti:</strong> Dist ${dailyOffer.discount_dist_percent || 0}% ¬∑ Riv ${dailyOffer.discount_riv_percent || 0}% ¬∑ Riv+10 ${dailyOffer.discount_riv10_percent || 0}%</div>
    </div>
  `;
  }

  function fillDailyFormFromOffer() {
    if (!dailyOffer) {
      if (dailyProductSelect) dailyProductSelect.value = "";
      if (dailyStartInput) dailyStartInput.value = "";
      if (dailyEndInput) dailyEndInput.value = "";
      if (dailyDiscountDistInput) dailyDiscountDistInput.value = "";
      if (dailyDiscountRivInput) dailyDiscountRivInput.value = "";
      if (dailyDiscountRiv10Input) dailyDiscountRiv10Input.value = "";
      if (dailyCouponCodeInput) dailyCouponCodeInput.value = "";
      if (dailyActiveFlagInput) dailyActiveFlagInput.value = "0";
      renderDailySummary();
      return;
    }

    refreshDailyProductSelect(dailyProductSearchInput ? dailyProductSearchInput.value : "");
    if (dailyOffer.sku && dailyProductSelect) dailyProductSelect.value = dailyOffer.sku;
    if (dailyStartInput) dailyStartInput.value = toInputDateTimeLocal(dailyOffer.start_at);
    if (dailyEndInput) dailyEndInput.value = toInputDateTimeLocal(dailyOffer.end_at);
    if (dailyDiscountDistInput)
      dailyDiscountDistInput.value = dailyOffer.discount_dist_percent != null ? dailyOffer.discount_dist_percent : "";
    if (dailyDiscountRivInput)
      dailyDiscountRivInput.value = dailyOffer.discount_riv_percent != null ? dailyOffer.discount_riv_percent : "";
    if (dailyDiscountRiv10Input)
      dailyDiscountRiv10Input.value = dailyOffer.discount_riv10_percent != null ? dailyOffer.discount_riv10_percent : "";
    if (dailyCouponCodeInput) dailyCouponCodeInput.value = dailyOffer.coupon_code || "";
    if (dailyActiveFlagInput) dailyActiveFlagInput.value = dailyOffer.active ? "1" : "0";
    renderDailySummary();
  }

  function setPromoConfig(cfg = {}) {
    promoConfig = {
      start_date: cfg.start_date || null,
      end_date: cfg.end_date || null,
    };
    if (promoStartDateInput) promoStartDateInput.value = promoConfig.start_date || "";
    if (promoEndDateInput) promoEndDateInput.value = promoConfig.end_date || "";
  }

  function renderPromoRulesStatic() {
    if (!promoRulesStatic) return;
    promoRulesStatic.innerHTML = `
      <p><strong>Azioni e punti:</strong></p>
      <ul>
        <li>Seguici sui social ‚Üí 5 punti</li>
        <li>Aggiungi il numero in rubrica per broadcast WhatsApp ‚Üí 50 punti</li>
        <li>Ordine con rigenerati ‚Üí 100 punti</li>
        <li>Raggiungi il fatturato medio mensile ‚Üí 200 punti</li>
        <li>Fattura pi√π del tuo fatturato medio ‚Üí 500 punti</li>
        <li>Porta una nuova azienda alla registrazione ‚Üí 1000 punti</li>
      </ul>
      <p><strong>Soglie:</strong></p>
      <ul>
        <li>350 pt ‚Üí 1 premio</li>
        <li>850 pt ‚Üí 1 o 2 premi</li>
        <li>Massimo punti ‚Üí Biglietto fortunato</li>
      </ul>
      <p><strong>Biglietto fortunato:</strong> spedizione gratuita prime 2 settimane di gennaio, sconto massimo sul fatturato di gennaio, omaggi sui prodotti trattati + sconto minimo per 3 mesi sulla categoria trattata.</p>
    `;
  }

  function getPromoTierLabel(summary) {
    if (!summary) return "base";
    if (summary.tier === "max") return "biglietto fortunato";
    if (summary.tier === "tier2") return "2 premi disponibili";
    if (summary.tier === "tier1") return "1 premio disponibile";
    return "base";
  }

  function buildPromoRightsText(summary = {}) {
    const points = summary.points || 0;
    const maxPoints = summary.max_points;
    const reachedMax =
      (typeof maxPoints === "number" && points >= maxPoints) ||
      summary.tier === "max" ||
      points >= 1000;
    if (reachedMax) {
      return "Hai diritto al biglietto fortunato: spedizione gratuita prime 2 settimane di gennaio, sconto massimo su fatturato di gennaio, omaggi prodotti che tratti + sconto minimo per 3 mesi sulla categoria che tratti.";
    }
    if (points >= 850) {
      return "Hai diritto fino a 2 premi (soglia 850 pt)";
    }
    if (points >= 350) {
      return "Hai diritto a 1 premio (soglia 350 pt)";
    }
    return "Accumula punti: a 350 pt ottieni 1 premio, a 850 pt fino a 2 premi, al massimo punti ricevi il biglietto fortunato.";
  }

  function buildPromoPointsStatus(points = 0, maxPoints = null, tier = null) {
    const normalizedTier = (tier || "").toString().toLowerCase();
    const reachedMax =
      (typeof maxPoints === "number" && points >= maxPoints) ||
      normalizedTier === "max" ||
      normalizedTier.includes("biglietto");
    if (reachedMax) {
      return "Hai diritto al biglietto fortunato: spedizione gratuita prime 2 settimane di gennaio, sconto massimo sul fatturato di gennaio, omaggi, e sconto minimo per 3 mesi sulla categoria che tratti.";
    }
    if (points >= 850) {
      return "Hai diritto fino a 2 premi (soglia 850 punti).";
    }
    if (points >= 350) {
      return "Hai diritto a 1 premio (soglia 350 punti).";
    }
    return "Nessun premio ancora. A 350 punti ottieni 1 premio, a 850 punti fino a 2 premi, con il massimo punti il biglietto fortunato.";
  }

  function getPromoPrizesHtml() {
    return `
      <ul>
        <li>Spedizione gratuita sulle prime due settimane di gennaio</li>
        <li>Sconto massimo sul fatturato di gennaio</li>
        <li>Omaggi di prodotti che tratti</li>
        <li>Biglietto fortunato: tutti i vantaggi (max 3) + sconto minimo per 3 mesi sulla categoria che tratti</li>
      </ul>
    `;
  }

  function renderPromoCardSummary(summary = {}) {
    if (!entityPromoSummary) return;
    const tierLabel = getPromoTierLabel(summary);
    const rightsText = buildPromoRightsText(summary);
    const points = summary.points || 0;
    entityPromoSummary.innerHTML = `
      <div><strong>Punti attuali:</strong> ${points}</div>
      <div><strong>Tier:</strong> ${tierLabel}</div>
      <div>${rightsText}</div>
      <div><strong>Premi potenziali:</strong></div>
      ${getPromoPrizesHtml()}
    `;
  }

  function renderPromoSummary(summary) {
    const safeSummary = summary || {};
    if (promoClientPoints) {
      promoClientPoints.value = safeSummary.points ?? "";
    }
    if (promoSummaryBox) {
      const tierLabel = getPromoTierLabel(safeSummary);
      const prizes = (safeSummary.prizes_available || []).map((p) => `<li>${p}</li>`).join("");
      const rightsText = buildPromoRightsText(safeSummary);
      promoSummaryBox.innerHTML = `
        <div><strong>Punti totali:</strong> ${safeSummary.points || 0}</div>
        <div><strong>Tier:</strong> ${tierLabel}</div>
        <div><strong>Premi disponibili:</strong></div>
        <ul>${prizes || '<li>Nessun premio disponibile</li>'}</ul>
        <div>${rightsText}</div>
        <div><strong>Soglie:</strong> 350 pt ‚Üí 1 premio ‚Ä¢ 850 pt ‚Üí 1 o 2 premi ‚Ä¢ massimo punti ‚Üí biglietto fortunato</div>
      `;
    }
    renderPromoCardSummary(safeSummary);
  }

  async function fetchPromoSummary(clientId) {
    try {
      const res = await fetch(`${BASE_URL}/admin/promo/summary?client_id=${clientId}`, {
        headers: buildAuthHeaders(),
      });
      if (!res.ok) return null;
      const summary = await res.json();
      renderPromoSummary(summary);
      return summary;
    } catch (e) {
      console.error("Errore fetchPromoSummary", e);
      return null;
    }
  }

  async function loadPromoConfig() {
    try {
      const res = await fetch(BASE_URL + "/admin/promo/config", { headers: buildAuthHeaders() });
      if (!res.ok) return;
      const cfg = await res.json();
      setPromoConfig(cfg || {});
    } catch (e) {
      console.warn("Config promo non disponibile", e);
    }
  }

  async function savePromoConfig() {
    const payload = {
      start_date: promoStartDateInput?.value || null,
      end_date: promoEndDateInput?.value || null,
    };
    setPromoConfig(payload);
    try {
      const res = await fetch(BASE_URL + "/admin/promo/config", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Non salvata su backend");
      showToast("Config promo aggiornata");
    } catch (e) {
      console.warn("Salvataggio config promo locale", e);
      showToast("Config promo salvata solo lato frontend", false);
    }
  }

  function fillClientForm(client = null) {
    editingClientId = client ? client.id : null;
    clientNameInput.value = client?.ragione_sociale || client?.name || "";
    clientPivaInput.value = client?.piva || "";
    clientEmailInput.value = client?.email || "";
    clientPhoneInput.value = client?.telefono || client?.phone || "";
    clientListinoInput.value = client?.listino || "distributore";
    clientStatoInput.value = client?.stato || "attivo";
    clientNoteInput.value = client?.note || "";
    if (clientPromoEnabledInput) {
      clientPromoEnabledInput.checked = !!client?.promo_enabled;
    }
    if (clientPromoPointsInput) {
      clientPromoPointsInput.value = client?.promo_points || 0;
    }
    if (clientPromoTicketInput) {
      clientPromoTicketInput.value = client?.promo_ticket_code || "";
    }
  }

  async function saveClient() {
    const client = {
      id: editingClientId || null,
      ragione_sociale: clientNameInput.value,
      piva: clientPivaInput.value,
      email: clientEmailInput.value,
      telefono: clientPhoneInput.value,
      listino: clientListinoInput.value,
      stato: clientStatoInput.value,
      note: clientNoteInput.value,
      promo_enabled: clientPromoEnabledInput?.checked ? 1 : 0,
      promo_points: parseInt(clientPromoPointsInput?.value || "0", 10) || 0,
      promo_ticket_code: clientPromoTicketInput?.value || null,
    };
    const existingIdx = client.id ? clients.findIndex((c) => c.id === client.id) : -1;
    try {
      await fetch(BASE_URL + "/admin/clients/save", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(client),
      });
      const refreshed = await fetch(BASE_URL + "/admin/clients/all", { headers: buildAuthHeaders() });
      const data = await refreshed.json();
      clients = data.clients || [];
      renderClientsTable();
      refreshPromoClientsSelect();
      showToast("Cliente salvato");
    } catch (e) {
      if (existingIdx >= 0) clients[existingIdx] = client; else clients.push(client);
      renderClientsTable();
      refreshPromoClientsSelect();
      showToast("Cliente salvato in locale", false);
    }
    fillClientForm();
  }

  async function deleteClient(id) {
    clients = clients.filter((c) => c.id != id);
    renderClientsTable();
    try {
      await fetch(BASE_URL + "/admin/clients/delete", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify({ id }),
      });
      const refreshed = await fetch(BASE_URL + "/admin/clients/all", { headers: buildAuthHeaders() });
      const data = await refreshed.json();
      clients = data.clients || [];
      renderClientsTable();
      refreshPromoClientsSelect();
    } catch (e) {
      showToast("Cliente eliminato solo in locale", false);
    }
  }

  function renderDiscountPreview() {
    if (!discountPreview) return;
    const header = `
      <thead>
        <tr>
          <th style="text-align:left;padding:2px 4px;">ID offerta</th>
          <th style="text-align:left;padding:2px 4px;">Titolo</th>
          <th style="text-align:left;padding:2px 4px;">Segmento</th>
          <th style="text-align:left;padding:2px 4px;">Range</th>
          <th style="text-align:left;padding:2px 4px;">%</th>
          <th style="text-align:left;padding:2px 4px;">Validit√†</th>
        </tr>
      </thead>`;
    const bodyRows = discountConfigs.map((cfg) => {
      const segments = Object.entries(cfg.rules || {});
      if (!segments.length) {
        return `<tr>
          <td style="padding:2px 4px;">${cfg.id}</td>
          <td style="padding:2px 4px;">${findOfferTitle(cfg.id)}</td>
          <td colspan="4" style="padding:2px 4px;">Nessuna regola configurata</td>
        </tr>`;
      }
      return segments.map(([segment, rules]) => {
        if (!rules.length) {
          return `<tr>
            <td style="padding:2px 4px;">${cfg.id}</td>
            <td style="padding:2px 4px;">${findOfferTitle(cfg.id)}</td>
            <td style="padding:2px 4px;">${segment}</td>
            <td colspan="3" style="padding:2px 4px;">Nessuna fascia</td>
          </tr>`;
        }
        return rules.map((r) => {
          const maxLabel = !isFinite(r.max) || r.max === null ? "‚àû" : r.max;
          return `<tr>
            <td style="padding:2px 4px;">${cfg.id}</td>
            <td style="padding:2px 4px;">${findOfferTitle(cfg.id)}</td>
            <td style="padding:2px 4px;">${segment}</td>
            <td style="padding:2px 4px;">${r.min} ‚Äì ${maxLabel}</td>
            <td style="padding:2px 4px;">${r.discount}%</td>
            <td style="padding:2px 4px;">${formatDateLabel(r.valid_until)}</td>
          </tr>`;
        }).join("");
      }).join("");
    }).join("");

    discountPreview.innerHTML = discountConfigs.length
      ? `<table style="width:100%; border-collapse:collapse; font-size:11px;">${header}<tbody>${bodyRows}</tbody></table>`
      : "";
  }

  function ensureDiscountSelectFilled() {
    if (!discountOfferSelect) return;
    const opts = [];
    const known = new Set();
    offersUniverse.forEach((o) => {
      known.add(o.id);
      opts.push(`<option value="${o.id}">${o.title || o.name}</option>`);
    });
    discountConfigs.forEach((cfg) => {
      if (!known.has(cfg.id)) {
        opts.push(`<option value="${cfg.id}">${cfg.id}</option>`);
      }
    });
    discountOfferSelect.innerHTML = opts.join("");
  }

  async function addDiscountRule() {
    const offerId = discountOfferSelect.value;
    const segment = discountSegmentSelect.value;
    const min = parseFloat(discountMinInput.value || "0");
    const max = parseFloat(discountMaxInput.value || "0");
    const percent = parseFloat(discountPercentInput.value || "0");
    const valid = discountValidInput.value || "";
    let cfg = discountConfigs.find((c) => c.id === offerId);
    if (!cfg) {
      cfg = { id: offerId, rules: { distributore: [], rivenditore: [], rivenditore10: [] } };
      discountConfigs.push(cfg);
    }
    const list = cfg.rules[segment] || [];
    const maxValue = isFinite(max) ? max : null;
    const existingIdx = list.findIndex((r) => r.min === min && (r.max === maxValue || (!isFinite(r.max) && maxValue === null)));
    const rule = { min, max: maxValue === null ? Infinity : maxValue, discount: percent, valid_until: valid };
    if (existingIdx >= 0) list[existingIdx] = rule; else list.push(rule);
    cfg.rules[segment] = list;
    renderDiscountPreview();
    try {
      const payload = JSON.parse(JSON.stringify(cfg, (k, v) => (v === Infinity ? null : v)));
      await fetch(BASE_URL + "/admin/offers/save", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(payload),
      });
    } catch (e) {
      showToast("Configurazione salvata localmente", false);
    }
  }

  function removeDiscountRule() {
    const offerId = discountOfferSelect.value;
    const segment = discountSegmentSelect.value;
    let cfg = discountConfigs.find((c) => c.id === offerId);
    if (!cfg) return;
    cfg.rules[segment] = [];
    renderDiscountPreview();
  }

  function renderPriceListTable(filterText = "") {
    if (!priceListTableWrapper) return;
    const term = (filterText || "").toLowerCase().trim();

    const filtered = priceList.filter((p) => {
      const sku = (p.sku || "").toLowerCase();
      const codice = (p.codice || "").toLowerCase();
      const name = (p.name || "").toLowerCase();
      const desc = (p.desc_html || p.description || "").toLowerCase();
      if (!term) return true;
      return sku.includes(term) || codice.includes(term) || name.includes(term) || desc.includes(term);
    });

    if (!filtered.length) {
      priceListTableWrapper.innerHTML = "<div style=\"font-size:11px;opacity:0.7;\">Nessun prodotto trovato.</div>";
      return;
    }

    const rows = filtered
      .map((p) => {
        const sku = p.sku || "";
        const codice = p.codice || "";
        const name = p.name || "";
        const base = typeof p.base_price === "number" ? p.base_price : p.base_price || "";
        const dist = typeof p.price_distributore === "number" ? p.price_distributore : p.price_distributore || p.price_dist || "";
        const riv = typeof p.price_rivenditore === "number" ? p.price_rivenditore : p.price_rivenditore || p.price_riv || "";
        const riv10 = typeof p.price_rivenditore10 === "number" ? p.price_rivenditore10 : p.price_rivenditore10 || p.price_riv10 || "";

        return `
      <tr data-sku="${sku}">
        <td>${sku}</td>
        <td>${codice}</td>
        <td>${name}</td>
        <td style="text-align:right;">${base}</td>
        <td style="text-align:right;">${dist}</td>
        <td style="text-align:right;">${riv}</td>
        <td style="text-align:right;">${riv10}</td>
        <td style="text-align:right;">
          <button class="btn" data-action="edit-product" data-sku="${sku}" style="font-size:10px;padding:2px 6px;">Modifica</button>
          <button class="btn secondary" data-action="delete-product" data-sku="${sku}" style="font-size:10px;padding:2px 6px;margin-left:4px;">Elimina</button>
        </td>
      </tr>
    `;
      })
      .join("");

    priceListTableWrapper.innerHTML = `
    <table style="width:100%; border-collapse:collapse; font-size:11px;">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Codice</th>
          <th>Nome</th>
          <th>Base</th>
          <th>Dist.</th>
          <th>Riv.</th>
          <th>Riv+10</th>
          <th style="text-align:right;">Azioni</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
  }

  async function uploadPriceList() {
    const file = priceListFileInput.files[0];
    if (!file) {
      showToast("Seleziona un file .xlsx", false);
      return;
    }
    const name = file.name.toLowerCase();
    if (!name.endsWith(".xlsx")) {
      showToast("Carica un file Excel in formato .xlsx (non .xls)", false);
      return;
    }
    const fd = new FormData();
    fd.append("file", file);
    try {
      const data = await importPriceList(fd);
      if (data) {
        if (Array.isArray(data.products)) priceList = data.products;
        else if (Array.isArray(data.items)) priceList = data.items;
        else if (Array.isArray(data)) priceList = data;
      }
      renderPriceListTable(priceListSearchInput ? priceListSearchInput.value : "");
      refreshDailyProductSelect(dailyProductSearchInput ? dailyProductSearchInput.value : "");
      showToast("Listino importato correttamente.");
    } catch (e) {
      try {
        const refreshed = await fetch(BASE_URL + "/admin/products/all", { headers: buildAuthHeaders() });
        const resJson = await refreshed.json();
        if (Array.isArray(resJson.products)) priceList = resJson.products;
        else if (Array.isArray(resJson.items)) priceList = resJson.items;
        else if (Array.isArray(resJson)) priceList = resJson;
      } catch (err) {
        console.error("Errore refresh listino", err);
      }
      renderPriceListTable(priceListSearchInput ? priceListSearchInput.value : "");
      refreshDailyProductSelect(dailyProductSearchInput ? dailyProductSearchInput.value : "");
      showToast("Listino caricato localmente");
    }
  }

  async function uploadPromoClients() {
    if (!promoClientsFileInput || !promoClientsFileInput.files.length) {
      showToast("Seleziona un file .xlsx per importare", false);
      return;
    }
    const file = promoClientsFileInput.files[0];
    const name = file.name.toLowerCase();
    if (!name.endsWith(".xlsx")) {
      showToast("Carica un file Excel in formato .xlsx (non .xls)", false);
      return;
    }
    const formData = new FormData();
    formData.append("file", file);
    try {
      const res = await fetch(BASE_URL + "/admin/clients/import_promo", {
        method: "POST",
        headers: buildAuthHeaders(null),
        body: formData,
      });
      const json = await res.json();
      if (promoClientsPreview) {
        const newCount = json.imported || 0;
        const updatedCount = json.updated || 0;
        const total = newCount + updatedCount;
        promoClientsPreview.textContent = `Clienti promo importati: ${total} (nuovi: ${newCount}, aggiornati: ${updatedCount})`;
      }
      const refreshed = await fetch(BASE_URL + "/admin/clients/all", { headers: buildAuthHeaders() });
      const data = await refreshed.json();
      clients = data.clients || [];
      renderClientsTable();
      refreshPromoClientsSelect();
      showToast("Import promo completato");
    } catch (e) {
      console.error("Errore uploadPromoClients", e);
      showToast("Import promo non riuscito", false);
    }
  }

  async function addPromoPoints() {
    const clientId = promoClientSelect?.value;
    const actionCode = promoActionSelect?.value;
    if (!clientId || !actionCode) {
      showToast("Seleziona cliente e azione promo", false);
      return;
    }
    try {
      const res = await fetch(BASE_URL + "/admin/promo/add_points", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify({ client_id: Number(clientId), action_code: actionCode }),
      });
      const json = await res.json();
      if (json.status !== "ok") {
        showToast("Errore aggiunta punti", false);
        return;
      }
      const idx = clients.findIndex((c) => String(c.id) === String(clientId));
      if (idx >= 0) {
        clients[idx] = { ...clients[idx], ...json.client };
      }
      refreshPromoClientsSelect();
      renderPromoSummary(json.summary || {});
      showToast("Punti promo aggiornati");
    } catch (e) {
      console.error("Errore addPromoPoints", e);
      showToast("Impossibile aggiornare i punti", false);
    }
  }

  async function importPriceList(formData) {
    const response = await fetch(BASE_URL + "/admin/price_list/import", {
      method: "POST",
      headers: buildAuthHeaders(null),
      body: formData,
    });
    const data = await response.json();
    console.log("Price list imported successfully:", data);
    return data;
  }

  function getProductByID(productID) {
    const inPriceList = priceList.find((p) => String(p.id) === String(productID) || String(p.sku) === String(productID));
    if (inPriceList) return inPriceList;

    for (const system of offersUniverse) {
      for (const category of system.categories || []) {
        for (const sub of category.subcategories || []) {
          const found = (sub.products || []).find(
            (p) => String(p.id) === String(productID)
          );
          if (found) return found;
        }
      }
    }
    return null;
  }

  function applyDiscountToProduct(productID, discount, listino) {
    const product = getProductByID(productID);
    if (!product) return;

    product.listino = listino;
    product.discount = discount;
    updateProductDisplay(product);
  }

  function updateProductDisplay(product) {
    const priceContainer = document.querySelector(
      `#product-${product.id} .price`
    );
    const basePrice = Number(product.price || product.base_price || 0);
    const discountValue = Number(product.discount || 0);
    const finalPrice = Math.max(0, basePrice - discountValue);
    if (priceContainer) {
      priceContainer.textContent = `‚Ç¨${finalPrice.toFixed(2)}`;
    }
  }

  function hideDailyCouponBox() {
    if (dailyCouponBox) {
      dailyCouponBox.style.display = "none";
    }
  }

  function showDailyCouponBox() {
    if (dailyCouponBox) {
      dailyCouponBox.style.display = "block";
    }
  }

  async function openDailyOfferForUser() {
    try {
      const res = await fetch(BASE_URL + "/offer/daily");
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data.active) {
        hideDailyCouponBox();
        showToast("Nessuna offerta daily attiva al momento.");
        return;
      }

      const code = data.coupon_code || "";
      const name = data.product_name || data.sku || "";
      const start = data.start_at || null;
      const end = data.end_at || null;

      if (dailyCouponCodeEl) dailyCouponCodeEl.textContent = code;
      if (dailyCouponProductEl) dailyCouponProductEl.textContent = name ? `Prodotto: ${name}` : "";
      if (dailyCouponValidityEl) {
        if (start || end) {
          dailyCouponValidityEl.textContent = `Valida oggi, entro i limiti di orario impostati per l'offerta.`;
        } else {
          dailyCouponValidityEl.textContent = "";
        }
      }

      showDailyCouponBox();
    } catch (err) {
      console.error("Errore lettura offerta daily", err);
      hideDailyCouponBox();
      showToast("Errore nel recupero dell'offerta daily.");
    }
  }

  function renderStars(rating) {
    if (!rating) return "";
    const full = Math.floor(rating);
    const half = rating - full >= 0.25 && rating - full < 0.75 ? 1 : 0;
    const empty = 5 - full - half;
    return "‚òÖ".repeat(full) + (half ? "‚òÜ" : "") + "‚ú©".repeat(empty);
  }

  async function submitRegistration() {
    const payload = {
      type: document.getElementById("reg-type").value,
      name: document.getElementById("reg-name").value,
      piva: document.getElementById("reg-piva").value,
      sdi: document.getElementById("reg-sdi").value,
      regime: document.getElementById("reg-regime").value,
      address: document.getElementById("reg-address").value,
      email: document.getElementById("reg-email").value,
      phone: document.getElementById("reg-phone").value,
      source: document.getElementById("reg-source").value,
      visura: document.getElementById("reg-visura").value,
      payment_pref: document.getElementById("reg-payment").value,
      accept_terms: document.getElementById("reg-terms").checked,
    };

    if (!payload.email || !payload.accept_terms) {
      showToast("Compila email e accetta i termini.", false);
      return;
    }

    try {
      const res = await fetch(BASE_URL + "/auth/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      if (json.status === "ok") {
        currentUser.logged = true;
        currentUser.name = payload.name || payload.email;
        currentUser.tier = json.tier || "rivenditore10";
        currentUser.email = payload.email;
        updateUserUI();
        hideSheet(sheetRegister);
        showToast("Registrazione inviata. Listino assegnato dopo verifica.");
      } else {
        showToast("Errore registrazione.", false);
      }
    } catch (e) {
      showToast("Backend non raggiungibile.", false);
    }
  }

  if (btnPwdResetCancel) {
    btnPwdResetCancel.addEventListener("click", () => {
      hideSheet(sheetPasswordReset);
      pwdCurrentInput.value = "";
      pwdNewInput.value = "";
      pwdNewConfirmInput.value = "";
    });
  }

  async function submitPasswordReset() {
    const current = (pwdCurrentInput.value || "").trim();
    const next = (pwdNewInput.value || "").trim();
    const next2 = (pwdNewConfirmInput.value || "").trim();

    if (!current || !next || !next2) {
      showToast("Compila tutti i campi.", false);
      return;
    }
    if (next.length < 8) {
      showToast("La nuova password deve avere almeno 8 caratteri.", false);
      return;
    }
    if (next !== next2) {
      showToast("Le nuove password non coincidono.", false);
      return;
    }
    if (!currentUser.logged) {
      showToast("Devi essere loggato per cambiare password.", false);
      return;
    }

    try {
      const res = await fetch(BASE_URL + "/auth/change_password", {
        method: "POST",
        headers: buildAuthHeaders("application/json"),
        body: JSON.stringify({
          current_password: current,
          new_password: next
        })
      });
      const json = await res.json();
      if (!res.ok || json.status !== "ok") {
        showToast(json.message || "Errore nel cambio password.", false);
        return;
      }
      showToast("Password aggiornata con successo.");
      pwdCurrentInput.value = "";
      pwdNewInput.value = "";
      pwdNewConfirmInput.value = "";
      hideSheet(sheetPasswordReset);
    } catch (e) {
      console.error("Errore change_password", e);
      showToast("Backend non raggiungibile.", false);
    }
  }

  async function submitLogin() {
    const payload = {
      email: document.getElementById("login-email").value,
      password: document.getElementById("login-password").value,
      remember: document.getElementById("login-remember").checked
    };
    const remember = payload.remember;
    if (!payload.email || !payload.password) {
      showToast("Email e password obbligatorie.", false);
      return;
    }

    const ADMIN_EMAIL = "god@local";
    const ADMIN_PASS = "OrmaNet!2025$Light";
    if (payload.email === ADMIN_EMAIL && payload.password === ADMIN_PASS) {
      currentUser.logged = true;
      currentUser.name = "GOD ADMIN";
      currentUser.tier = "distributore";
      currentUser.token = null;
      currentUser.email = payload.email;
      currentUser.is_admin = true;
      updateUserUI();
      hideSheet(sheetLogin);
      showToast("Modalit√† admin attiva");
      saveSessionToStorage(
        { name: currentUser.name, tier: currentUser.tier, email: payload.email, is_admin: true },
        null,
        remember
      );
      return;
    }

    try {
      const res = await fetch(BASE_URL + "/auth/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      if (json.status === "ok") {
        currentUser.logged = true;
        currentUser.name = json.name || payload.email;
        currentUser.tier = json.tier || "rivenditore10";
        currentUser.token = json.token || null;
        currentUser.email = payload.email;
        currentUser.is_admin = !!json.is_admin;
        updateUserUI();
        hideSheet(sheetLogin);
        showToast("Bentornato, " + currentUser.name);

        saveSessionToStorage(
          { name: currentUser.name, tier: currentUser.tier, email: payload.email, is_admin: currentUser.is_admin },
          currentUser.token,
          remember
        );
      } else {
        showToast("Credenziali errate.", false);
      }
    } catch (e) {
      showToast("Backend non raggiungibile.", false);
    }
  }

  document.getElementById("btn-reg-submit").addEventListener("click", submitRegistration);
  document.getElementById("btn-login-submit").addEventListener("click", submitLogin);
  if (btnPwdResetSubmit) {
    btnPwdResetSubmit.addEventListener("click", submitPasswordReset);
  }

  function badgeForStatus(status) {
    const value = (status || "").toString();
    const normalized = value.toLowerCase();
    let cls = "badge-neutral";
    if (normalized === "evaso") cls = "badge-success";
    else if (normalized === "da evadere") cls = "badge-danger";
    const el = document.createElement("span");
    el.className = `badge ${cls}`;
    el.textContent = value || "‚Äî";
    return el;
  }

  function badgeForCause(cause) {
    const value = (cause || "").toString();
    const normalized = value.toLowerCase();
    let cls = "badge-neutral";
    if (normalized === "richiesta in elaborazione") cls = "badge-danger";
    else if (normalized === "disponibile") cls = "badge-success";
    else if (normalized === "in arrivo") cls = "badge-purple";
    const el = document.createElement("span");
    el.className = `badge ${cls}`;
    el.textContent = value || "‚Äî";
    return el;
  }

  function formatOrderDate(v) {
    if (!v) return "‚Äî";
    try {
      return new Intl.DateTimeFormat("it-IT", { dateStyle: "medium" }).format(new Date(v));
    } catch (e) {
      return v;
    }
  }

  function renderOrders(orders) {
    ordersTableBody.innerHTML = "";
    ordersCards.innerHTML = "";

    if (!orders || !orders.length) {
      ordersEmpty.style.display = "block";
      return;
    }

    ordersEmpty.style.display = "none";

    orders.forEach(order => {
      const hasTotalAmount = order.total_amount != null;
      const totalAmount = hasTotalAmount ? normalizeOrderAmount(order.total_amount) : null;

      const tr = document.createElement("tr");
      const tdDate = document.createElement("td");
      tdDate.textContent = formatOrderDate(order.order_date);
      const tdDoc = document.createElement("td");
      tdDoc.textContent = order.document_number || "‚Äî";
      const tdStatus = document.createElement("td");
      tdStatus.appendChild(badgeForStatus(order.status));
      const tdCause = document.createElement("td");
      tdCause.appendChild(badgeForCause(order.cause));
      const tdName = document.createElement("td");
      tdName.textContent = order.customer_name || "‚Äî";
      const tdEmail = document.createElement("td");
      tdEmail.textContent = order.customer_email || "‚Äî";
      const tdTotal = document.createElement("td");
      tdTotal.textContent = hasTotalAmount ? formatEuro(totalAmount) : "‚Äî";

      tr.append(tdDate, tdDoc, tdStatus, tdCause, tdName, tdEmail, tdTotal);
      ordersTableBody.appendChild(tr);

      const card = document.createElement("div");
      card.className = "order-card";

      const header = document.createElement("div");
      header.className = "order-card-header";
      header.innerHTML = `<span>${order.document_number || "‚Äî"}</span><span class="order-card-meta">${formatOrderDate(order.order_date)}</span>`;
      const badgesRow = document.createElement("div");
      badgesRow.className = "order-card-row";
      badgesRow.appendChild(badgeForStatus(order.status));
      badgesRow.appendChild(badgeForCause(order.cause));

      const meta = document.createElement("div");
      meta.className = "order-card-row order-card-meta";
      meta.innerHTML = `<strong>${order.customer_name || "‚Äî"}</strong> ‚Ä¢ ${order.customer_email || "‚Äî"}`;

      const totalRow = document.createElement("div");
      totalRow.className = "order-card-row";
      totalRow.innerHTML = `<strong>Totale:</strong> ${hasTotalAmount ? formatEuro(totalAmount) : "‚Äî"}`;

      card.append(header, badgesRow, meta, totalRow);
      ordersCards.appendChild(card);
    });
  }

  function openOrders() {
    if (!currentUser.logged) {
      showToast("Fai login per consultare i tuoi ordini.", false);
      showSheet(sheetLogin);
      return;
    }
    showSheet(sheetOrders);
    fetchOrders();
  }

  async function fetchOrders() {
    if (!currentUser.logged) {
      showToast("Fai login per consultare i tuoi ordini.", false);
      return;
    }

    const params = [];
    if (ordersStatusFilter && ordersStatusFilter.value) {
      params.push(`status=${encodeURIComponent(ordersStatusFilter.value)}`);
    }
    if (ordersCauseFilter && ordersCauseFilter.value) {
      params.push(`cause=${encodeURIComponent(ordersCauseFilter.value)}`);
    }
    if (ordersDateFrom && ordersDateFrom.value) {
      params.push(`date_from=${encodeURIComponent(ordersDateFrom.value)}`);
    }
    if (ordersDateTo && ordersDateTo.value) {
      params.push(`date_to=${encodeURIComponent(ordersDateTo.value)}`);
    }

    const qs = params.length ? `?${params.join("&")}` : "";

    try {
      const res = await fetch(BASE_URL + "/account/orders" + qs, {
        headers: buildAuthHeaders(),
      });
      if (!res.ok) {
        showToast("Errore nel caricamento ordini.", false);
        return;
      }
      const data = await res.json();
      renderOrders(data.orders || []);
    } catch (e) {
      console.error("Errore fetch ordini", e);
      showToast("Backend non raggiungibile.", false);
    }
  }

  function updateUserUI() {
    tierLabel.textContent = currentUser.tier;
    if (currentUser.logged) {
      document.getElementById("btn-login").textContent = "Account";
      document.getElementById("btn-logout").style.display = "inline-flex";
      document.getElementById("btn-register").style.display = "none";
      if ((currentUser.is_admin || currentUser.name === "GOD ADMIN") && btnAdmin) {
        btnAdmin.style.display = "inline-flex";
      } else if (btnAdmin) {
        btnAdmin.style.display = "none";
      }
    } else {
      document.getElementById("btn-login").textContent = "Login";
      document.getElementById("btn-logout").style.display = "none";
      document.getElementById("btn-register").style.display = "inline-flex";
      if (btnAdmin) btnAdmin.style.display = "none";
    }
  }

  // === EDITOR PRODOTTO ===
  function parseNumber(input) {
    if (!input) return 0;
    const v = parseFloat((input.value || "").replace(",", "."));
    return isFinite(v) ? v : 0;
  }

  function formatPrice(v) {
    if (!isFinite(v)) return "";
    return v.toFixed(2) + " ‚Ç¨";
  }

  function normalizeOrderAmount(raw) {
    if (raw == null) return 0;

    let value = raw;

    if (typeof value === "string") {
      value = value.replace(",", ".");
    }

    let n = Number(value);
    if (!isFinite(n) || isNaN(n)) return 0;

    if (Number.isInteger(n) && n >= 1000) {
      n = n / 100;
    }

    return n;
  }

  const euroFormatter = new Intl.NumberFormat("it-IT", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 2,
  });

  function formatEuro(v) {
    if (!isFinite(v)) return "";
    return euroFormatter.format(v);
  }

  function updatePreview() {
    const html = descHtmlInput.value || "";
    descPreview.innerHTML = html;
  }

  function recalcPrices() {
    const base = parseNumber(basePriceInput);
    const mRiv10 = parseNumber(markupRiv10Input);
    const mRiv = parseNumber(markupRivInput);
    const mDist = parseNumber(markupDistInput);

    const pRiv10 = base * (1 + mRiv10 / 100);
    const pRiv = base * (1 + mRiv / 100);
    const pDist = base * (1 + mDist / 100);

    priceRiv10Output.value = base ? formatPrice(pRiv10) : "";
    priceRivOutput.value = base ? formatPrice(pRiv) : "";
    priceDistOutput.value = base ? formatPrice(pDist) : "";
  }

  function openProductEditor(product) {
    const prod = product || currentEntity;
    if (!prod || (currentEntityType !== "product" && !product)) {
      showToast("Seleziona un prodotto nella galassia.", false);
      return;
    }

    editingProduct = prod;

    skuInput.value = prod.sku || "";
    codeInput.value = prod.codice || "";
    nameInput.value = prod.name || "";
    imageHdInput.value = prod.image_hd || prod.image_url || prod.image || "";
    imageThumbInput.value = prod.image_thumb || "";
    galleryInput.value = (prod.gallery || []).join("\n");
    descHtmlInput.value = prod.desc_html || prod.description_html || "";
    descPreview.innerHTML = prod.desc_html || prod.description_html || "";

    basePriceInput.value = prod.base_price != null ? prod.base_price : "";
    unitInput.value = prod.unit || "";
    markupRiv10Input.value = prod.markup_riv10 != null ? prod.markup_riv10 : "";
    markupRivInput.value = prod.markup_riv != null ? prod.markup_riv : "";
    markupDistInput.value = prod.markup_dist != null ? prod.markup_dist : "";

    priceRiv10Output.value = prod.price_rivenditore10 != null ? prod.price_rivenditore10 : prod.price_riv10 || "";
    priceRivOutput.value = prod.price_rivenditore != null ? prod.price_rivenditore : prod.price_riv || "";
    priceDistOutput.value = prod.price_distributore != null ? prod.price_distributore : prod.price_dist || "";

    priceDistFinalInput.value = prod.price_distributore != null ? prod.price_distributore : prod.price_dist || "";
    priceRivFinalInput.value = prod.price_rivenditore != null ? prod.price_rivenditore : prod.price_riv || "";
    priceRiv10FinalInput.value = prod.price_rivenditore10 != null ? prod.price_rivenditore10 : prod.price_riv10 || "";
    stockQtyInput.value = prod.qty_stock != null ? prod.qty_stock : "";
    discountDistInput.value = prod.discount_dist_percent != null ? prod.discount_dist_percent : "";
    discountRivInput.value = prod.discount_riv_percent != null ? prod.discount_riv_percent : "";
    discountRiv10Input.value = prod.discount_riv10_percent != null ? prod.discount_riv10_percent : "";
    statusInput.value = prod.status || "attivo";

    recalcPrices();
    showSheet(sheetProduct);
  }

  function closeProductEditor() {
    sheetProduct.style.display = "none";
    editingProduct = null;
  }

  async function saveProduct() {
    if (!editingProduct) return;

    const payload = {
      sku: skuInput.value.trim(),
      codice: codeInput.value.trim() || null,
      name: nameInput.value.trim(),
      image_hd: imageHdInput.value.trim(),
      image_thumb: imageThumbInput.value.trim(),
      gallery: galleryInput.value.split("\n").map(x => x.trim()).filter(Boolean),
      desc_html: descHtmlInput.value,

      base_price: basePriceInput.value ? Number(basePriceInput.value) : null,
      unit: unitInput.value.trim(),
      markup_riv10: markupRiv10Input.value ? Number(markupRiv10Input.value) : null,
      markup_riv: markupRivInput.value ? Number(markupRivInput.value) : null,
      markup_dist: markupDistInput.value ? Number(markupDistInput.value) : null,

      price_distributore: priceDistFinalInput.value ? Number(priceDistFinalInput.value) : null,
      price_rivenditore: priceRivFinalInput.value ? Number(priceRivFinalInput.value) : null,
      price_rivenditore10: priceRiv10FinalInput.value ? Number(priceRiv10FinalInput.value) : null,

      qty_stock: stockQtyInput.value ? Number(stockQtyInput.value) : 0,
      discount_dist_percent: discountDistInput.value ? Number(discountDistInput.value) : 0,
      discount_riv_percent: discountRivInput.value ? Number(discountRivInput.value) : 0,
      discount_riv10_percent: discountRiv10Input.value ? Number(discountRiv10Input.value) : 0,
      status: statusInput.value || "attivo"
    };

    try {
      const res = await fetch(BASE_URL + "/admin/products/save", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const saved = await res.json();
      const idx = priceList.findIndex((p) => String(p.sku) === String(payload.sku));
      if (idx >= 0) {
        priceList[idx] = saved;
      } else {
        priceList.push(saved);
      }
      renderPriceListTable(priceListSearchInput ? priceListSearchInput.value : "");
      showToast("Scheda prodotto aggiornata.");
    } catch (e) {
      console.error("Errore salvataggio prodotto", e);
      showToast("Scheda aggiornata in locale. Backend non raggiungibile.", false);
    }

    closeProductEditor();
  }

  if (btnEditProduct) {
    btnEditProduct.addEventListener("click", openProductEditor);
  }
  if (btnProdCancel) {
    btnProdCancel.addEventListener("click", closeProductEditor);
  }
  if (btnProdSave) {
    btnProdSave.addEventListener("click", saveProduct);
  }
  descHtmlInput.addEventListener("input", updatePreview);
  [basePriceInput, markupRiv10Input, markupRivInput, markupDistInput].forEach(
    (el) => el && el.addEventListener("input", recalcPrices)
  );

  // === UNIVERSE DATA MODEL (FAKE PER ORA) ===
  const universe = {
    name: "TheLight24 Galaxy",
    systems: offersUniverse,
  };

  // === THREE.JS SCENE ===
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xff7b00);

  const textureLoader = new THREE.TextureLoader();

  function createIconSprite(texturePath, size = 1.5) {
    const tex = textureLoader.load(texturePath);
    const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
    const sprite = new THREE.Sprite(mat);
    sprite.scale.set(size, size, 1);
    return sprite;
  }
  const snowflakesTexture = textureLoader.load("/assets/textures/snowflakes.png");

  const floatingTags = new Map();
  const snowflakes = [];
  let snowflakeGroup = null;
  let nataleNode = null;

  function clearFloatingTags() {
    floatingTags.forEach((el) => el.remove());
    floatingTags.clear();
  }

  function createFloatingTagForObject(mesh, text, opts = {}) {
    if (floatingTags.has(mesh)) {
      const prev = floatingTags.get(mesh);
      prev?.remove();
      floatingTags.delete(mesh);
    }
    const el = document.createElement("div");
    el.className = "floating-tag";
    const label = document.createElement("span");
    label.textContent = text;
    el.appendChild(label);
    if (opts.badge) {
      const badge = document.createElement("span");
      badge.className = "floating-badge" + (opts.badgeState ? ` ${opts.badgeState}` : "");
      badge.textContent = opts.badge;
      el.appendChild(badge);
    }
    (appEl || document.body).appendChild(el);
    floatingTags.set(mesh, el);
    return el;
  }

  function resolveSubcategoryTagLabel(sub) {
    if (!sub) return "Bundle";
    return sub.name || "Bundle";
  }

  function addSnowflakes() {
    if (snowflakeGroup) return;
    const snowflakeMaterial = new THREE.SpriteMaterial({
      map: snowflakesTexture,
      color: 0xffffff,
      opacity: 0.6,
    });

    snowflakeGroup = new THREE.Group();
    snowflakeGroup.userData.persistent = true;

    const snowflakeCount = 80;
    for (let i = 0; i < snowflakeCount; i++) {
      const snowflake = new THREE.Sprite(snowflakeMaterial);
      snowflake.position.set(
        Math.random() * 40 - 20,
        Math.random() * 40 - 20,
        Math.random() * 40 - 20
      );
      const scale = 0.4 + Math.random() * 0.8;
      snowflake.scale.setScalar(scale);
      snowflake.userData.velocity = 0.01 + Math.random() * 0.02;
      snowflakes.push(snowflake);
      snowflakeGroup.add(snowflake);
    }

    scene.add(snowflakeGroup);
  }

  function addNataleIcon() {
    if (!nataleNode) {
      const size = 1.5;
      const icon = createIconSprite(PROMO_TEXTURES.natale, size);

      const glowMap = textureLoader.load(
        PROMO_TEXTURES.natale,
        undefined,
        undefined,
        (err) => console.error("Errore texture promo natale", err)
      );
      const glowMat = new THREE.SpriteMaterial({
        map: glowMap,
        transparent: true,
        color: 0xfff2c2,
        opacity: 0.45,
        blending: THREE.AdditiveBlending,
        depthWrite: false
      });
      const glow = new THREE.Sprite(glowMat);
      glow.scale.set(size * 2.4, size * 2.4, 1);

      const group = new THREE.Group();
      group.add(glow);
      group.add(icon);
      group.position.set(-3, 3.5, -4);
      group.userData.persistent = true;
      group.userData._raised = true;

      scene.add(group);

      nataleNode = { mesh: group, glow, icon, baseScale: size * 2.4 };
    }

    if (nataleNode && !objects.some((o) => o.type === "promo-natale")) {
      objects.push({
        type: "promo-natale",
        ref: { id: "offerta-natale" },
        mesh: nataleNode.mesh,
      });
    }

    if (nataleNode) {
      createFloatingTagForObject(nataleNode.mesh, "Offerta Natale", {
        badge: "Promo",
        badgeState: "active",
      });
    }
  }

  function adjustObjectPosition() {
    objects.forEach((obj) => {
      if (obj.mesh && !obj.mesh.userData._raised) {
        obj.mesh.position.y += 2;
        obj.mesh.userData._raised = true;
      }
    });
  }

  function highlightDiscountCategory(category, mesh) {
    if (category.discountActive) {
      const glowEffect = new THREE.MeshStandardMaterial({
        color: 0x00ff00,
        emissive: 0x00ff00,
      });
      mesh.material = glowEffect;
      mesh.userData.discountTag = `Sconto attivo fino a ${category.discountDate}`;
    }
  }

  function updateFloatingTags() {
    const rect = canvas.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    const tagEntries = [];

    floatingTags.forEach((el, mesh) => {
      if (!mesh || !mesh.position) return;
      const vector = new THREE.Vector3();
      mesh.getWorldPosition(vector);
      vector.project(camera);

      if (vector.z < -1 || vector.z > 1) {
        el.style.display = "none";
        return;
      }

      el.style.display = "inline-flex";

      const x = rect.left + (vector.x * 0.5 + 0.5) * width;
      const y = rect.top + (-vector.y * 0.5 + 0.5) * height - 20;

      tagEntries.push({
        el,
        x,
        y,
        width: el.offsetWidth,
        height: el.offsetHeight,
      });
    });

    tagEntries.sort((a, b) => (a.y === b.y ? a.x - b.x : a.y - b.y));

    for (let i = 0; i < tagEntries.length; i++) {
      const entry = tagEntries[i];
      let adjusted = true;
      while (adjusted) {
        adjusted = false;
        for (let j = 0; j < i; j++) {
          const prev = tagEntries[j];
          const overlapX = Math.abs(entry.x - prev.x) < (entry.width + prev.width) / 2;
          const overlapY = Math.abs(entry.y - prev.y) < (entry.height + prev.height) / 2;
          if (overlapX && overlapY) {
            entry.y = prev.y + (prev.height / 2 + entry.height / 2 + 6);
            adjusted = true;
          }
        }
      }
    }

    tagEntries.forEach((entry) => {
      entry.el.style.left = `${entry.x}px`;
      entry.el.style.top = `${entry.y}px`;
    });
  }

  const camera = new THREE.PerspectiveCamera(
    60,
    window.innerWidth / window.innerHeight,
    0.1,
    100
  );
  camera.position.set(0, 3.5, 16);

  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio || 1);

  const ambient = new THREE.AmbientLight(0x1e293b, 2.2);
  scene.add(ambient);
  const mainLight = new THREE.PointLight(0xffffff, 3, 120);
  mainLight.position.set(5, 8, 12);
  scene.add(mainLight);

  const objects = [];

  function applyTextureToCube(cube, texturePath, fallbackPath = null) {
    if (!cube || !texturePath) return;

    const texture = textureLoader.load(
      texturePath,
      undefined,
      undefined,
      (err) => {
        console.error("Errore nel caricamento della texture:", texturePath, err);
        if (fallbackPath && fallbackPath !== texturePath) {
          applyTextureToCube(cube, fallbackPath, null);
        }
      }
    );

    const material = new THREE.MeshStandardMaterial({
      map: texture,
      color: 0xffffff,
      metalness: 0.3,
      roughness: 0.6,
      transparent: true,
      opacity: 1.0,
    });

    cube.material = material;
  }

  function getTexturePathForCategory(category) {
    if (!category) return null;
    if (category.texture) return category.texture;
    const id = category.id;
    if (CATEGORY_TEXTURES[id]) return CATEGORY_TEXTURES[id];

    const dashedId = id?.replace(/_/g, "-");
    if (dashedId && CATEGORY_TEXTURES[dashedId]) return CATEGORY_TEXTURES[dashedId];

    const underscoredId = id?.replace(/-/g, "_");
    if (underscoredId && CATEGORY_TEXTURES[underscoredId]) return CATEGORY_TEXTURES[underscoredId];

    return "/assets/textures/category_placeholder.png";
  }

  function updateCubeTextures() {
    objects.forEach((object) => {
      if (!object.mesh) return;
      if (object.mesh.type === "Sprite") return;
      if (object.mesh.type !== "Mesh") return;

      let texturePath = null;
      switch (object.type) {
        case "system":
        case "system-center":
          texturePath =
            object.ref?.texture || SYSTEM_TEXTURES[object.ref?.id] || null;
          break;
        case "product":
          const prod = object.ref || {};
          const fallbackProductTexture = "/assets/textures/product_placeholder.png";
          texturePath =
            prod.image_thumb ||
            prod.image_hd ||
            (prod.sku ? `/assets/textures/products/${prod.sku}.png` : null) ||
            fallbackProductTexture;
          applyTextureToCube(object.mesh, texturePath, fallbackProductTexture);
          return;
        default:
          break;
      }

      if (texturePath) {
        applyTextureToCube(object.mesh, texturePath);
      }
    });
  }

  function addGalaxy() {
    const group = new THREE.Group();
    const starCount = 120;

    for (let i = 0; i < starCount; i++) {
      const size = 0.15;
      const geo = new THREE.BoxGeometry(size, size, size);
      const mat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        metalness: 0.1,
        roughness: 0.4
      });
      const box = new THREE.Mesh(geo, mat);
      box.position.set(
        (Math.random() - 0.5) * 40,
        (Math.random() - 0.5) * 40,
        (Math.random() - 0.5) * 40
      );
      group.add(box);
    }
    scene.add(group);
  }

  function addSystems() {
    const systemsToRender = universe.systems.length ? [universe.systems[0]] : [];
    systemsToRender.forEach((sys, idx) => {
      const texPath = sys.texture || SYSTEM_TEXTURES[sys.id] || "/assets/textures/category_placeholder.png";

      const sprite = createIconSprite(texPath, 2.2);
      sprite.position.set(sys.position.x, sys.position.y + 1.4, sys.position.z);
      scene.add(sprite);
      createFloatingTagForObject(sprite, sys.name, {
        badge: "Hub",
        badgeState: "active",
      });

      objects.push({ type: "system", ref: sys, mesh: sprite });
    });
  }

  function buildSystemView(system) {
    clearDynamicObjects();
    clearFloatingTags();
    objects.length = 0;
    scene.rotation.set(0, 0, 0);
    targetRotX = 0;
    targetRotY = 0;

    const centerTexPath =
      system.texture || SYSTEM_TEXTURES[system.id] || "/assets/textures/category_placeholder.png";
    const center = createIconSprite(centerTexPath, 2.0);
    center.position.set(0, 1.8, 0);
    scene.add(center);
    objects.push({ type: "system-center", ref: system, mesh: center });
    createFloatingTagForObject(center, system.name, {
      badge: "B2B",
      badgeState: "active",
    });

    const radiusBase = 3.2;

    system.categories.forEach((cat, idx) => {
      const orbitRadius = radiusBase + idx * 1.3;

      const catTexPath = getTexturePathForCategory(cat) || "/assets/textures/category_placeholder.png";

      const icon = createIconSprite(catTexPath, 1.3);
      const angle = (idx / system.categories.length) * Math.PI * 2;
      icon.position.set(
        orbitRadius * Math.cos(angle),
        1.4,
        orbitRadius * Math.sin(angle)
      );
      scene.add(icon);

      objects.push({ type: "category", ref: cat, mesh: icon, orbitRadius, angle });
      createFloatingTagForObject(icon, cat.name, {
        badge: cat.discountActive ? "Sconto attivo" : "Sconto non attivo",
        badgeState: cat.discountActive ? "active" : "inactive",
      });

      // Satelliti per sottocategorie
      cat.subcategories?.forEach((sub, jdx) => {
        const subTexPath =
          sub.texture || getTexturePathForCategory(sub) || "/assets/textures/category_placeholder.png";

        const sat = createIconSprite(subTexPath, 0.75);
        const satAngle = angle + (jdx - (cat.subcategories.length - 1) / 2) * 0.8;
        const satRadius = orbitRadius * 1.22 + jdx * 0.05;
        sat.position.set(
          satRadius * Math.cos(satAngle),
          1.4,
          satRadius * Math.sin(satAngle)
        );
        scene.add(sat);
        objects.push({ type: "subcategory", ref: sub, mesh: sat });
        const subLabel = resolveSubcategoryTagLabel(sub);
        createFloatingTagForObject(sat, subLabel);
      });
    });
    addNataleIcon();
    adjustObjectPosition();
    updateCubeTextures();
  }

  function buildPlanetView(category, subcategory) {
    clearDynamicObjects();
    clearFloatingTags();
    objects.length = 0;
    scene.rotation.set(0, 0, 0);
    targetRotX = 0;
    targetRotY = 0;

    const planetTexPath =
      category.texture || getTexturePathForCategory(category) || "/assets/textures/category_placeholder.png";

    const planet = createIconSprite(planetTexPath, 2.1);
    planet.position.set(0, 1.8, 0);
    scene.add(planet);
    objects.push({ type: "planet", ref: { category, subcategory }, mesh: planet });
    createFloatingTagForObject(planet, category.name, {
      badge: "Dettaglio",
      badgeState: "active",
    });

    const products = subcategory.products || [];
    const ringRadius = 3.0;

    products.forEach((prod, idx) => {
      let texPath =
        prod.image_thumb ||
        prod.image_hd ||
        (prod.sku ? `/assets/textures/products/${prod.sku}.png` : null) ||
        "/assets/textures/product_placeholder.png";

      const sprite = createIconSprite(texPath, 0.9);
      const angle = (idx / Math.max(products.length, 1)) * Math.PI * 2;
      sprite.position.set(
        ringRadius * Math.cos(angle),
        1.4,
        ringRadius * Math.sin(angle)
      );
      scene.add(sprite);
      objects.push({ type: "product", ref: prod, mesh: sprite });

      createFloatingTagForObject(sprite, prod.name || prod.sku || "Prodotto");
    });
    addNataleIcon();
    adjustObjectPosition();
    updateCubeTextures();
  }

  function clearDynamicObjects() {
    clearFloatingTags();
    const keep = [];
    scene.children.forEach(obj => {
      if (
        obj.type === "AmbientLight" ||
        obj.type === "PointLight" ||
        obj.userData?.persistent
      ) {
        keep.push(obj);
      }
    });
    scene.children.slice().forEach(obj => {
      if (!keep.includes(obj)) scene.remove(obj);
    });
  }

  addGalaxy();
  addSystems();
  addSnowflakes();
  adjustObjectPosition();
  updateCubeTextures();
  addNataleIcon();

  // CAMERA & CONTROLS
  let isDragging = false;
  let lastX = 0;
  let lastY = 0;
  let targetRotX = 0;
  let targetRotY = 0;

  let touchStartX = 0;
  let touchStartY = 0;
  let touchMoved = false;

  function updateLabels() {
    zoomLevelLabel.textContent = "Livello: " + zoomLevel;
    locationPathLabel.textContent = "Posizione: /" + currentPath.join("/");
  }

  function resetToGalaxy() {
    clearDynamicObjects();
    clearFloatingTags();
    addGalaxy();
    addSystems();
    addNataleIcon();
    updateCubeTextures();
    camera.position.set(0, 3.5, 16);
    zoomLevel = "GALASSIA";
    currentPath = [];
    currentSystem = null;
    currentCategory = null;
    currentSubcategory = null;
    currentEntity = null;
    currentEntityType = null;
    entityCard.style.display = "none";
    entityAdminActions.style.display = "none";
    scene.rotation.set(0, 0, 0);
    targetRotX = 0;
    targetRotY = 0;
    updateLabels();
  }

  function enterSystem(system) {
    currentSystem = system;
    zoomLevel = "SYSTEM";
    currentPath = [system.name];
    camera.position.set(0, 3.5, 13);
    buildSystemView(system);
    showSystemCard(system);
    updateLabels();
  }

  function enterCategory(cat) {
    if (!currentSystem) return;
    zoomLevel = "SYSTEM";
    currentCategory = cat;
    currentPath = [currentSystem.name, cat.name];
    showCategoryCard(currentSystem, cat);
    updateLabels();
  }

  function enterPlanet(cat, sub) {
    currentCategory = cat;
    currentSubcategory = sub;
    zoomLevel = "PLANET";
    currentPath = [currentSystem.name, cat.name, sub.name];
    camera.position.set(0, 4, 8.5);
    buildPlanetView(cat, sub);
    showCategoryCard(currentSystem, cat);
    updateLabels();
  }

  function focusProduct(prod) {
    currentEntity = prod;
    currentEntityType = "product";
    entityCard.style.display = "flex";
    entityTypeEl.textContent = "PRODOTTO";
    entityTitleEl.textContent = prod.name;
    entityMetaEl.textContent =
      "SKU: " + prod.sku + " ‚Ä¢ Listino: " + (currentUser.tier || "ospite");
    const imgSrc =
      prod.image_thumb ||
      prod.image_hd ||
      (prod.sku ? "/assets/textures/products/" + prod.sku + ".png" : "/assets/textures/product_placeholder.png");
    if (entityImage) {
      entityImage.src = imgSrc;
      entityImage.alt = prod.name || "prodotto";
      entityImage.onerror = () => {
        entityImage.onerror = null;
        entityImage.src = "/assets/textures/product_placeholder.png";
      };
    }
    if (entityImageWrapper) {
      entityImageWrapper.style.display = "block";
    }
    if (!currentUser.logged) {
      entityPriceEl.textContent = "Registrati per vedere il prezzo";
    } else {
      entityPriceEl.textContent = "Carico prezzo‚Ä¶";
    }
    entityRatingEl.textContent = prod.rating
      ? `${renderStars(prod.rating)}  (${prod.rating.toFixed(1)}/5 ‚Ä¢ ${prod.reviews || 0} recensioni)`
      : "";
    entityTagsEl.innerHTML = "";
    (prod.tags || []).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = t;
      entityTagsEl.appendChild(span);
    });

    if (currentUser.logged) {
      entityQtyWrapper.style.display = "flex";
      entityQtyInput.value = "1";
    } else {
      entityQtyWrapper.style.display = "none";
    }

    if (currentUser.name === "GOD ADMIN") {
      entityAdminActions.style.display = "flex";
    } else {
      entityAdminActions.style.display = "none";
    }

    currentProductPrice = 0;
    if (!currentUser.logged) return;

    fetch(BASE_URL + "/ecom/pricing", {
      method: "POST",
      headers: buildAuthHeaders(),
      body: JSON.stringify({
        sku: prod.sku,
        base_price: prod.base_price || prod.price || 0,
        offer_id: (prod.extra || {}).offer_id,
        customer_segment: currentUser.tier,
        quantity: 1
      })
    })
      .then(r => r.json())
      .then(json => {
        if (json && typeof json.price !== "undefined") {
          currentProductPrice = Number(json.price);
          entityPriceEl.textContent = currentProductPrice.toFixed(2) + " ‚Ç¨";
        } else {
          entityPriceEl.textContent = "Prezzo non disponibile";
        }
      })
      .catch(() => {
        entityPriceEl.textContent = "Errore prezzo";
      });
  }

  function showSystemCard(system) {
    currentEntity = system;
    currentEntityType = "system";
    entityCard.style.display = "flex";
    if (entityImageWrapper) entityImageWrapper.style.display = "none";
    entityTypeEl.textContent = "SISTEMA E-COMMERCE";
    entityTitleEl.textContent = system.name;
    entityMetaEl.textContent = "Nodi: categorie " + (system.categories?.length || 0);
    entityRatingEl.textContent = system.rating
      ? `${renderStars(system.rating)}  (${system.rating.toFixed(1)}/5 ‚Ä¢ ${system.reviews || 0} recensioni B2B)`
      : "";
    entityTagsEl.innerHTML = "";
    (system.tags || []).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = t;
      entityTagsEl.appendChild(span);
    });
    entityPriceEl.textContent = "";
    entityQtyWrapper.style.display = "none";
    entityAdminActions.style.display = "none";
    if (entityOfferBox) entityOfferBox.style.display = "none";
  }

  function renderPromoPointsSheet(points, statusText) {
    if (!promoPointsCard || !promoPointsValue || !promoPointsStatus || !promoPointsInactive) return;
    promoPointsCard.style.display = "flex";
    promoPointsInactive.style.display = "none";
    const safePoints = Number.isFinite(points) ? points : 0;
    const label = Number.isFinite(points) ? Number(points).toLocaleString("it-IT") : "0";
    promoPointsValue.textContent = `${label} punti`;
    promoPointsStatus.textContent = statusText;
  }

  function renderPromoPointsInactiveMessage(message) {
    if (!promoPointsCard || !promoPointsInactive) return;
    promoPointsCard.style.display = "none";
    promoPointsInactive.style.display = "block";
    promoPointsInactive.textContent = message;
  }

  async function showPromoPointsView() {
    if (!sheetPromoPoints) return;
    const promoClient = getCurrentClientRecord();
    const isPromoClient = currentUser.logged && promoClient?.promo_enabled;

    if (!isPromoClient) {
      renderPromoPointsInactiveMessage(
        "Non risulti attivo sulla Promo Natale. Contatta il tuo referente commerciale Ormanet per essere abilitato."
      );
      showSheet(sheetPromoPoints);
      return;
    }

    const basePoints = promoClient.promo_points || 0;
    const baseMaxPoints = promoClient.promo_max_points;
    const baseTier = promoClient.promo_ticket_code || promoClient.promo_ticket || null;
    renderPromoPointsSheet(basePoints, buildPromoPointsStatus(basePoints, baseMaxPoints, baseTier));
    showSheet(sheetPromoPoints);

    const summary = await fetchPromoSummary(promoClient.id);
    if (summary) {
      const points = typeof summary.points === "number" ? summary.points : basePoints;
      const maxPoints = typeof summary.max_points !== "undefined" ? summary.max_points : baseMaxPoints;
      const tier = summary.tier || baseTier;
      renderPromoPointsSheet(points || 0, buildPromoPointsStatus(points || 0, maxPoints, tier));
    }
  }

  function showOffertaNataleCard() {
    showPromoPointsView();
  }

  function findOfferTitle(offerId) {
    const offer = offersUniverse.find((o) => o.id === offerId);
    return offer?.title || offer?.name || offerId;
  }

  function findDiscountConfig(offerId) {
    return discountConfigs.find((c) => c.id === offerId);
  }

  function formatDateLabel(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return dateStr;
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  function getPromoPeriodLabel() {
    const startLabel = promoConfig.start_date ? formatDateLabel(promoConfig.start_date) : "-";
    const endLabel = promoConfig.end_date ? formatDateLabel(promoConfig.end_date) : "-";
    return `Periodo promo: ${startLabel} ‚Üí ${endLabel}`;
  }

  function isPromoActiveNow() {
    const today = new Date();
    const start = promoConfig.start_date ? new Date(promoConfig.start_date) : null;
    const end = promoConfig.end_date ? new Date(promoConfig.end_date) : null;
    const validStart = start && !Number.isNaN(start.getTime());
    const validEnd = end && !Number.isNaN(end.getTime());
    if (validStart && today < start) return false;
    if (validEnd && today > end) return false;
    return validStart || validEnd ? true : false;
  }

  function getLatestValidUntil(rules = []) {
    let best = null;
    rules.forEach((r) => {
      if (!r.valid_until) return;
      const d = new Date(r.valid_until);
      if (Number.isNaN(d.getTime())) return;
      if (!best || d > best) best = d;
    });
    return best ? best.toISOString().slice(0, 10) : null;
  }

  function renderDiscountSimulator(cat) {
    if (!entityOfferBox) return;
    const offerId = cat.offerId || cat.id;
    const cfg = findDiscountConfig(offerId);

    if (discountSimRow) discountSimRow.style.display = "flex";
    if (promoDiscountSimBtn) promoDiscountSimBtn.style.display = "none";
    discountSimInput.value = "";
    discountSimOutput.textContent = "";

    if (!cfg) {
      entityOfferBox.style.display = "none";
      return;
    }

    entityOfferBox.style.display = "flex";
    entityOfferTitle.textContent = `${cat.name} ‚Äì Offerta dedicata`;

    const segment = currentUser?.tier || "ospite";
    const rules = (cfg.rules && cfg.rules[segment]) || [];
    const expiry = getLatestValidUntil(rules);
    const expiryLabel = formatDateLabel(expiry);
    discountSimLabel.textContent =
      `Dimmi quanto vuoi spendere nel tuo prossimo ordine e ti dico quanto risparmi fino al ${expiryLabel}`;

    if (!currentUser.logged) {
      discountSimInput.disabled = true;
      discountSimOutput.textContent = "Accedi per vedere il tuo risparmio";
      return;
    }

    discountSimInput.disabled = false;
    if (!rules.length) {
      discountSimOutput.textContent = "Nessuna fascia configurata per il tuo listino.";
      discountSimInput.oninput = null;
      discountSimInput.onchange = null;
      return;
    }

    const computeSim = () => {
      const amount = parseFloat(discountSimInput.value || "0");
      if (!amount || !isFinite(amount)) {
        discountSimOutput.textContent = "";
        return;
      }
      const rule = rules.find((r) => amount >= r.min && amount <= (r.max === Infinity ? amount : r.max));
      if (!rule) {
        discountSimOutput.textContent = "Importo non rientra in nessuna fascia configurata.";
        return;
      }
      const saved = amount * (rule.discount / 100);
      const final = amount - saved;
      discountSimOutput.textContent =
        `Con un ordine di ${formatEuro(amount)} risparmi ${rule.discount}% = ${formatEuro(saved)} (paghi ${formatEuro(final)})`;
    };

    discountSimInput.oninput = computeSim;
    discountSimInput.onchange = computeSim;
  }

  function computePromoNataleDiscount() {
    if (!currentUser.logged || !discountSimInput) return;
    const offerId = "offerta-natale";
    const cfg = findDiscountConfig(offerId);
    const segment = currentUser?.tier || "ospite";
    const rules = (cfg?.rules && cfg.rules[segment]) || [];
    discountSimOutput.textContent = "";

    if (!rules.length) {
      discountSimOutput.textContent = "Nessuna fascia configurata per Promo Natale.";
      return;
    }

    const amount = parseFloat(discountSimInput.value || "0");
    if (!amount || !isFinite(amount)) {
      discountSimOutput.textContent = "Inserisci un importo valido.";
      return;
    }
    const rule = rules.find((r) => amount >= r.min && amount <= (r.max === Infinity ? amount : r.max));
    if (!rule) {
      discountSimOutput.textContent = "Importo non rientra in nessuna fascia Promo Natale.";
      return;
    }
    const saved = amount * (rule.discount / 100);
    const final = amount - saved;
    discountSimOutput.textContent = `Con un fatturato di ${formatEuro(amount)} risparmi ${rule.discount}% = ${formatEuro(saved)} (paghi ${formatEuro(final)}) grazie alla Promo Natale.`;
  }

  function showCategoryCard(system, cat) {
    currentEntity = cat;
    currentEntityType = "category";
    entityCard.style.display = "flex";
    if (entityImageWrapper) entityImageWrapper.style.display = "none";
    entityTypeEl.textContent = "CATEGORIA";
    entityTitleEl.textContent = cat.name;
    const subs = cat.subcategories?.length || 0;
    entityMetaEl.textContent = `${system.name} ‚Ä¢ ${subs} sottocategorie`;
    entityRatingEl.textContent = "";
    entityTagsEl.innerHTML = "";
    (cat.tags || []).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = t;
      entityTagsEl.appendChild(span);
    });
    entityPriceEl.textContent = "";
    entityQtyWrapper.style.display = "none";
    entityAdminActions.style.display = "none";
    renderDiscountSimulator(cat);
    const promoClient = getCurrentClientRecord();
    if (currentUser.logged && promoClient?.promo_enabled && entityOfferBox) {
      const promoMsg = "Promo Natale attiva: accumuli punti con questa categoria.";
      entityOfferBox.style.display = "flex";
      entityPromoSummary.textContent = promoMsg;
    }
  }

  function raycastFromTap(x, y) {
    const mouse = new THREE.Vector2(
      (x / window.innerWidth) * 2 - 1,
      -(y / window.innerHeight) * 2 + 1
    );
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    const meshes = objects.map(o => o.mesh);
    const hits = raycaster.intersectObjects(meshes, true);
    if (hits.length === 0) return;

    const hit = hits[0].object;
    const obj = objects.find(o => o.mesh === hit || o.mesh === hit.parent);
    if (!obj) return;

    if (obj.type === "promo-natale") {
      showPromoPointsView();
      return;
    }

    if (obj.type === "system") {
      enterSystem(obj.ref);
      return;
    }
    if (obj.type === "category") {
      enterCategory(obj.ref);
      return;
    }
    if (obj.type === "subcategory") {
      const cat = currentSystem.categories.find(c => c.subcategories.includes(obj.ref));
      if (cat) enterPlanet(cat, obj.ref);
      return;
    }
    if (obj.type === "product") {
      focusProduct(obj.ref);
      return;
    }
  }

  function goUpOneLevel() {
    if (zoomLevel === "PLANET" && currentSystem) {
      zoomLevel = "SYSTEM";
      currentSubcategory = null;
      camera.position.set(0, 3, 11);
      buildSystemView(currentSystem);
      showSystemCard(currentSystem);
      updateLabels();
      return;
    }
    if (zoomLevel === "SYSTEM") {
      resetToGalaxy();
      return;
    }
  }

  // Mouse handlers
  canvas.addEventListener("mousedown", (e) => {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
  });

  canvas.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    targetRotY += dx * 0.005;
    targetRotX += dy * 0.005;
  });

  canvas.addEventListener("mouseup", () => { isDragging = false; });
  canvas.addEventListener("mouseleave", () => { isDragging = false; });

  canvas.addEventListener("click", (e) => {
    raycastFromTap(e.clientX, e.clientY);
  });

  // Touch handlers
  canvas.addEventListener("touchstart", (e) => {
    if (e.touches.length === 1) {
      const t = e.touches[0];
      isDragging = true;
      lastX = t.clientX;
      lastY = t.clientY;
      touchStartX = t.clientX;
      touchStartY = t.clientY;
      touchMoved = false;
    }
  });

  canvas.addEventListener("touchmove", (e) => {
    if (!isDragging || e.touches.length !== 1) return;
    const t = e.touches[0];
    const dx = t.clientX - lastX;
    const dy = t.clientY - lastY;
    lastX = t.clientX;
    lastY = t.clientY;

    if (Math.abs(t.clientX - touchStartX) > 5 || Math.abs(t.clientY - touchStartY) > 5) {
      touchMoved = true;
    }

    targetRotY += dx * 0.005;
    targetRotX += dy * 0.005;
  });

  canvas.addEventListener("touchend", () => {
    isDragging = false;
    if (!touchMoved) {
      raycastFromTap(touchStartX, touchStartY);
    }
  });

  canvas.addEventListener("wheel", (e) => {
    e.preventDefault();
    const delta = e.deltaY;
    camera.position.z += delta * 0.01;
    camera.position.z = Math.min(Math.max(camera.position.z, 4), 30);
    if (camera.position.z > 18 && zoomLevel !== "GALASSIA") {
      resetToGalaxy();
    }
  }, { passive: false });

  function animate() {
    requestAnimationFrame(animate);
    scene.rotation.y += 0.0006;
    scene.rotation.x += 0.00015;

    scene.rotation.y += (targetRotY - scene.rotation.y) * 0.08;
    scene.rotation.x += (targetRotX - scene.rotation.x) * 0.08;

    snowflakes.forEach((snowflake) => {
      snowflake.position.y -= snowflake.userData.velocity || 0.01;
      if (snowflake.position.y < -20) snowflake.position.y = 20;
    });

    if (nataleNode && nataleNode.glow) {
      const t = performance.now() * 0.001;
      const pulse = 1 + Math.sin(t * 2) * 0.15;
      const base = nataleNode.baseScale || 1.8 * 2.4;
      const scale = base * pulse;
      nataleNode.glow.scale.set(scale, scale, 1);
    }

    renderer.render(scene, camera);
    updateFloatingTags();
  }
  animate();

  window.addEventListener("resize", () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
  });

  // Pulsante INDIETRO: chiude sheet aperti, reset se non c'√® history
  btnBack.addEventListener("click", () => {
    const anySheetOpen = [
      sheetRegister, sheetLogin, sheetOrders, sheetProduct, sheetLlm, sheetPromoPoints
    ].some(el => el.style.display === "flex");
    if (anySheetOpen) {
      [sheetRegister, sheetLogin, sheetOrders, sheetProduct, sheetLlm, sheetPromoPoints]
        .forEach(el => el.style.display = "none");
      return;
    }
    if (window.history.length > 1) {
      window.history.back();
    } else {
      resetToGalaxy();
    }
  });

  // LLM CHAT FRONTEND
  function appendLlmMessage(role, text) {
    const div = document.createElement("div");
    div.className = "llm-msg " + (role === "user" ? "user" : "bot");
    div.textContent = text;
    llmLog.appendChild(div);
    llmLog.scrollTop = llmLog.scrollHeight;
  }

  async function sendLlmMessage() {
    const text = (llmInput.value || "").trim();
    if (!text) return;
    llmInput.value = "";
    appendLlmMessage("user", text);
    llmStatus.textContent = "Il modello sta pensando...";

    const systemPrompt =
      "Sei un assistente AI locale, integrato nella GUI TheLight24 Universe. " +
      "Rispondi SEMPRE in italiano, in massimo 3 frasi brevi. " +
      "Se ti viene chiesto di prodotti, ragiona come assistente B2B e-commerce.";

    const fullPrompt = systemPrompt + "\n\nUtente: " + text + "\nAssistente:";

    try {
      const res = await fetch(LLM_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          prompt: fullPrompt,
          n_predict: 96,
          temperature: 0.7,
          top_k: 40,
          top_p: 0.9,
          stop: ["Utente:", "User:", "Assistente:", "Assistant:"]
        })
      });
      const json = await res.json();
      const out = json.content || json.generated_text || json.completion || JSON.stringify(json);
      appendLlmMessage("bot", out.trim());
      llmStatus.textContent = "";
    } catch (e) {
      llmStatus.textContent = "Errore chiamata modello locale.";
      appendLlmMessage("bot", "Non riesco a contattare il modello locale. Verifica che llama-server sia attivo su 127.0.0.1:8081.");
    }
  }

  btnOpenLlm.addEventListener("click", () => {
    showSheet(sheetLlm);
    llmInput.focus();
  });
  btnLlmClose.addEventListener("click", () => hideSheet(sheetLlm));
  btnLlmSend.addEventListener("click", sendLlmMessage);
  llmInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendLlmMessage();
    }
  });

  async function bootstrapUniverse() {
    try {
      restoreSessionFromStorage();
      await validateSession();
      const authHeaders = buildAuthHeaders();
      const promoCfgPromise = fetch(BASE_URL + "/admin/promo/config", { headers: authHeaders }).catch(() => null);
      const dailyOfferPromise = fetch(BASE_URL + "/admin/daily-offer", { headers: authHeaders }).catch(() => null);
      const [offersRes, clientsRes, productsRes, promoCfgRes, dailyOfferRes] = await Promise.all([
        fetch(BASE_URL + "/admin/offers/all", { headers: authHeaders }),
        fetch(BASE_URL + "/admin/clients/all", { headers: authHeaders }),
        fetch(BASE_URL + "/admin/products/all", { headers: authHeaders }),
        promoCfgPromise,
        dailyOfferPromise
      ]);

      const offersJson = await offersRes.json();
      const clientsJson = await clientsRes.json();
      const productsJson = await productsRes.json();
      if (promoCfgRes && promoCfgRes.ok) {
        const promoCfgJson = await promoCfgRes.json();
        setPromoConfig(promoCfgJson || {});
      }
      if (dailyOfferRes && dailyOfferRes.ok) {
        const dailyJson = await dailyOfferRes.json();
        dailyOffer = dailyJson || null;
      } else {
        dailyOffer = null;
      }

      discountConfigs = (offersJson.configs || []).map((cfg) => {
        const normalized = { ...cfg, rules: {} };
        Object.entries(cfg.rules || {}).forEach(([seg, rules]) => {
          normalized.rules[seg] = (rules || []).map((r) => ({
            ...r,
            max: r.max === null ? Infinity : r.max
          }));
        });
        return normalized;
      });
      clients = clientsJson.clients || [];
      if (Array.isArray(productsJson.products)) priceList = productsJson.products;
      else if (Array.isArray(productsJson.items)) priceList = productsJson.items;
      else if (Array.isArray(productsJson)) priceList = productsJson;
      else priceList = [];

      renderDiscountPreview();
      renderClientsTable();
      refreshPromoClientsSelect();
      refreshDailyProductSelect(dailyProductSearchInput ? dailyProductSearchInput.value : "");
      fillDailyFormFromOffer();
      renderPriceListTable(priceListSearchInput ? priceListSearchInput.value : "");
    } catch (e) {
      console.error("Errore bootstrapUniverse", e);
    } finally {
      updateUserUI();
      ensureDiscountSelectFilled();
      fillClientForm();
      switchAdminTab("clients");
      updateLabels();
    }
  }

  // EXPORT MINIMO
  window.TheLightUniverse = {
    getCurrentProduct: () => (currentEntityType === "product" ? currentEntity : null),
    getCurrentUser: () => currentUser,
    showToast,
    BASE_URL,
    openProductEditor
  };
  renderPromoRulesStatic();
  bootstrapUniverse();
</script>
</body>
</html>
