<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>TheLight24 Universe – B2B Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: light;
      --accent-color: #ff7b00;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      color: #000000;
      overflow: hidden;
      height: 100dvh;
    }
    #app {
      position: relative;
      width: 100vw;
      height: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
    }
    #universe-canvas {
      position: absolute;
      inset: 0;
      touch-action: none;
      z-index: 0;
    }

    /* Top bar */
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 8px 10px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.9);
      z-index: 50;
      gap: 6px;
      min-height: 46px;
    }
    #brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    #brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      white-space: nowrap;
      display: none;
    }
    #brand-logo {
      max-width: 140px;
      height: auto;
      display: block;
      cursor: pointer;
    }
    #brand-sub {
      font-size: 10px;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
      color: #000000;
    }
    #user-panel {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
    }
    .pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      color: #000000;
    }
    .pill span.label { opacity: 0.7; }
    .btn {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--accent-color);
      color: #000000;
      background: #ffffff;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.secondary {
      background: #ffffff;
      border: 1px solid var(--accent-color);
      color: #000000;
    }
    .btn:active { transform: scale(0.97); }

    @media (max-width: 480px) {
      #top-bar { padding: 4px 6px; }
      #brand-title { font-size: 11px; }
      #brand-sub { display: none; }
      #user-panel { gap: 4px; }
      #btn-cart, #btn-login, #btn-register {
        padding-inline: 6px;
        font-size: 10px;
      }
      #tier-pill { display: none; }
    }

    /* Top-right controls (Indietro + Chat AI) */
    #top-right-controls {
      position: absolute;
      top: 52px;
      right: 10px;
      z-index: 25;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      pointer-events: none; /* noi riabilitiamo sui bottoni */
    }
    .top-ctrl-btn {
      pointer-events: auto;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .top-ctrl-btn span.icon {
      font-size: 11px;
      opacity: 0.9;
    }

    @media (max-width: 480px) {
      #top-right-controls {
        top: 72px;
        right: 8px;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: flex-end;
      }
    }

    /* Bottom info panel */
    #info-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px;
      z-index: 15;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(255,255,255,0.9);
    }
    #zoom-level { font-size: 11px; opacity: 0.8; }
    #location-path { font-size: 11px; opacity: 0.9; }
    #hint { font-size: 10px; opacity: 0.7; }
    #entity-card {
      margin-top: 4px;
      background: #ffffff;
      border-radius: 14px;
      padding: 8px;
      border: 1px solid var(--accent-color);
      display: none;
      flex-direction: column;
      gap: 4px;
      color: #000000;
    }
    #entity-type {
      font-size: 10px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    #entity-title { font-size: 12px; font-weight: 600; }
    #entity-meta { font-size: 10px; opacity: 0.85; }
    #entity-rating { font-size: 11px; }
    #entity-price-line {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #entity-price {
      font-size: 13px;
      font-weight: 600;
      color: #000000;
    }
    #entity-qty {
      width: 60px;
      border-radius: 999px;
      padding: 3px 6px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 11px;
    }
    #entity-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    #entity-offer-box {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px dashed var(--accent-color);
      background: rgba(255,123,0,0.06);
      font-size: 11px;
      color: #000000;
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    #discount-sim-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #discount-sim-row label {
      font-size: 11px;
      opacity: 0.8;
    }
    #discount-sim-input {
      border-radius: 10px;
      border: 1px solid var(--accent-color);
      padding: 6px 8px;
      background: #ffffff;
      color: #000000;
      font-size: 12px;
    }
    #discount-sim-output {
      font-size: 11px;
      color: #000000;
      opacity: 0.9;
    }
    .tag {
      border-radius: 999px;
      font-size: 9px;
      padding: 2px 6px;
      background: rgba(30,64,175,0.4);
      border: 1px solid rgba(96,165,250,0.5);
    }
    #entity-admin-actions {
      display: none;
      justify-content: flex-end;
      margin-top: 4px;
    }

    /* Floating nav buttons */
    #nav-buttons {
      margin-top: 4px;
      align-self: flex-end;
      display: flex;
      flex-direction: row;
      gap: 6px;
      position: static;
    }
    .icon-btn {
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 12px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .icon-btn span { font-size: 13px; }

    .floating-tag {
      position: absolute;
      padding: 4px 8px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--accent-color);
      font-size: 11px;
      color: #000000;
      pointer-events: none;
      text-align: center;
      transform: translate(-50%, -50%);
      z-index: 30;
    }

    /* Modal / sheets */
    .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
    }
    .sheet {
      width: 100%;
      max-height: 88dvh;
      background: #ffffff;
      border-radius: 18px 18px 0 0;
      padding: 10px 14px 14px;
      border: 1px solid var(--accent-color);
      overflow-y: auto;
      color: #000000;
    }
    .sheet h2 {
      font-size: 14px;
      margin: 0 0 4px;
    }
    .sheet p {
      font-size: 11px;
      margin: 0 0 8px;
      opacity: 0.8;
    }
    .field {
      margin-bottom: 6px;
    }
    .field label {
      font-size: 11px;
      display: block;
      margin-bottom: 2px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 12px;
    }
    .field textarea {
      min-height: 60px;
      resize: vertical;
    }
    .field small {
      font-size: 9px;
      opacity: 0.6;
    }
    .sheet-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .two-cols {
      display: flex;
      gap: 8px;
    }
    .two-cols .field { flex: 1; }
    @media (max-width: 640px) {
      .two-cols { flex-direction: column; }
    }

    .html-preview {
      border-radius: 8px;
      border: 1px solid var(--accent-color);
      padding: 6px 8px;
      font-size: 11px;
      background: #ffffff;
      max-height: 160px;
      overflow-y: auto;
      color: #000000;
    }

    /* Cart */
    #cart-list {
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }
    .cart-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      padding: 4px 0;
      border-bottom: 1px solid var(--accent-color);
    }
    .cart-main { flex: 1; }
    .cart-sku { font-size: 9px; opacity: 0.6; }
    .cart-qty { font-size: 10px; opacity: 0.8; }
    .cart-price { font-size: 11px; font-weight: 600; }
    #cart-total {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      text-align: right;
    }

    #toast {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22,163,74,0.9);
      color: #000000;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
      z-index: 60;
    }

    /* LLM CHAT SHEET */
    #sheet-llm-chat .sheet {
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }
    #llm-chat-log {
      border-radius: 10px;
      border: 1px solid var(--accent-color);
      padding: 6px 8px;
      font-size: 11px;
      background: #ffffff;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .llm-msg {
      padding: 4px 6px;
      border-radius: 8px;
      max-width: 92%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .llm-msg.user {
      align-self: flex-end;
      background: rgba(255,123,0,0.15);
      border: 1px solid var(--accent-color);
    }
    .llm-msg.bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid var(--accent-color);
    }
    #llm-status {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }
    #llm-chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    #llm-chat-input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-color);
      background: #ffffff;
      color: #000000;
      font-size: 11px;
    }
    #btn-llm-send {
      font-size: 11px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 0;
      background: #22c55e;
      color: #000000;
      cursor: pointer;
    }
  </style>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
</head>
<body>
<div id="app">
  <canvas id="universe-canvas"></canvas>

  <!-- TOP BAR -->
  <div id="top-bar">
    <div id="brand">
      <a href="https://www.ormanet.it" target="_blank">
        <img id="brand-logo" src="/assets/logo_ormanet.png" alt="Ormanet" />
      </a>
      <div id="brand-sub">powered by thelight24</div>
      <div id="brand-title"></div>
    </div>
    <div id="user-panel">
      <div class="pill" id="tier-pill">
        <span class="label">Listino:</span>
        <span id="tier-label">ospite</span>
      </div>
      <button class="btn secondary" id="btn-admin" style="display:none;">Admin</button>
      <button class="btn secondary" id="btn-cart">Carrello (0)</button>
      <button class="btn secondary" id="btn-login">Login</button>
      <button class="btn secondary" id="btn-logout" style="display:none;">Logout</button>
      <button class="btn" id="btn-register">Registrati</button>
    </div>
  </div>

  <!-- TOP RIGHT: INDIETRO + CHAT AI -->
  <div id="top-right-controls">
    <button id="btn-back" class="top-ctrl-btn">
      <span class="icon">←</span><span>Indietro</span>
    </button>
    <button id="btn-open-llm" class="top-ctrl-btn">
      <span class="icon">✦</span><span>Chat AI</span>
    </button>
  </div>

  <!-- BOTTOM PANEL -->
  <div id="info-panel">
    <div id="zoom-level">Livello: GALASSIA</div>
    <div id="location-path">Posizione: /</div>
    <div id="hint">Pinch/zoom o tap per esplorare. Tocca sistemi, stelle, pianeti e satelliti per scendere di livello.</div>

    <div id="entity-card">
      <div id="entity-type"></div>
      <div id="entity-image-wrapper" style="display:none; margin-bottom:4px;">
        <img id="entity-image" src="" alt="" style="width:72px;height:72px;object-fit:contain;border-radius:10px;border:1px solid var(--accent-color);background:#fff;" />
      </div>
      <div id="entity-title"></div>
      <div id="entity-meta"></div>
      <div id="entity-rating"></div>
      <div id="entity-price-line">
        <div id="entity-price"></div>
        <div id="entity-qty-wrapper" style="display:none; align-items:center; gap:4px;">
          <span style="font-size:10px;opacity:0.7;">Qtà</span>
          <input id="entity-qty" type="number" min="1" step="1" value="1" />
          <button class="btn" id="btn-add-cart" style="font-size:10px;padding-inline:8px;">+ Carrello</button>
        </div>
      </div>
      <div id="entity-tags"></div>
      <div id="entity-offer-box">
        <div id="entity-offer-title" style="font-weight:600;"></div>
        <div id="entity-offer-gift"></div>
        <div id="discount-sim-row">
          <label id="discount-sim-label"></label>
          <input id="discount-sim-input" type="number" min="0" step="1" placeholder="Inserisci importo" />
          <div id="discount-sim-output"></div>
        </div>
      </div>
      <div id="entity-admin-actions">
        <button class="btn secondary" id="btn-edit-product" style="font-size:10px;padding-inline:8px;">Modifica scheda</button>
      </div>
    </div>

    <div id="nav-buttons">
      <button class="icon-btn" id="btn-up">
        <span>↑</span><span>Livello su</span>
      </button>
    </div>
  </div>

  <!-- MODAL: REGISTRAZIONE -->
  <div class="backdrop" id="sheet-register">
    <div class="sheet">
      <h2>Registrazione B2B / B2C</h2>
      <p>Per vedere i prezzi devi creare un account. Dopo la verifica ti assegneremo il listino commerciale più adatto al tuo profilo.</p>

      <div class="field">
        <label>Sei un’azienda o un privato?</label>
        <select id="reg-type">
          <option value="azienda">Azienda</option>
          <option value="privato">Privato</option>
        </select>
      </div>

      <div class="field">
        <label>Ragione sociale / Nome completo</label>
        <input id="reg-name" placeholder="Es. Ormanet S.r.l. / Mario Rossi" />
      </div>

      <div class="field">
        <label>Partita IVA</label>
        <input id="reg-piva" placeholder="ITXXXXXXXXXXX" />
        <small>Obbligatoria per aziende. Per privati puoi lasciare vuoto.</small>
      </div>

      <div class="field">
        <label>Codice SDI / PEC</label>
        <input id="reg-sdi" placeholder="Codice destinatario o PEC" />
      </div>

      <div class="field">
        <label>Regime fiscale</label>
        <select id="reg-regime">
          <option value="ordinario">Ordinario</option>
          <option value="forfettario">Forfettario</option>
          <option value="minimi">Regime dei minimi</option>
          <option value="privato">Privato / no P.IVA</option>
        </select>
      </div>

      <div class="field">
        <label>Indirizzo completo attività</label>
        <textarea id="reg-address" placeholder="Via, numero civico, CAP, città, provincia, nazione"></textarea>
      </div>

      <div class="field">
        <label>Email</label>
        <input id="reg-email" type="email" placeholder="esempio@azienda.it" />
      </div>

      <div class="field">
        <label>Telefono / WhatsApp</label>
        <input id="reg-phone" placeholder="+39…" />
      </div>

      <div class="field">
        <label>Come ci hai conosciuti?</label>
        <input id="reg-source" placeholder="Google, passaparola, Amazon, fiera, agente, ecc." />
      </div>

      <div class="field">
        <label>Link o note visura camerale</label>
        <textarea id="reg-visura" placeholder="URL alla visura o note (es. allegata via email, disponibile su richiesta)."></textarea>
      </div>

      <div class="field">
        <label>Metodo di pagamento preferito</label>
        <select id="reg-payment">
          <option value="bonifico">Bonifico bancario (default)</option>
          <option value="contrassegno">Contrassegno</option>
          <option value="carta">Carta / POS virtuale</option>
          <option value="altro">Altro (da concordare)</option>
        </select>
      </div>

      <div class="field">
        <label>
          <input type="checkbox" id="reg-terms" />
          Accetto termini & condizioni, informativa privacy e condizioni di pagamento.
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-reg-cancel">Annulla</button>
        <button class="btn" id="btn-reg-submit">Crea account</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGIN -->
  <div class="backdrop" id="sheet-login">
    <div class="sheet">
      <h2>Login</h2>
      <p>Accedi con la tua email e la password impostata dopo l’attivazione account.</p>

      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="login-password" type="password" />
      </div>

      <div class="field">
        <label>
          <input type="checkbox" id="login-remember" />
          Ricordami su questo dispositivo
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-login-cancel">Annulla</button>
        <button class="btn" id="btn-login-submit">Entra</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CARRELLO -->
  <div class="backdrop" id="sheet-cart">
    <div class="sheet">
      <h2>Carrello</h2>
      <p>Riepilogo articoli selezionati. L’ordine viene inviato come richiesta al reparto commerciale.</p>

      <div id="cart-list"></div>
      <div id="cart-total">Totale: 0,00 €</div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-cart-back">Indietro</button>
        <button class="btn secondary" id="btn-cart-clear">Svuota</button>
        <button class="btn" id="btn-cart-checkout">Invia richiesta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PRODUCT EDITOR -->
  <div class="backdrop" id="sheet-product-editor">
    <div class="sheet">
      <h2>Editor scheda prodotto</h2>
      <p>Modifica contenuti, immagini HD e listini partendo dal listino madre.</p>

      <div class="two-cols">
        <div class="field">
          <label>SKU (bloccato)</label>
          <input id="prod-sku" readonly />
        </div>
        <div class="field">
          <label>Nome prodotto</label>
          <input id="prod-name" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>URL immagine HD principale</label>
          <input id="prod-image-hd" placeholder="https://..." />
        </div>
        <div class="field">
          <label>URL immagine thumbnail</label>
          <input id="prod-image-thumb" placeholder="https://..." />
        </div>
      </div>

      <div class="field">
        <label>Gallery immagini (una URL per riga)</label>
        <textarea id="prod-gallery" placeholder="https://img1...\nhttps://img2..."></textarea>
      </div>

      <div class="field">
        <label>Descrizione HTML (sorgente)</label>
        <textarea id="prod-desc-html" placeholder="<h2>Caratteristiche</h2>..."></textarea>
      </div>
      <div class="field">
        <label>Preview descrizione</label>
        <div id="prod-desc-preview" class="html-preview"></div>
      </div>

      <h2>Listini & ricarichi</h2>
      <p>Imposta il listino madre e le % di ricarico per i listini figli. I prezzi vengono ricalcolati automaticamente.</p>

      <div class="two-cols">
        <div class="field">
          <label>Prezzo listino madre (base)</label>
          <input id="prod-base-price" type="number" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Unità di misura (solo nota)</label>
          <input id="prod-unit" placeholder="es. pz, risma, conf, kg" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore +10%"</label>
          <input id="prod-markup-riv10" type="number" step="0.1" />
          <small>Es. 10 = +10% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore +10%</label>
          <input id="prod-price-riv10" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore"</label>
          <input id="prod-markup-riv" type="number" step="0.1" />
          <small>Es. 20 = +20% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore</label>
          <input id="prod-price-riv" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "distributore"</label>
          <input id="prod-markup-dist" type="number" step="0.1" />
          <small>Puoi anche usare valori negativi per sconti (-5 = -5%).</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato distributore</label>
          <input id="prod-price-dist" type="text" readonly />
        </div>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-prod-cancel">Annulla</button>
        <button class="btn" id="btn-prod-save">Salva scheda</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LLM CHAT -->
  <div class="backdrop" id="sheet-llm-chat">
    <div class="sheet">
      <h2>AI Assistant – TheLight24</h2>
      <p>Chat locale con il modello Phi-3 Mini in esecuzione sul tuo dispositivo.</p>

      <div id="llm-chat-log"></div>
      <div id="llm-status"></div>

      <div id="llm-chat-input-row">
        <input id="llm-chat-input" type="text" placeholder="Scrivi una domanda (es. suggerimento prodotti HP)..." />
        <button id="btn-llm-send">Invia</button>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-llm-close">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADMIN -->
  <div class="backdrop" id="sheet-admin">
    <div class="sheet">
      <h2>Pannello Admin</h2>
      <div style="display:flex; gap:6px; margin-bottom:8px;">
        <button class="btn" id="admin-tab-clients">Clienti</button>
        <button class="btn secondary" id="admin-tab-offers">Macro Offerte</button>
        <button class="btn secondary" id="admin-tab-import">Import Listino</button>
        <button class="btn secondary" id="admin-tab-promo">Promo Natale</button>
      </div>
      <div id="admin-section-clients">
        <h3 style="margin:4px 0;">Gestione clienti</h3>
        <div class="two-cols">
          <div class="field">
            <label>Nome / Ragione sociale</label>
            <input id="client-name" />
          </div>
          <div class="field">
            <label>P.IVA</label>
            <input id="client-piva" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Email</label>
            <input id="client-email" type="email" />
          </div>
          <div class="field">
            <label>Telefono</label>
            <input id="client-phone" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Listino</label>
            <select id="client-listino">
              <option value="distributore">distributore</option>
              <option value="rivenditore">rivenditore</option>
              <option value="rivenditore10">rivenditore10</option>
            </select>
          </div>
          <div class="field">
            <label>Stato</label>
            <select id="client-stato">
              <option value="attivo">attivo</option>
              <option value="sospeso">sospeso</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Note</label>
          <textarea id="client-note"></textarea>
        </div>
        <div class="field">
          <label><input id="client-promo-enabled" type="checkbox" /> Partecipa promo Natale</label>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Punti promo</label>
            <input id="client-promo-points" type="number" readonly />
          </div>
          <div class="field">
            <label>Biglietto regalo</label>
            <input id="client-promo-ticket" type="text" readonly />
          </div>
        </div>
        <div class="sheet-actions">
          <button class="btn secondary" id="btn-client-reset">Nuovo</button>
          <button class="btn" id="btn-client-save">Salva</button>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Filtra per listino</label>
          <select id="client-filter">
            <option value="all">Tutti</option>
            <option value="distributore">distributore</option>
            <option value="rivenditore">rivenditore</option>
            <option value="rivenditore10">rivenditore10</option>
          </select>
        </div>
        <div class="html-preview" style="max-height:200px;">
          <table style="width:100%; font-size:11px; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:2px 4px;">Nome</th>
                <th style="text-align:left; padding:2px 4px;">P.IVA</th>
                <th style="text-align:left; padding:2px 4px;">Email</th>
                <th style="text-align:left; padding:2px 4px;">Listino</th>
                <th style="text-align:left; padding:2px 4px;">Promo</th>
                <th style="text-align:right; padding:2px 4px;">Azioni</th>
              </tr>
            </thead>
            <tbody id="clients-table"></tbody>
          </table>
        </div>
      </div>
      <div id="admin-section-offers" style="display:none;">
        <h3 style="margin:4px 0;">Macro Offerte</h3>
        <div class="field">
          <label>Offerta corrente</label>
          <select id="discount-offer-select"></select>
        </div>
        <div class="field">
          <label>Segmento</label>
          <select id="discount-segment">
            <option value="distributore">distributore</option>
            <option value="rivenditore">rivenditore</option>
            <option value="rivenditore10">rivenditore10</option>
          </select>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>Min importo</label>
            <input id="discount-min" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Max importo</label>
            <input id="discount-max" type="number" step="0.01" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label>% Sconto</label>
            <input id="discount-percent" type="number" step="0.1" />
          </div>
          <div class="field">
            <label>Validità fino a</label>
            <input id="discount-valid" type="date" />
          </div>
        </div>
        <div class="sheet-actions">
          <button class="btn secondary" id="btn-discount-remove">Rimuovi fascia</button>
          <button class="btn" id="btn-discount-add">Aggiungi / Aggiorna fascia</button>
        </div>
        <div class="html-preview" style="max-height:200px;" id="discount-rules-preview"></div>

        <div class="field" style="margin-top:12px;">
          <label><input id="mini-offer-toggle" type="checkbox" /> Mostra mini offerte (Admin)</label>
        </div>
        <div class="html-preview" id="mini-offer-panel"></div>
      </div>
      <div id="admin-section-import" style="display:none;">
        <h3 style="margin:4px 0;">Import Listino .XLS</h3>
        <div class="field">
          <label>Carica file .xls (Office 97)</label>
          <input id="price-list-file" type="file" accept=".xls" />
          <small>Campi richiesti: nome/descrizione articolo, prezzo_distributore, prezzo_rivenditore, prezzo_rivenditore10, quantità_stock, status.</small>
        </div>
        <div class="sheet-actions">
          <button class="btn" id="btn-price-list-upload">Carica listino</button>
        </div>
        <div class="html-preview" id="price-list-preview"></div>
      </div>
      <div id="admin-section-promo" style="display:none;">
        <h3 style="margin:4px 0;">Promo Natale / Biglietto regalo</h3>
        <div class="field">
          <label>Import anagrafiche aderenti (.xls)</label>
          <input id="promo-clients-file" type="file" accept=".xls" />
          <small>Ordine colonne senza intestazione: tipo, ragione sociale / nome, P.IVA, SDI/PEC, regime fiscale, indirizzo completo, email, telefono, come ci hai conosciuti, visura, metodo di pagamento preferito, listino.</small>
        </div>
        <div class="sheet-actions" style="margin-top:4px;">
          <button class="btn" id="btn-promo-clients-upload">Importa aderenti promo</button>
        </div>
        <div class="html-preview" id="promo-clients-preview"></div>

        <h4 style="margin:10px 0 4px 0;">Gestione punti</h4>
        <div class="two-cols">
          <div class="field">
            <label>Cliente promo</label>
            <select id="promo-client-select"></select>
          </div>
          <div class="field">
            <label>Punti attuali</label>
            <input id="promo-client-points" type="text" readonly />
          </div>
        </div>
        <div class="field">
          <label>Azione</label>
          <select id="promo-action-select">
            <option value="">Seleziona azione</option>
            <option value="FOLLOW_SOCIAL">FOLLOW_SOCIAL – +5 punti</option>
            <option value="ADD_BROADCAST">ADD_BROADCAST – +50 punti</option>
            <option value="ORDER_REMAN">ORDER_REMAN – +100 punti</option>
            <option value="REACH_AVG_REVENUE">REACH_AVG_REVENUE – +200 punti</option>
            <option value="UPSELL_REVENUE">UPSELL_REVENUE – +500 punti</option>
            <option value="BRING_NEW_COMPANY">BRING_NEW_COMPANY – +1000 punti</option>
          </select>
        </div>
        <div class="sheet-actions" style="margin-top:4px;">
          <button class="btn" id="btn-promo-add-points">Aggiungi punti</button>
        </div>
        <div class="html-preview" id="promo-summary"></div>
      </div>
      <div class="sheet-actions">
        <button class="btn secondary" id="btn-admin-close">Chiudi</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>
</div>

<script>
  const BASE_URL = ""; // stesso host/porta per API ecom
  const LLM_URL = "http://127.0.0.1:8081/completion";

  const SYSTEM_TEXTURES = {
    ormanet: "/assets/textures/1.png",
  };

  const CATEGORY_TEXTURES = {
    "batterie": "/assets/textures/2.png",
    "cancelleria": "/assets/textures/3.png",
    "carta-stampa": "/assets/textures/4.png",
    "carta_stampa": "/assets/textures/4.png",
    "consumabili-originali": "/assets/textures/5.png",
    "consumabili_originali": "/assets/textures/5.png",
    "elettronica": "/assets/textures/6.png",
    "eliminacode": "/assets/textures/7.png",
    "rotoli-termici": "/assets/textures/8.png",
    "rotoli_termici": "/assets/textures/8.png",
    "stampanti": "/assets/textures/9.png",
    "storage": "/assets/textures/10.png",
    "consumabili-remanufactured": "/assets/textures/11.png",
    "consumabili_remanufactured": "/assets/textures/11.png",
  };

  const adminSettings = {
    miniOfferEnabled: false,
  };

  let priceList = [];
  let clients = [];
  const offersUniverse = [
    {
      id: "ormanet",
      name: "Ormanet B2B",
      title: "Ormanet – Universe B2B",
      texture: SYSTEM_TEXTURES["ormanet"],
      position: { x: 0, y: 1, z: -8 },
      tags: ["B2B", "Smart purchasing"],
      categories: [
        {
          id: "batterie",
          name: "Batterie",
          tags: ["energia", "ricarica"],
          subcategories: [{ id: "batterie-gift", name: "Gift Kit Energia" }]
        },
        {
          id: "cancelleria",
          name: "Cancelleria",
          tags: ["ufficio"],
          subcategories: [{ id: "cancelleria-gift", name: "Box ufficio" }]
        },
        {
          id: "carta-stampa",
          name: "Carta per stampa",
          tags: ["risme", "ufficio"],
          subcategories: [{ id: "carta-gift", name: "Pacco premium" }]
        },
        {
          id: "consumabili-originali",
          name: "Consumabili originali",
          tags: ["toner", "inkjet", "originali"],
          offerId: "offerta-consumabili-originali",
          subcategories: [{ id: "consumabili-gift", name: "Box regalo consumabili" }]
        },
        {
          id: "elettronica",
          name: "Elettronica",
          tags: ["device", "pc", "monitor"],
          subcategories: [{ id: "elettronica-gift", name: "Bundle tech" }]
        },
        {
          id: "eliminacode",
          name: "Eliminacode",
          tags: ["gestione flussi"],
          subcategories: [{ id: "eliminacode-gift", name: "Kit front-office" }]
        },
        {
          id: "rotoli-termici",
          name: "Rotoli termici",
          tags: ["pos", "ricevute"],
          subcategories: [{ id: "rotoli-gift", name: "Box rotoli" }]
        },
        {
          id: "stampanti",
          name: "Stampanti",
          tags: ["laser", "inkjet"],
          subcategories: [{ id: "stampanti-gift", name: "Bundle stampanti" }]
        },
        {
          id: "storage",
          name: "Storage",
          tags: ["ssd", "hdd", "backup"],
          subcategories: [{ id: "storage-gift", name: "Box storage" }]
        },
        {
          id: "consumabili-remanufactured",
          name: "Remanufactured",
          tags: ["green", "remanufactured"],
          subcategories: [{ id: "reman-gift", name: "Box eco" }]
        }
      ]
    }
  ];
  let discountConfigs = [];

  let currentUser = {
    logged: false,
    tier: "ospite",
    name: null,
    token: null,
    email: null,
  };

  let zoomLevel = "GALASSIA";
  let currentPath = [];
  let currentSystem = null;
  let currentCategory = null;
  let currentSubcategory = null;
  let currentEntity = null;
  let currentEntityType = null;

  let cart = [];
  let currentProductPrice = 0;

  const canvas = document.getElementById("universe-canvas");
  const appEl = document.getElementById("app");
  const tierLabel = document.getElementById("tier-label");
  const zoomLevelLabel = document.getElementById("zoom-level");
  const locationPathLabel = document.getElementById("location-path");
  const toast = document.getElementById("toast");

  const entityCard = document.getElementById("entity-card");
  const entityTypeEl = document.getElementById("entity-type");
  const entityTitleEl = document.getElementById("entity-title");
  const entityMetaEl = document.getElementById("entity-meta");
  const entityImageWrapper = document.getElementById("entity-image-wrapper");
  const entityImage = document.getElementById("entity-image");
  const entityRatingEl = document.getElementById("entity-rating");
  const entityPriceEl = document.getElementById("entity-price");
  const entityTagsEl = document.getElementById("entity-tags");
  const entityOfferBox = document.getElementById("entity-offer-box");
  const entityOfferTitle = document.getElementById("entity-offer-title");
  const entityOfferGift = document.getElementById("entity-offer-gift");
  const discountSimLabel = document.getElementById("discount-sim-label");
  const discountSimInput = document.getElementById("discount-sim-input");
  const discountSimOutput = document.getElementById("discount-sim-output");
  const entityQtyWrapper = document.getElementById("entity-qty-wrapper");
  const entityQtyInput = document.getElementById("entity-qty");
  const entityAdminActions = document.getElementById("entity-admin-actions");
  const btnAdmin = document.getElementById("btn-admin");

  const sheetRegister = document.getElementById("sheet-register");
  const sheetLogin = document.getElementById("sheet-login");
  const sheetCart = document.getElementById("sheet-cart");
  const cartListEl = document.getElementById("cart-list");
  const cartTotalEl = document.getElementById("cart-total");
  const btnCart = document.getElementById("btn-cart");
  const btnCartBack = document.getElementById("btn-cart-back");

  const sheetProduct = document.getElementById("sheet-product-editor");
  const sheetAdmin = document.getElementById("sheet-admin");
  const skuInput = document.getElementById("prod-sku");
  const nameInput = document.getElementById("prod-name");
  const imageHdInput = document.getElementById("prod-image-hd");
  const imageThumbInput = document.getElementById("prod-image-thumb");
  const galleryInput = document.getElementById("prod-gallery");
  const descHtmlInput = document.getElementById("prod-desc-html");
  const descPreview = document.getElementById("prod-desc-preview");

  const basePriceInput = document.getElementById("prod-base-price");
  const unitInput = document.getElementById("prod-unit");
  const markupRiv10Input = document.getElementById("prod-markup-riv10");
  const markupRivInput = document.getElementById("prod-markup-riv");
  const markupDistInput = document.getElementById("prod-markup-dist");

  const priceRiv10Output = document.getElementById("prod-price-riv10");
  const priceRivOutput = document.getElementById("prod-price-riv");
  const priceDistOutput = document.getElementById("prod-price-dist");

  const btnProdCancel = document.getElementById("btn-prod-cancel");
  const btnProdSave = document.getElementById("btn-prod-save");
  const btnEditProduct = document.getElementById("btn-edit-product");
  const adminTabClients = document.getElementById("admin-tab-clients");
  const adminTabOffers = document.getElementById("admin-tab-offers");
  const adminTabImport = document.getElementById("admin-tab-import");
  const adminTabPromo = document.getElementById("admin-tab-promo");
  const adminSectionClients = document.getElementById("admin-section-clients");
  const adminSectionOffers = document.getElementById("admin-section-offers");
  const adminSectionImport = document.getElementById("admin-section-import");
  const adminSectionPromo = document.getElementById("admin-section-promo");
  const clientsTable = document.getElementById("clients-table");
  const clientNameInput = document.getElementById("client-name");
  const clientPivaInput = document.getElementById("client-piva");
  const clientEmailInput = document.getElementById("client-email");
  const clientPhoneInput = document.getElementById("client-phone");
  const clientListinoInput = document.getElementById("client-listino");
  const clientStatoInput = document.getElementById("client-stato");
  const clientNoteInput = document.getElementById("client-note");
  const clientPromoEnabledInput = document.getElementById("client-promo-enabled");
  const clientPromoPointsInput = document.getElementById("client-promo-points");
  const clientPromoTicketInput = document.getElementById("client-promo-ticket");
  const clientFilterSelect = document.getElementById("client-filter");
  const btnClientSave = document.getElementById("btn-client-save");
  const btnClientReset = document.getElementById("btn-client-reset");
  const discountOfferSelect = document.getElementById("discount-offer-select");
  const discountSegmentSelect = document.getElementById("discount-segment");
  const discountMinInput = document.getElementById("discount-min");
  const discountMaxInput = document.getElementById("discount-max");
  const discountPercentInput = document.getElementById("discount-percent");
  const discountValidInput = document.getElementById("discount-valid");
  const btnDiscountAdd = document.getElementById("btn-discount-add");
  const btnDiscountRemove = document.getElementById("btn-discount-remove");
  const discountPreview = document.getElementById("discount-rules-preview");
  const miniOfferToggle = document.getElementById("mini-offer-toggle");
  const miniOfferPanel = document.getElementById("mini-offer-panel");
  const priceListFileInput = document.getElementById("price-list-file");
  const btnPriceListUpload = document.getElementById("btn-price-list-upload");
  const priceListPreview = document.getElementById("price-list-preview");
  const promoClientsFileInput = document.getElementById("promo-clients-file");
  const btnPromoClientsUpload = document.getElementById("btn-promo-clients-upload");
  const promoClientsPreview = document.getElementById("promo-clients-preview");
  const promoClientSelect = document.getElementById("promo-client-select");
  const promoClientPoints = document.getElementById("promo-client-points");
  const promoActionSelect = document.getElementById("promo-action-select");
  const btnPromoAddPoints = document.getElementById("btn-promo-add-points");
  const promoSummaryBox = document.getElementById("promo-summary");

  const btnBack = document.getElementById("btn-back");
  const btnOpenLlm = document.getElementById("btn-open-llm");

  const sheetLlm = document.getElementById("sheet-llm-chat");
  const llmLog = document.getElementById("llm-chat-log");
  const llmStatus = document.getElementById("llm-status");
  const llmInput = document.getElementById("llm-chat-input");
  const btnLlmSend = document.getElementById("btn-llm-send");
  const btnLlmClose = document.getElementById("btn-llm-close");
  const btnAdminClose = document.getElementById("btn-admin-close");

  let editingProduct = null;
  let editingClientId = null;

  const showSheet = (el) => { el.style.display = "flex"; };
  const hideSheet = (el) => { el.style.display = "none"; };

  document.getElementById("btn-register").addEventListener("click", () => showSheet(sheetRegister));
  document.getElementById("btn-reg-cancel").addEventListener("click", () => hideSheet(sheetRegister));
  document.getElementById("btn-login").addEventListener("click", () => showSheet(sheetLogin));
  document.getElementById("btn-login-cancel").addEventListener("click", () => hideSheet(sheetLogin));
  document.getElementById("btn-logout").addEventListener("click", logout);
  btnCart.addEventListener("click", () => showSheet(sheetCart));
  if (btnAdmin) {
    btnAdmin.addEventListener("click", () => showSheet(sheetAdmin));
  }
  if (btnAdminClose) {
    btnAdminClose.addEventListener("click", () => hideSheet(sheetAdmin));
  }
  if (btnCartBack) {
    btnCartBack.addEventListener("click", () => {
      hideSheet(sheetCart);
    });
  }
  document.getElementById("btn-cart-clear").addEventListener("click", () => { cart = []; updateCartUI(); });
  document.getElementById("btn-cart-checkout").addEventListener("click", checkoutCart);
  document.getElementById("btn-up").addEventListener("click", goUpOneLevel);

  adminTabClients.addEventListener("click", () => switchAdminTab("clients"));
  adminTabOffers.addEventListener("click", () => switchAdminTab("offers"));
  adminTabImport.addEventListener("click", () => switchAdminTab("import"));
  if (adminTabPromo) {
    adminTabPromo.addEventListener("click", () => switchAdminTab("promo"));
  }

  btnClientReset.addEventListener("click", () => fillClientForm());
  btnClientSave.addEventListener("click", saveClient);
  clientFilterSelect.addEventListener("change", renderClientsTable);

  discountOfferSelect.addEventListener("change", renderDiscountPreview);
  discountSegmentSelect.addEventListener("change", renderDiscountPreview);

  btnDiscountAdd.addEventListener("click", addDiscountRule);
  btnDiscountRemove.addEventListener("click", removeDiscountRule);
  if (miniOfferToggle) {
    miniOfferToggle.addEventListener("change", () => {
      adminSettings.miniOfferEnabled = miniOfferToggle.checked;
      const productData =
        currentEntityType === "product"
          ? currentEntity
          : priceList.find((p) => p) || null;
      toggleMiniOffer(adminSettings, productData);
    });
  }
  btnPriceListUpload.addEventListener("click", uploadPriceList);
  if (btnPromoClientsUpload) {
    btnPromoClientsUpload.addEventListener("click", uploadPromoClients);
  }
  if (btnPromoAddPoints) {
    btnPromoAddPoints.addEventListener("click", addPromoPoints);
  }
  if (promoClientSelect) {
    promoClientSelect.addEventListener("change", () => {
      const id = promoClientSelect.value;
      if (id) {
        fetchPromoSummary(id);
      }
    });
  }

  function showToast(msg, ok = true) {
    toast.textContent = msg;
    toast.style.background = ok ? "rgba(22,163,74,0.9)" : "rgba(185,28,28,0.9)";
    toast.style.display = "block";
    setTimeout(() => { toast.style.display = "none"; }, 2500);
  }

  function buildAuthHeaders(contentType = "application/json") {
    const headers = {};
    if (contentType) headers["Content-Type"] = contentType;
    if (currentUser.token) headers["Authorization"] = "Bearer " + currentUser.token;
    return headers;
  }

  function saveSessionToStorage(user, token, remember) {
    const payload = {
      name: user.name,
      tier: user.tier,
      token,
      email: user.email || null
    };
    const storage = remember ? window.localStorage : window.sessionStorage;
    storage.setItem("thelight24_session", JSON.stringify(payload));
  }

  function clearSessionStorage() {
    window.localStorage.removeItem("thelight24_session");
    window.sessionStorage.removeItem("thelight24_session");
  }

  function restoreSessionFromStorage() {
    const raw = window.localStorage.getItem("thelight24_session") ||
                window.sessionStorage.getItem("thelight24_session");
    if (!raw) return;

    try {
      const sess = JSON.parse(raw);
      if (!sess || !sess.token) return;
      currentUser.logged = true;
      currentUser.name = sess.name || sess.email || "utente";
      currentUser.tier = sess.tier || "rivenditore10";
      currentUser.token = sess.token;
      currentUser.email = sess.email || null;
      updateUserUI();
    } catch (e) {
      console.error("Errore restoreSessionFromStorage", e);
    }
  }

  function logout() {
    currentUser = { logged: false, tier: "ospite", name: null, token: null, email: null };
    clearSessionStorage();
    updateUserUI();
    showToast("Sei uscito dall'account.");
  }

  function toggleMiniOffer(adminSettings, productData) {
    if (!miniOfferPanel) return;
    miniOfferPanel.innerHTML = "";
    if (!adminSettings.miniOfferEnabled || !productData) return;

    const offerBox = document.createElement("div");
    offerBox.style.display = "flex";
    offerBox.style.alignItems = "center";
    offerBox.style.gap = "8px";
    offerBox.innerHTML = `
      <img src="${productData.image || productData.image_hd || ""}" alt="${productData.name || ""}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;" />
      <div>
        <strong>${productData.name || "Prodotto"}</strong>
        <p style="margin:2px 0;">Prezzo: €${(productData.price || productData.base_price || 0) - (productData.discount || 0)}</p>
      </div>
    `;
    miniOfferPanel.appendChild(offerBox);
  }

  function switchAdminTab(target) {
    [adminSectionClients, adminSectionOffers, adminSectionImport, adminSectionPromo]
      .forEach((sec) => sec && (sec.style.display = "none"));
    [adminTabClients, adminTabOffers, adminTabImport, adminTabPromo]
      .forEach((btn) => btn && btn.classList.add("secondary"));
    if (target === "clients") {
      adminSectionClients.style.display = "block";
      adminTabClients.classList.remove("secondary");
    } else if (target === "offers") {
      adminSectionOffers.style.display = "block";
      adminTabOffers.classList.remove("secondary");
    } else if (target === "promo") {
      adminSectionPromo.style.display = "block";
      adminTabPromo.classList.remove("secondary");
    } else {
      adminSectionImport.style.display = "block";
      adminTabImport.classList.remove("secondary");
    }
  }

  function renderClientsTable() {
    if (!clientsTable) return;
    clientsTable.innerHTML = "";
    const filter = clientFilterSelect.value;
    const filtered = clients.filter(c => filter === "all" || c.listino === filter);
    filtered.forEach((c) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:2px 4px;">${c.ragione_sociale || c.name || ""}</td>
        <td style="padding:2px 4px;">${c.piva || ""}</td>
        <td style="padding:2px 4px;">${c.email || ""}</td>
        <td style="padding:2px 4px;">${c.listino || ""}</td>
        <td style="padding:2px 4px;">${c.promo_enabled ? `<span class="tag">XMAS · ${c.promo_points || 0} pt</span>` : ""}</td>
        <td style="padding:2px 4px; text-align:right;">
          <button class="btn secondary" data-id="${c.id}" data-action="edit" style="font-size:10px;">Modifica</button>
          <button class="btn secondary" data-id="${c.id}" data-action="delete" style="font-size:10px;">Elimina</button>
        </td>`;
      clientsTable.appendChild(tr);
    });
    clientsTable.querySelectorAll("button").forEach((btn) => {
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      btn.addEventListener("click", () => {
        if (action === "edit") {
          const client = clients.find((c) => c.id == id);
          fillClientForm(client);
        } else {
          deleteClient(id);
        }
      });
    });
  }

  function getCurrentClientRecord() {
    if (!currentUser?.email) return null;
    const emailLower = String(currentUser.email).toLowerCase();
    return clients.find((c) => (c.email || "").toLowerCase() === emailLower) || null;
  }

  function refreshPromoClientsSelect() {
    if (!promoClientSelect) return;
    const promoClients = clients.filter((c) => c.promo_enabled);
    if (!promoClients.length) {
      promoClientSelect.innerHTML = '<option value="">Nessun cliente promo</option>';
      if (promoClientPoints) promoClientPoints.value = "";
      if (promoSummaryBox) promoSummaryBox.innerHTML = "";
      return;
    }
    promoClientSelect.innerHTML = promoClients
      .map(
        (c) =>
          `<option value="${c.id}">${c.ragione_sociale || c.email || "Cliente"} (${c.email || "-"}) – ${c.promo_points || 0} pt</option>`
      )
      .join("");
    if (promoClientSelect.value) {
      fetchPromoSummary(promoClientSelect.value);
    }
  }

  function renderPromoSummary(summary) {
    if (!summary) return;
    if (promoClientPoints) {
      promoClientPoints.value = summary.points ?? "";
    }
    if (!promoSummaryBox) return;
    const tierLabel =
      summary.tier === "max"
        ? "biglietto fortunato"
        : summary.tier === "tier2"
          ? "2 premi disponibili"
          : summary.tier === "tier1"
            ? "1 premio disponibile"
            : "base";
    const prizes = (summary.prizes_available || []).map((p) => `<li>${p}</li>`).join("");
    promoSummaryBox.innerHTML = `
      <div><strong>Punti totali:</strong> ${summary.points || 0}</div>
      <div><strong>Tier:</strong> ${tierLabel}</div>
      <div><strong>Premi disponibili:</strong></div>
      <ul>${prizes || '<li>Nessun premio disponibile</li>'}</ul>
    `;
  }

  async function fetchPromoSummary(clientId) {
    try {
      const res = await fetch(`${BASE_URL}/admin/promo/summary?client_id=${clientId}`, {
        headers: buildAuthHeaders(),
      });
      if (!res.ok) return;
      const summary = await res.json();
      renderPromoSummary(summary);
    } catch (e) {
      console.error("Errore fetchPromoSummary", e);
    }
  }

  function fillClientForm(client = null) {
    editingClientId = client ? client.id : null;
    clientNameInput.value = client?.ragione_sociale || client?.name || "";
    clientPivaInput.value = client?.piva || "";
    clientEmailInput.value = client?.email || "";
    clientPhoneInput.value = client?.telefono || client?.phone || "";
    clientListinoInput.value = client?.listino || "distributore";
    clientStatoInput.value = client?.stato || "attivo";
    clientNoteInput.value = client?.note || "";
    if (clientPromoEnabledInput) {
      clientPromoEnabledInput.checked = !!client?.promo_enabled;
    }
    if (clientPromoPointsInput) {
      clientPromoPointsInput.value = client?.promo_points || 0;
    }
    if (clientPromoTicketInput) {
      clientPromoTicketInput.value = client?.promo_ticket_code || "";
    }
  }

  async function saveClient() {
    const client = {
      id: editingClientId || null,
      ragione_sociale: clientNameInput.value,
      piva: clientPivaInput.value,
      email: clientEmailInput.value,
      telefono: clientPhoneInput.value,
      listino: clientListinoInput.value,
      stato: clientStatoInput.value,
      note: clientNoteInput.value,
      promo_enabled: clientPromoEnabledInput?.checked ? 1 : 0,
      promo_points: parseInt(clientPromoPointsInput?.value || "0", 10) || 0,
      promo_ticket_code: clientPromoTicketInput?.value || null,
    };
    const existingIdx = client.id ? clients.findIndex((c) => c.id === client.id) : -1;
    try {
      await fetch(BASE_URL + "/admin/clients/save", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(client),
      });
      const refreshed = await fetch(BASE_URL + "/admin/clients/all", { headers: buildAuthHeaders() });
      const data = await refreshed.json();
      clients = data.clients || [];
      renderClientsTable();
      refreshPromoClientsSelect();
      showToast("Cliente salvato");
    } catch (e) {
      if (existingIdx >= 0) clients[existingIdx] = client; else clients.push(client);
      renderClientsTable();
      refreshPromoClientsSelect();
      showToast("Cliente salvato in locale", false);
    }
    fillClientForm();
  }

  async function deleteClient(id) {
    clients = clients.filter((c) => c.id != id);
    renderClientsTable();
    try {
      await fetch(BASE_URL + "/admin/clients/delete", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify({ id }),
      });
      const refreshed = await fetch(BASE_URL + "/admin/clients/all", { headers: buildAuthHeaders() });
      const data = await refreshed.json();
      clients = data.clients || [];
      renderClientsTable();
      refreshPromoClientsSelect();
    } catch (e) {
      showToast("Cliente eliminato solo in locale", false);
    }
  }

  function renderDiscountPreview() {
    if (!discountPreview) return;
    const header = `
      <thead>
        <tr>
          <th style="text-align:left;padding:2px 4px;">ID offerta</th>
          <th style="text-align:left;padding:2px 4px;">Titolo</th>
          <th style="text-align:left;padding:2px 4px;">Segmento</th>
          <th style="text-align:left;padding:2px 4px;">Range</th>
          <th style="text-align:left;padding:2px 4px;">%</th>
          <th style="text-align:left;padding:2px 4px;">Validità</th>
        </tr>
      </thead>`;
    const bodyRows = discountConfigs.map((cfg) => {
      const segments = Object.entries(cfg.rules || {});
      if (!segments.length) {
        return `<tr>
          <td style="padding:2px 4px;">${cfg.id}</td>
          <td style="padding:2px 4px;">${findOfferTitle(cfg.id)}</td>
          <td colspan="4" style="padding:2px 4px;">Nessuna regola configurata</td>
        </tr>`;
      }
      return segments.map(([segment, rules]) => {
        if (!rules.length) {
          return `<tr>
            <td style="padding:2px 4px;">${cfg.id}</td>
            <td style="padding:2px 4px;">${findOfferTitle(cfg.id)}</td>
            <td style="padding:2px 4px;">${segment}</td>
            <td colspan="3" style="padding:2px 4px;">Nessuna fascia</td>
          </tr>`;
        }
        return rules.map((r) => {
          const maxLabel = !isFinite(r.max) || r.max === null ? "∞" : r.max;
          return `<tr>
            <td style="padding:2px 4px;">${cfg.id}</td>
            <td style="padding:2px 4px;">${findOfferTitle(cfg.id)}</td>
            <td style="padding:2px 4px;">${segment}</td>
            <td style="padding:2px 4px;">${r.min} – ${maxLabel}</td>
            <td style="padding:2px 4px;">${r.discount}%</td>
            <td style="padding:2px 4px;">${formatDateLabel(r.valid_until)}</td>
          </tr>`;
        }).join("");
      }).join("");
    }).join("");

    discountPreview.innerHTML = discountConfigs.length
      ? `<table style="width:100%; border-collapse:collapse; font-size:11px;">${header}<tbody>${bodyRows}</tbody></table>`
      : "";
  }

  function ensureDiscountSelectFilled() {
    if (!discountOfferSelect) return;
    const opts = [];
    const known = new Set();
    offersUniverse.forEach((o) => {
      known.add(o.id);
      opts.push(`<option value="${o.id}">${o.title || o.name}</option>`);
    });
    discountConfigs.forEach((cfg) => {
      if (!known.has(cfg.id)) {
        opts.push(`<option value="${cfg.id}">${cfg.id}</option>`);
      }
    });
    discountOfferSelect.innerHTML = opts.join("");
  }

  async function addDiscountRule() {
    const offerId = discountOfferSelect.value;
    const segment = discountSegmentSelect.value;
    const min = parseFloat(discountMinInput.value || "0");
    const max = parseFloat(discountMaxInput.value || "0");
    const percent = parseFloat(discountPercentInput.value || "0");
    const valid = discountValidInput.value || "";
    let cfg = discountConfigs.find((c) => c.id === offerId);
    if (!cfg) {
      cfg = { id: offerId, rules: { distributore: [], rivenditore: [], rivenditore10: [] } };
      discountConfigs.push(cfg);
    }
    const list = cfg.rules[segment] || [];
    const maxValue = isFinite(max) ? max : null;
    const existingIdx = list.findIndex((r) => r.min === min && (r.max === maxValue || (!isFinite(r.max) && maxValue === null)));
    const rule = { min, max: maxValue === null ? Infinity : maxValue, discount: percent, valid_until: valid };
    if (existingIdx >= 0) list[existingIdx] = rule; else list.push(rule);
    cfg.rules[segment] = list;
    renderDiscountPreview();
    try {
      const payload = JSON.parse(JSON.stringify(cfg, (k, v) => (v === Infinity ? null : v)));
      await fetch(BASE_URL + "/admin/offers/save", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(payload),
      });
    } catch (e) {
      showToast("Configurazione salvata localmente", false);
    }
  }

  function removeDiscountRule() {
    const offerId = discountOfferSelect.value;
    const segment = discountSegmentSelect.value;
    let cfg = discountConfigs.find((c) => c.id === offerId);
    if (!cfg) return;
    cfg.rules[segment] = [];
    renderDiscountPreview();
  }

  async function uploadPriceList() {
    const file = priceListFileInput.files[0];
    if (!file) {
      showToast("Seleziona un file .xls", false);
      return;
    }
    const fd = new FormData();
    fd.append("file", file);
    try {
      const data = await importPriceList(fd);
      priceList = data?.products || [];
      priceListPreview.textContent = `Prodotti caricati: ${priceList.length}`;
    } catch (e) {
      priceListPreview.textContent = "Listino caricato localmente";
    }
  }

  async function uploadPromoClients() {
    if (!promoClientsFileInput || !promoClientsFileInput.files.length) {
      showToast("Seleziona un file .xls per importare", false);
      return;
    }
    const formData = new FormData();
    formData.append("file", promoClientsFileInput.files[0]);
    try {
      const res = await fetch(BASE_URL + "/admin/clients/import_promo", {
        method: "POST",
        headers: buildAuthHeaders(null),
        body: formData,
      });
      const json = await res.json();
      if (promoClientsPreview) {
        const newCount = json.imported || 0;
        const updatedCount = json.updated || 0;
        const total = newCount + updatedCount;
        promoClientsPreview.textContent = `Clienti promo importati: ${total} (nuovi: ${newCount}, aggiornati: ${updatedCount})`;
      }
      const refreshed = await fetch(BASE_URL + "/admin/clients/all", { headers: buildAuthHeaders() });
      const data = await refreshed.json();
      clients = data.clients || [];
      renderClientsTable();
      refreshPromoClientsSelect();
      showToast("Import promo completato");
    } catch (e) {
      console.error("Errore uploadPromoClients", e);
      showToast("Import promo non riuscito", false);
    }
  }

  async function addPromoPoints() {
    const clientId = promoClientSelect?.value;
    const actionCode = promoActionSelect?.value;
    if (!clientId || !actionCode) {
      showToast("Seleziona cliente e azione promo", false);
      return;
    }
    try {
      const res = await fetch(BASE_URL + "/admin/promo/add_points", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify({ client_id: Number(clientId), action_code: actionCode }),
      });
      const json = await res.json();
      if (json.status !== "ok") {
        showToast("Errore aggiunta punti", false);
        return;
      }
      const idx = clients.findIndex((c) => String(c.id) === String(clientId));
      if (idx >= 0) {
        clients[idx] = { ...clients[idx], ...json.client };
      }
      refreshPromoClientsSelect();
      renderPromoSummary(json.summary || {});
      showToast("Punti promo aggiornati");
    } catch (e) {
      console.error("Errore addPromoPoints", e);
      showToast("Impossibile aggiornare i punti", false);
    }
  }

  async function importPriceList(formData) {
    const response = await fetch(BASE_URL + "/admin/price_list/import", {
      method: "POST",
      headers: buildAuthHeaders(null),
      body: formData,
    });
    const data = await response.json();
    console.log("Price list imported successfully:", data);
    return data;
  }

  function getProductByID(productID) {
    const inPriceList = priceList.find((p) => String(p.id) === String(productID) || String(p.sku) === String(productID));
    if (inPriceList) return inPriceList;

    for (const system of offersUniverse) {
      for (const category of system.categories || []) {
        for (const sub of category.subcategories || []) {
          const found = (sub.products || []).find(
            (p) => String(p.id) === String(productID)
          );
          if (found) return found;
        }
      }
    }
    return null;
  }

  function applyDiscountToProduct(productID, discount, listino) {
    const product = getProductByID(productID);
    if (!product) return;

    product.listino = listino;
    product.discount = discount;
    updateProductDisplay(product);
  }

  function updateProductDisplay(product) {
    const priceContainer = document.querySelector(
      `#product-${product.id} .price`
    );
    const basePrice = Number(product.price || product.base_price || 0);
    const discountValue = Number(product.discount || 0);
    const finalPrice = Math.max(0, basePrice - discountValue);
    if (priceContainer) {
      priceContainer.textContent = `€${finalPrice.toFixed(2)}`;
    }
  }

  function renderStars(rating) {
    if (!rating) return "";
    const full = Math.floor(rating);
    const half = rating - full >= 0.25 && rating - full < 0.75 ? 1 : 0;
    const empty = 5 - full - half;
    return "★".repeat(full) + (half ? "☆" : "") + "✩".repeat(empty);
  }

  async function submitRegistration() {
    const payload = {
      type: document.getElementById("reg-type").value,
      name: document.getElementById("reg-name").value,
      piva: document.getElementById("reg-piva").value,
      sdi: document.getElementById("reg-sdi").value,
      regime: document.getElementById("reg-regime").value,
      address: document.getElementById("reg-address").value,
      email: document.getElementById("reg-email").value,
      phone: document.getElementById("reg-phone").value,
      source: document.getElementById("reg-source").value,
      visura: document.getElementById("reg-visura").value,
      payment_pref: document.getElementById("reg-payment").value,
      accept_terms: document.getElementById("reg-terms").checked,
    };

    if (!payload.email || !payload.accept_terms) {
      showToast("Compila email e accetta i termini.", false);
      return;
    }

    try {
      const res = await fetch(BASE_URL + "/auth/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      if (json.status === "ok") {
        currentUser.logged = true;
        currentUser.name = payload.name || payload.email;
        currentUser.tier = json.tier || "rivenditore10";
        currentUser.email = payload.email;
        updateUserUI();
        hideSheet(sheetRegister);
        showToast("Registrazione inviata. Listino assegnato dopo verifica.");
      } else {
        showToast("Errore registrazione.", false);
      }
    } catch (e) {
      showToast("Backend non raggiungibile.", false);
    }
  }

  async function submitLogin() {
    const payload = {
      email: document.getElementById("login-email").value,
      password: document.getElementById("login-password").value,
    };
    const remember = document.getElementById("login-remember").checked;
    if (!payload.email || !payload.password) {
      showToast("Email e password obbligatorie.", false);
      return;
    }

    const ADMIN_EMAIL = "god@local";
    const ADMIN_PASS = "OrmaNet!2025$Light";
    if (payload.email === ADMIN_EMAIL && payload.password === ADMIN_PASS) {
      currentUser.logged = true;
      currentUser.name = "GOD ADMIN";
      currentUser.tier = "distributore";
      currentUser.token = null;
      currentUser.email = payload.email;
      updateUserUI();
      hideSheet(sheetLogin);
      showToast("Modalità admin attiva");
      saveSessionToStorage(
        { name: currentUser.name, tier: currentUser.tier, email: payload.email },
        null,
        remember
      );
      return;
    }

    try {
      const res = await fetch(BASE_URL + "/auth/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      if (json.status === "ok") {
        currentUser.logged = true;
        currentUser.name = json.name || payload.email;
        currentUser.tier = json.tier || "rivenditore10";
        currentUser.token = json.token || null;
        currentUser.email = payload.email;
        updateUserUI();
        hideSheet(sheetLogin);
        showToast("Bentornato, " + currentUser.name);

        saveSessionToStorage(
          { name: currentUser.name, tier: currentUser.tier, email: payload.email },
          currentUser.token,
          remember
        );
      } else {
        showToast("Credenziali errate.", false);
      }
    } catch (e) {
      showToast("Backend non raggiungibile.", false);
    }
  }

  document.getElementById("btn-reg-submit").addEventListener("click", submitRegistration);
  document.getElementById("btn-login-submit").addEventListener("click", submitLogin);

  document.getElementById("btn-add-cart").addEventListener("click", () => {
    if (!currentUser.logged) {
      showToast("Registrati o fai login per usare il carrello.", false);
      return;
    }
    if (!currentEntity || currentEntityType !== "product") return;
    const qty = Math.max(1, parseInt(entityQtyInput.value || "1", 10));
    const existing = cart.find(i => i.sku === currentEntity.sku);
    if (existing) {
      existing.qty += qty;
      if (currentProductPrice) existing.price = currentProductPrice;
    } else {
      cart.push({
        sku: currentEntity.sku,
        name: currentEntity.name,
        qty,
        price: currentProductPrice || 0
      });
    }
    updateCartUI();
    showToast("Articolo aggiunto al carrello");
  });

  function checkoutCart() {
    if (!currentUser.logged) {
      showToast("Fai login prima di inviare l’ordine.", false);
      return;
    }
    if (!cart.length) {
      showToast("Il carrello è vuoto.", false);
      return;
    }
    fetch(BASE_URL + "/ecom/order_draft", {
      method: "POST",
      headers: buildAuthHeaders(),
      body: JSON.stringify({
        user_tier: currentUser.tier,
        user_name: currentUser.name,
        items: cart
      })
    }).catch(() => {});
    showToast("Richiesta ordine inviata.");
  }

  function updateCartUI() {
    btnCart.textContent = `Carrello (${cart.reduce((s,i)=>s+i.qty,0)})`;
    cartListEl.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
      const row = document.createElement("div");
      row.className = "cart-row";
      const main = document.createElement("div");
      main.className = "cart-main";
      const name = document.createElement("div");
      name.textContent = item.name;
      const sku = document.createElement("div");
      sku.className = "cart-sku";
      sku.textContent = item.sku;
      const qty = document.createElement("div");
      qty.className = "cart-qty";
      qty.textContent = `Qtà: ${item.qty}`;
      main.appendChild(name);
      main.appendChild(sku);
      main.appendChild(qty);

      const price = document.createElement("div");
      price.className = "cart-price";
      if (item.price) {
        price.textContent = (item.price * item.qty).toFixed(2) + " €";
        total += item.price * item.qty;
      } else {
        price.textContent = "—";
      }

      row.appendChild(main);
      row.appendChild(price);
      cartListEl.appendChild(row);
    });
    cartTotalEl.textContent = "Totale: " + total.toFixed(2) + " €";
  }

  function updateUserUI() {
    tierLabel.textContent = currentUser.tier;
    if (currentUser.logged) {
      document.getElementById("btn-login").textContent = "Account";
      document.getElementById("btn-logout").style.display = "inline-flex";
      document.getElementById("btn-register").style.display = "none";
      if (currentUser.name === "GOD ADMIN" && btnAdmin) {
        btnAdmin.style.display = "inline-flex";
      } else if (btnAdmin) {
        btnAdmin.style.display = "none";
      }
    } else {
      document.getElementById("btn-login").textContent = "Login";
      document.getElementById("btn-logout").style.display = "none";
      document.getElementById("btn-register").style.display = "inline-flex";
      if (btnAdmin) btnAdmin.style.display = "none";
    }
  }

  // === EDITOR PRODOTTO ===
  function parseNumber(input) {
    if (!input) return 0;
    const v = parseFloat((input.value || "").replace(",", "."));
    return isFinite(v) ? v : 0;
  }

  function formatPrice(v) {
    if (!isFinite(v)) return "";
    return v.toFixed(2) + " €";
  }

  const euroFormatter = new Intl.NumberFormat("it-IT", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 2,
  });

  function formatEuro(v) {
    if (!isFinite(v)) return "";
    return euroFormatter.format(v);
  }

  function updatePreview() {
    const html = descHtmlInput.value || "";
    descPreview.innerHTML = html;
  }

  function recalcPrices() {
    const base = parseNumber(basePriceInput);
    const mRiv10 = parseNumber(markupRiv10Input);
    const mRiv = parseNumber(markupRivInput);
    const mDist = parseNumber(markupDistInput);

    const pRiv10 = base * (1 + mRiv10 / 100);
    const pRiv = base * (1 + mRiv / 100);
    const pDist = base * (1 + mDist / 100);

    priceRiv10Output.value = base ? formatPrice(pRiv10) : "";
    priceRivOutput.value = base ? formatPrice(pRiv) : "";
    priceDistOutput.value = base ? formatPrice(pDist) : "";
  }

  function openProductEditor() {
    if (!currentUser || currentUser.name !== "GOD ADMIN") {
      showToast("Solo GOD ADMIN può modificare le schede.", false);
      return;
    }
    if (!currentEntity || currentEntityType !== "product") {
      showToast("Seleziona un prodotto nella galassia.", false);
      return;
    }

    const prod = currentEntity;
    editingProduct = prod;

    skuInput.value = prod.sku || "";
    nameInput.value = prod.name || "";
    imageHdInput.value = prod.image_hd || prod.image || "";
    imageThumbInput.value = prod.image_thumb || "";
    galleryInput.value = (prod.gallery || []).join("\n");
    descHtmlInput.value = prod.description_html || "";
    updatePreview();

    const pricing = prod.pricing || {};
    basePriceInput.value =
      pricing.base_price != null ? pricing.base_price : "";
    unitInput.value = pricing.unit || "";

    markupRiv10Input.value =
      pricing.markup_riv10 != null ? pricing.markup_riv10 : 10;
    markupRivInput.value =
      pricing.markup_riv != null ? pricing.markup_riv : 20;
    markupDistInput.value =
      pricing.markup_dist != null ? pricing.markup_dist : 0;

    recalcPrices();
    sheetProduct.style.display = "flex";
  }

  function closeProductEditor() {
    sheetProduct.style.display = "none";
    editingProduct = null;
  }

  async function saveProduct() {
    if (!editingProduct) return;
    if (!currentUser || currentUser.name !== "GOD ADMIN") {
      showToast("Solo GOD ADMIN può salvare le modifiche.", false);
      return;
    }

    const basePrice = parseNumber(basePriceInput);
    const mRiv10 = parseNumber(markupRiv10Input);
    const mRiv = parseNumber(markupRivInput);
    const mDist = parseNumber(markupDistInput);

    const pRiv10 = basePrice * (1 + mRiv10 / 100);
    const pRiv = basePrice * (1 + mRiv / 100);
    const pDist = basePrice * (1 + mDist / 100);

    editingProduct.name = nameInput.value.trim() || editingProduct.name;
    editingProduct.image_hd = imageHdInput.value.trim();
    editingProduct.image_thumb = imageThumbInput.value.trim();
    editingProduct.gallery = (galleryInput.value || "")
      .split("\n")
      .map((v) => v.trim())
      .filter(Boolean);
    editingProduct.description_html = descHtmlInput.value;

    editingProduct.pricing = {
      base_price: basePrice,
      unit: unitInput.value.trim(),
      markup_riv10: mRiv10,
      markup_riv: mRiv,
      markup_dist: mDist,
      prices: {
        rivenditore10: pRiv10,
        rivenditore: pRiv,
        distributore: pDist,
      },
    };

    const payload = {
      sku: editingProduct.sku,
      name: editingProduct.name,
      image_hd: editingProduct.image_hd,
      image_thumb: editingProduct.image_thumb,
      gallery: editingProduct.gallery,
      description_html: editingProduct.description_html,
      pricing: editingProduct.pricing,
    };

    try {
      await fetch(BASE_URL + "/ecom/product/update", {
        method: "POST",
        headers: buildAuthHeaders(),
        body: JSON.stringify(payload),
      });
      showToast("Scheda prodotto aggiornata.");
    } catch (e) {
      showToast("Scheda aggiornata in locale. Backend non raggiungibile.", false);
    }

    closeProductEditor();
  }

  if (btnEditProduct) {
    btnEditProduct.addEventListener("click", openProductEditor);
  }
  if (btnProdCancel) {
    btnProdCancel.addEventListener("click", closeProductEditor);
  }
  if (btnProdSave) {
    btnProdSave.addEventListener("click", saveProduct);
  }
  descHtmlInput.addEventListener("input", updatePreview);
  [basePriceInput, markupRiv10Input, markupRivInput, markupDistInput].forEach(
    (el) => el && el.addEventListener("input", recalcPrices)
  );

  // === UNIVERSE DATA MODEL (FAKE PER ORA) ===
  const universe = {
    name: "TheLight24 Galaxy",
    systems: offersUniverse,
  };

  // === THREE.JS SCENE ===
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xff7b00);

  const textureLoader = new THREE.TextureLoader();
  const snowflakesTexture = textureLoader.load("/assets/textures/snowflakes.png");

  const floatingTags = new Map();
  const snowflakes = [];
  let snowflakeGroup = null;

  function clearFloatingTags() {
    floatingTags.forEach((el) => el.remove());
    floatingTags.clear();
  }

  function createFloatingTagForObject(mesh, text) {
    const el = document.createElement("div");
    el.className = "floating-tag";
    el.textContent = text;
    (appEl || document.body).appendChild(el);
    floatingTags.set(mesh, el);
    return el;
  }

  function addSnowflakes() {
    if (snowflakeGroup) return;
    const snowflakeMaterial = new THREE.SpriteMaterial({
      map: snowflakesTexture,
      color: 0xffffff,
      opacity: 0.6,
    });

    snowflakeGroup = new THREE.Group();
    snowflakeGroup.userData.persistent = true;

    const snowflakeCount = 80;
    for (let i = 0; i < snowflakeCount; i++) {
      const snowflake = new THREE.Sprite(snowflakeMaterial);
      snowflake.position.set(
        Math.random() * 40 - 20,
        Math.random() * 40 - 20,
        Math.random() * 40 - 20
      );
      const scale = 0.4 + Math.random() * 0.8;
      snowflake.scale.setScalar(scale);
      snowflake.userData.velocity = 0.01 + Math.random() * 0.02;
      snowflakes.push(snowflake);
      snowflakeGroup.add(snowflake);
    }

    scene.add(snowflakeGroup);
  }

  function adjustObjectPosition() {
    objects.forEach((obj) => {
      if (obj.mesh && !obj.mesh.userData._raised) {
        obj.mesh.position.y += 2;
        obj.mesh.userData._raised = true;
      }
    });
  }

  function highlightDiscountCategory(category, mesh) {
    if (category.discountActive) {
      const glowEffect = new THREE.MeshStandardMaterial({
        color: 0x00ff00,
        emissive: 0x00ff00,
      });
      mesh.material = glowEffect;
      mesh.userData.discountTag = `Sconto attivo fino a ${category.discountDate}`;
    }
  }

  function updateFloatingTags() {
    const rect = canvas.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;

    floatingTags.forEach((el, mesh) => {
      if (!mesh || !mesh.position) return;
      const vector = new THREE.Vector3();
      mesh.getWorldPosition(vector);
      vector.project(camera);

      const x = rect.left + (vector.x * 0.5 + 0.5) * width;
      const y = rect.top + (-vector.y * 0.5 + 0.5) * height;

      el.style.left = `${x}px`;
      el.style.top = `${y - 30}px`;
    });
  }

  const camera = new THREE.PerspectiveCamera(
    60,
    window.innerWidth / window.innerHeight,
    0.1,
    100
  );
  camera.position.set(0, 3.5, 14);

  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio || 1);

  const ambient = new THREE.AmbientLight(0x1e293b, 2.2);
  scene.add(ambient);
  const mainLight = new THREE.PointLight(0xffffff, 3, 120);
  mainLight.position.set(5, 8, 12);
  scene.add(mainLight);

  const objects = [];

  function applyTextureToCube(cube, texturePath, fallbackPath = null) {
    if (!cube || !texturePath) return;

    const texture = textureLoader.load(
      texturePath,
      undefined,
      undefined,
      (err) => {
        console.error("Errore nel caricamento della texture:", texturePath, err);
        if (fallbackPath && fallbackPath !== texturePath) {
          applyTextureToCube(cube, fallbackPath, null);
        }
      }
    );

    const material = new THREE.MeshStandardMaterial({
      map: texture,
      color: 0xffffff,
      metalness: 0.3,
      roughness: 0.6,
      transparent: true,
      opacity: 1.0,
    });

    cube.material = material;
  }

  function getTexturePathForCategory(category) {
    if (!category) return null;
    if (category.texture) return category.texture;
    const id = category.id;
    if (CATEGORY_TEXTURES[id]) return CATEGORY_TEXTURES[id];

    const dashedId = id?.replace(/_/g, "-");
    if (dashedId && CATEGORY_TEXTURES[dashedId]) return CATEGORY_TEXTURES[dashedId];

    const underscoredId = id?.replace(/-/g, "_");
    if (underscoredId && CATEGORY_TEXTURES[underscoredId]) return CATEGORY_TEXTURES[underscoredId];

    return "/assets/textures/category_placeholder.png";
  }

  function updateCubeTextures() {
    objects.forEach((object) => {
      if (!object.mesh || object.mesh.type !== "Mesh") return;
      if (object.type === "category" && object.ref?.discountActive) return;

      let texturePath = null;
      switch (object.type) {
        case "category":
          texturePath = getTexturePathForCategory(object.ref);
          if (texturePath) {
            applyTextureToCube(object.mesh, texturePath, "/assets/textures/category_placeholder.png");
          }
          return;
        case "subcategory":
          texturePath = getTexturePathForCategory(object.ref);
          if (texturePath) {
            applyTextureToCube(object.mesh, texturePath, "/assets/textures/category_placeholder.png");
          }
          return;
        case "planet":
          texturePath = getTexturePathForCategory(object.ref?.category);
          if (texturePath) {
            applyTextureToCube(object.mesh, texturePath, "/assets/textures/category_placeholder.png");
          }
          return;
        case "system":
        case "system-center":
          texturePath =
            object.ref?.texture || SYSTEM_TEXTURES[object.ref?.id] || null;
          break;
        case "product":
          const prod = object.ref || {};
          const fallbackProductTexture = "/assets/textures/product_placeholder.png";
          texturePath =
            prod.image_thumb ||
            prod.image_hd ||
            (prod.sku ? `/assets/textures/products/${prod.sku}.png` : null) ||
            fallbackProductTexture;
          applyTextureToCube(object.mesh, texturePath, fallbackProductTexture);
          return;
        default:
          break;
      }

      if (texturePath) {
        applyTextureToCube(object.mesh, texturePath);
      }
    });
  }

  function addGalaxy() {
    const group = new THREE.Group();
    const starCount = 120;

    for (let i = 0; i < starCount; i++) {
      const size = 0.15;
      const geo = new THREE.BoxGeometry(size, size, size);
      const mat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        metalness: 0.1,
        roughness: 0.4
      });
      const box = new THREE.Mesh(geo, mat);
      box.position.set(
        (Math.random() - 0.5) * 40,
        (Math.random() - 0.5) * 40,
        (Math.random() - 0.5) * 40
      );
      group.add(box);
    }
    scene.add(group);
  }

  function addSystems() {
    const systemsToRender = universe.systems.length ? [universe.systems[0]] : [];
    systemsToRender.forEach((sys, idx) => {
      const size = 1.4;
      const geo = new THREE.BoxGeometry(size, size, size);

      const texPath = sys.texture || SYSTEM_TEXTURES[sys.id] || null;

      let map = null;
      if (texPath) {
        map = textureLoader.load(
          texPath,
          undefined,
          undefined,
          (err) => {
            console.error("Errore texture sistema", sys.id, texPath, err);
          }
        );
      } else {
        console.warn("Texture sistema mancante", sys.id);
      }

      const mat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        map: map || null,
        metalness: 0.3,
        roughness: 0.4
      });
      const box = new THREE.Mesh(geo, mat);
      box.position.set(sys.position.x, sys.position.y + 0.5, sys.position.z);
      scene.add(box);
      createFloatingTagForObject(box, sys.name);

      objects.push({ type: "system", ref: sys, mesh: box });
    });
  }

  function buildSystemView(system) {
    clearDynamicObjects();
    objects.length = 0;
    scene.rotation.set(0, 0, 0);
    targetRotX = 0;
    targetRotY = 0;

    const centerGeo = new THREE.BoxGeometry(1.6, 1.6, 1.6);
    const centerTexPath = system.texture || SYSTEM_TEXTURES[system.id] || null;

    let centerMap = null;
    if (centerTexPath) {
      centerMap = textureLoader.load(
        centerTexPath,
        undefined,
        undefined,
        (err) => {
          console.error("Errore texture sistema", system.id, centerTexPath, err);
        }
      );
    }
    const centerMat = new THREE.MeshStandardMaterial({
      color: 0xffffff,
      map: centerMap || null,
      metalness: 0.3,
      roughness: 0.4
    });
    const center = new THREE.Mesh(centerGeo, centerMat);
    center.position.set(0, 1.5, 0);
    scene.add(center);
    objects.push({ type: "system-center", ref: system, mesh: center });
    createFloatingTagForObject(center, system.name);

    const radiusBase = 3.2;
    const catGeo = new THREE.BoxGeometry(1.0, 1.0, 1.0);

    system.categories.forEach((cat, idx) => {
      const orbitRadius = radiusBase + idx * 1.3;

      const catTexPath = cat.texture || CATEGORY_TEXTURES[cat.id] || null;

      let catMap = null;
      if (catTexPath) {
        catMap = textureLoader.load(
          catTexPath,
          undefined,
          undefined,
          (err) => {
            console.error("Errore texture categoria", cat.id, catTexPath, err);
          }
        );
      } else {
        console.warn("Texture categoria mancante", cat.id);
      }

      const catMat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        map: catMap || null,
        metalness: 0.3,
        roughness: 0.4
      });

      const box = new THREE.Mesh(catGeo, catMat);
      const angle = (idx / system.categories.length) * Math.PI * 2;
      box.position.set(
        orbitRadius * Math.cos(angle),
        1.2,
        orbitRadius * Math.sin(angle)
      );
      scene.add(box);

      highlightDiscountCategory(cat, box);

      objects.push({ type: "category", ref: cat, mesh: box, orbitRadius, angle });
      const tagText = cat.discountActive && cat.discountDate
        ? `${cat.name} • ${cat.discountDate}`
        : cat.name;
      createFloatingTagForObject(box, tagText);

      // Satelliti per sottocategorie
      const satGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
      cat.subcategories?.forEach((sub, jdx) => {
        const subTexPath = sub.texture || CATEGORY_TEXTURES[sub.id] || null;

        let subMap = null;
        if (subTexPath) {
          subMap = textureLoader.load(
            subTexPath,
            undefined,
            undefined,
            (err) => {
              console.error("Errore texture sottocategoria", sub.id, subTexPath, err);
            }
          );
        }

        const satMat = new THREE.MeshStandardMaterial({
          color: 0xffffff,
          map: subMap || null,
          metalness: 0.3,
          roughness: 0.5
        });

        const sat = new THREE.Mesh(satGeo, satMat);
        const satAngle = angle + (jdx + 1) * 0.7;
        const satRadius = orbitRadius * 1.18;
        sat.position.set(
          satRadius * Math.cos(satAngle),
          1.2,
          satRadius * Math.sin(satAngle)
        );
        scene.add(sat);
        objects.push({ type: "subcategory", ref: sub, mesh: sat });
      });
    });
    adjustObjectPosition();
    updateCubeTextures();
  }

  function buildPlanetView(category, subcategory) {
    clearDynamicObjects();
    objects.length = 0;
    scene.rotation.set(0, 0, 0);
    targetRotX = 0;
    targetRotY = 0;

    const planetGeo = new THREE.BoxGeometry(2.0, 2.0, 2.0);
    const planetTexPath = category.texture || CATEGORY_TEXTURES[category.id] || null;

    let planetMap = null;
    if (planetTexPath) {
      planetMap = textureLoader.load(
        planetTexPath,
        undefined,
        undefined,
        (err) => {
          console.error("Errore texture categoria", category.id, planetTexPath, err);
        }
      );
    } else {
      console.warn("Texture pianeta mancante", category.id);
    }
    const planetMat = new THREE.MeshStandardMaterial({
      color: 0xffffff,
      map: planetMap || null,
      metalness: 0.3,
      roughness: 0.4
    });
    const planet = new THREE.Mesh(planetGeo, planetMat);
    planet.position.set(0, 1.5, 0);
    scene.add(planet);
    objects.push({ type: "planet", ref: { category, subcategory }, mesh: planet });

    const products = subcategory.products || [];
    const prodGeo = new THREE.BoxGeometry(0.7, 0.7, 0.7);

    products.forEach((prod, idx) => {
      let prodMap = null;
      if (prod?.sku) {
        prodMap = textureLoader.load(
          `/assets/textures/products/${prod.sku}.png`,
          undefined,
          undefined,
          (err) => {
            console.error("Errore texture prodotto", prod.sku, err);
          }
        );
      }

      const prodMat = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        map: prodMap || null,
        metalness: 0.3,
        roughness: 0.5
      });

      const satellite = new THREE.Mesh(prodGeo, prodMat);
      const ringRadius = 3.0;
      const angle = (idx / Math.max(products.length, 1)) * Math.PI * 2;
      satellite.position.set(
        ringRadius * Math.cos(angle),
        1.1,
        ringRadius * Math.sin(angle)
      );
      scene.add(satellite);
      objects.push({ type: "product", ref: prod, mesh: satellite });
    });
    adjustObjectPosition();
    updateCubeTextures();
  }

  function clearDynamicObjects() {
    const keep = [];
    scene.children.forEach(obj => {
      if (
        obj.type === "AmbientLight" ||
        obj.type === "PointLight" ||
        obj.userData?.persistent
      ) {
        keep.push(obj);
      }
    });
    scene.children.slice().forEach(obj => {
      if (!keep.includes(obj)) scene.remove(obj);
    });
    clearFloatingTags();
  }

  addGalaxy();
  addSystems();
  addSnowflakes();
  adjustObjectPosition();
  updateCubeTextures();

  // CAMERA & CONTROLS
  let isDragging = false;
  let lastX = 0;
  let lastY = 0;
  let targetRotX = 0;
  let targetRotY = 0;

  let touchStartX = 0;
  let touchStartY = 0;
  let touchMoved = false;

  function updateLabels() {
    zoomLevelLabel.textContent = "Livello: " + zoomLevel;
    locationPathLabel.textContent = "Posizione: /" + currentPath.join("/");
  }

  function resetToGalaxy() {
    clearDynamicObjects();
    addGalaxy();
    addSystems();
    updateCubeTextures();
    camera.position.set(0, 3.5, 14);
    zoomLevel = "GALASSIA";
    currentPath = [];
    currentSystem = null;
    currentCategory = null;
    currentSubcategory = null;
    currentEntity = null;
    currentEntityType = null;
    entityCard.style.display = "none";
    entityAdminActions.style.display = "none";
    scene.rotation.set(0, 0, 0);
    targetRotX = 0;
    targetRotY = 0;
    updateLabels();
  }

  function enterSystem(system) {
    currentSystem = system;
    zoomLevel = "SYSTEM";
    currentPath = [system.name];
    camera.position.set(0, 3.5, 11);
    buildSystemView(system);
    showSystemCard(system);
    updateLabels();
  }

  function enterCategory(cat) {
    if (!currentSystem) return;
    zoomLevel = "SYSTEM";
    currentCategory = cat;
    currentPath = [currentSystem.name, cat.name];
    showCategoryCard(currentSystem, cat);
    updateLabels();
  }

  function enterPlanet(cat, sub) {
    currentCategory = cat;
    currentSubcategory = sub;
    zoomLevel = "PLANET";
    currentPath = [currentSystem.name, cat.name, sub.name];
    camera.position.set(0, 4, 7.5);
    buildPlanetView(cat, sub);
    showCategoryCard(currentSystem, cat);
    updateLabels();
  }

  function focusProduct(prod) {
    currentEntity = prod;
    currentEntityType = "product";
    entityCard.style.display = "flex";
    entityTypeEl.textContent = "PRODOTTO";
    entityTitleEl.textContent = prod.name;
    entityMetaEl.textContent =
      "SKU: " + prod.sku + " • Listino: " + (currentUser.tier || "ospite");
    const imgSrc =
      prod.image_thumb ||
      prod.image_hd ||
      (prod.sku ? "/assets/textures/products/" + prod.sku + ".png" : "/assets/textures/product_placeholder.png");
    if (entityImage) {
      entityImage.src = imgSrc;
      entityImage.alt = prod.name || "prodotto";
      entityImage.onerror = () => {
        entityImage.onerror = null;
        entityImage.src = "/assets/textures/product_placeholder.png";
      };
    }
    if (entityImageWrapper) {
      entityImageWrapper.style.display = "block";
    }
    if (!currentUser.logged) {
      entityPriceEl.textContent = "Registrati per vedere il prezzo";
    } else {
      entityPriceEl.textContent = "Carico prezzo…";
    }
    entityRatingEl.textContent = prod.rating
      ? `${renderStars(prod.rating)}  (${prod.rating.toFixed(1)}/5 • ${prod.reviews || 0} recensioni)`
      : "";
    entityTagsEl.innerHTML = "";
    (prod.tags || []).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = t;
      entityTagsEl.appendChild(span);
    });

    if (currentUser.logged) {
      entityQtyWrapper.style.display = "flex";
      entityQtyInput.value = "1";
    } else {
      entityQtyWrapper.style.display = "none";
    }

    if (currentUser.name === "GOD ADMIN") {
      entityAdminActions.style.display = "flex";
    } else {
      entityAdminActions.style.display = "none";
    }

    currentProductPrice = 0;
    if (!currentUser.logged) return;

    fetch(BASE_URL + "/ecom/pricing", {
      method: "POST",
      headers: buildAuthHeaders(),
      body: JSON.stringify({
        sku: prod.sku,
        base_price: prod.base_price || prod.price || 0,
        offer_id: (prod.extra || {}).offer_id,
        customer_segment: currentUser.tier,
        quantity: 1
      })
    })
      .then(r => r.json())
      .then(json => {
        if (json && typeof json.price !== "undefined") {
          currentProductPrice = Number(json.price);
          entityPriceEl.textContent = currentProductPrice.toFixed(2) + " €";
        } else {
          entityPriceEl.textContent = "Prezzo non disponibile";
        }
      })
      .catch(() => {
        entityPriceEl.textContent = "Errore prezzo";
      });
  }

  function showSystemCard(system) {
    currentEntity = system;
    currentEntityType = "system";
    entityCard.style.display = "flex";
    if (entityImageWrapper) entityImageWrapper.style.display = "none";
    entityTypeEl.textContent = "SISTEMA E-COMMERCE";
    entityTitleEl.textContent = system.name;
    entityMetaEl.textContent = "Nodi: categorie " + (system.categories?.length || 0);
    entityRatingEl.textContent = system.rating
      ? `${renderStars(system.rating)}  (${system.rating.toFixed(1)}/5 • ${system.reviews || 0} recensioni B2B)`
      : "";
    entityTagsEl.innerHTML = "";
    (system.tags || []).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = t;
      entityTagsEl.appendChild(span);
    });
    entityPriceEl.textContent = "";
    entityQtyWrapper.style.display = "none";
    entityAdminActions.style.display = "none";
    if (entityOfferBox) entityOfferBox.style.display = "none";
  }

  function findOfferTitle(offerId) {
    const offer = offersUniverse.find((o) => o.id === offerId);
    return offer?.title || offer?.name || offerId;
  }

  function findDiscountConfig(offerId) {
    return discountConfigs.find((c) => c.id === offerId);
  }

  function formatDateLabel(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return dateStr;
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  function getLatestValidUntil(rules = []) {
    let best = null;
    rules.forEach((r) => {
      if (!r.valid_until) return;
      const d = new Date(r.valid_until);
      if (Number.isNaN(d.getTime())) return;
      if (!best || d > best) best = d;
    });
    return best ? best.toISOString().slice(0, 10) : null;
  }

  function renderDiscountSimulator(cat) {
    if (!entityOfferBox) return;
    const offerId = cat.offerId || cat.id;
    const cfg = findDiscountConfig(offerId);

    discountSimInput.value = "";
    discountSimOutput.textContent = "";

    if (!cfg) {
      entityOfferBox.style.display = "none";
      return;
    }

    entityOfferBox.style.display = "flex";
    entityOfferTitle.textContent = `${cat.name} – Box regalo`;
    entityOfferGift.textContent = `Box regalo dedicato collegato a ${findOfferTitle(offerId)}.`;

    const segment = currentUser?.tier || "ospite";
    const rules = (cfg.rules && cfg.rules[segment]) || [];
    const expiry = getLatestValidUntil(rules);
    const expiryLabel = formatDateLabel(expiry);
    discountSimLabel.textContent =
      `Dimmi quanto vuoi spendere nel tuo prossimo ordine e ti dico quanto risparmi fino al ${expiryLabel}`;

    if (!currentUser.logged) {
      discountSimInput.disabled = true;
      discountSimOutput.textContent = "Accedi per vedere il tuo risparmio";
      return;
    }

    discountSimInput.disabled = false;
    if (!rules.length) {
      discountSimOutput.textContent = "Nessuna fascia configurata per il tuo listino.";
      discountSimInput.oninput = null;
      discountSimInput.onchange = null;
      return;
    }

    const computeSim = () => {
      const amount = parseFloat(discountSimInput.value || "0");
      if (!amount || !isFinite(amount)) {
        discountSimOutput.textContent = "";
        return;
      }
      const rule = rules.find((r) => amount >= r.min && amount <= (r.max === Infinity ? amount : r.max));
      if (!rule) {
        discountSimOutput.textContent = "Importo non rientra in nessuna fascia configurata.";
        return;
      }
      const saved = amount * (rule.discount / 100);
      const final = amount - saved;
      discountSimOutput.textContent =
        `Con un ordine di ${formatEuro(amount)} risparmi ${rule.discount}% = ${formatEuro(saved)} (paghi ${formatEuro(final)})`;
    };

    discountSimInput.oninput = computeSim;
    discountSimInput.onchange = computeSim;
  }

  function showCategoryCard(system, cat) {
    currentEntity = cat;
    currentEntityType = "category";
    entityCard.style.display = "flex";
    if (entityImageWrapper) entityImageWrapper.style.display = "none";
    entityTypeEl.textContent = "CATEGORIA";
    entityTitleEl.textContent = cat.name;
    const subs = cat.subcategories?.length || 0;
    entityMetaEl.textContent = `${system.name} • ${subs} sottocategorie`;
    entityRatingEl.textContent = "";
    entityTagsEl.innerHTML = "";
    (cat.tags || []).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = t;
      entityTagsEl.appendChild(span);
    });
    entityPriceEl.textContent = "";
    entityQtyWrapper.style.display = "none";
    entityAdminActions.style.display = "none";
    renderDiscountSimulator(cat);
    const promoClient = getCurrentClientRecord();
    if (currentUser.logged && promoClient?.promo_enabled && entityOfferBox && entityOfferGift) {
      const promoMsg = "Promo Natale attiva: accumuli punti con questa categoria. Controlla il tuo biglietto regalo nel pacco.";
      entityOfferBox.style.display = "flex";
      if (!entityOfferGift.textContent.includes("Promo Natale")) {
        entityOfferGift.textContent = `${entityOfferGift.textContent ? entityOfferGift.textContent + " " : ""}${promoMsg}`;
      }
    }
  }

  function raycastFromTap(x, y) {
    const mouse = new THREE.Vector2(
      (x / window.innerWidth) * 2 - 1,
      -(y / window.innerHeight) * 2 + 1
    );
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    const meshes = objects.map(o => o.mesh);
    const hits = raycaster.intersectObjects(meshes, true);
    if (hits.length === 0) return;

    const hit = hits[0].object;
    const obj = objects.find(o => o.mesh === hit || o.mesh === hit.parent);
    if (!obj) return;

    if (obj.type === "system") {
      enterSystem(obj.ref);
      return;
    }
    if (obj.type === "category") {
      enterCategory(obj.ref);
      return;
    }
    if (obj.type === "subcategory") {
      const cat = currentSystem.categories.find(c => c.subcategories.includes(obj.ref));
      if (cat) enterPlanet(cat, obj.ref);
      return;
    }
    if (obj.type === "product") {
      focusProduct(obj.ref);
      return;
    }
  }

  function goUpOneLevel() {
    if (zoomLevel === "PLANET" && currentSystem) {
      zoomLevel = "SYSTEM";
      currentSubcategory = null;
      camera.position.set(0, 3, 11);
      buildSystemView(currentSystem);
      showSystemCard(currentSystem);
      updateLabels();
      return;
    }
    if (zoomLevel === "SYSTEM") {
      resetToGalaxy();
      return;
    }
  }

  // Mouse handlers
  canvas.addEventListener("mousedown", (e) => {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
  });

  canvas.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    targetRotY += dx * 0.005;
    targetRotX += dy * 0.005;
  });

  canvas.addEventListener("mouseup", () => { isDragging = false; });
  canvas.addEventListener("mouseleave", () => { isDragging = false; });

  canvas.addEventListener("click", (e) => {
    raycastFromTap(e.clientX, e.clientY);
  });

  // Touch handlers
  canvas.addEventListener("touchstart", (e) => {
    if (e.touches.length === 1) {
      const t = e.touches[0];
      isDragging = true;
      lastX = t.clientX;
      lastY = t.clientY;
      touchStartX = t.clientX;
      touchStartY = t.clientY;
      touchMoved = false;
    }
  });

  canvas.addEventListener("touchmove", (e) => {
    if (!isDragging || e.touches.length !== 1) return;
    const t = e.touches[0];
    const dx = t.clientX - lastX;
    const dy = t.clientY - lastY;
    lastX = t.clientX;
    lastY = t.clientY;

    if (Math.abs(t.clientX - touchStartX) > 5 || Math.abs(t.clientY - touchStartY) > 5) {
      touchMoved = true;
    }

    targetRotY += dx * 0.005;
    targetRotX += dy * 0.005;
  });

  canvas.addEventListener("touchend", () => {
    isDragging = false;
    if (!touchMoved) {
      raycastFromTap(touchStartX, touchStartY);
    }
  });

  canvas.addEventListener("wheel", (e) => {
    e.preventDefault();
    const delta = e.deltaY;
    camera.position.z += delta * 0.01;
    camera.position.z = Math.min(Math.max(camera.position.z, 4), 30);
    if (camera.position.z > 18 && zoomLevel !== "GALASSIA") {
      resetToGalaxy();
    }
  }, { passive: false });

  function animate() {
    requestAnimationFrame(animate);
    scene.rotation.y += 0.0006;
    scene.rotation.x += 0.00015;

    scene.rotation.y += (targetRotY - scene.rotation.y) * 0.08;
    scene.rotation.x += (targetRotX - scene.rotation.x) * 0.08;

    snowflakes.forEach((snowflake) => {
      snowflake.position.y -= snowflake.userData.velocity || 0.01;
      if (snowflake.position.y < -20) snowflake.position.y = 20;
    });

    renderer.render(scene, camera);
    updateFloatingTags();
  }
  animate();

  window.addEventListener("resize", () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
  });

  // Pulsante INDIETRO: chiude sheet aperti, reset se non c'è history
  btnBack.addEventListener("click", () => {
    const anySheetOpen = [
      sheetRegister, sheetLogin, sheetCart, sheetProduct, sheetLlm
    ].some(el => el.style.display === "flex");
    if (anySheetOpen) {
      [sheetRegister, sheetLogin, sheetCart, sheetProduct, sheetLlm]
        .forEach(el => el.style.display = "none");
      return;
    }
    if (window.history.length > 1) {
      window.history.back();
    } else {
      resetToGalaxy();
    }
  });

  // LLM CHAT FRONTEND
  function appendLlmMessage(role, text) {
    const div = document.createElement("div");
    div.className = "llm-msg " + (role === "user" ? "user" : "bot");
    div.textContent = text;
    llmLog.appendChild(div);
    llmLog.scrollTop = llmLog.scrollHeight;
  }

  async function sendLlmMessage() {
    const text = (llmInput.value || "").trim();
    if (!text) return;
    llmInput.value = "";
    appendLlmMessage("user", text);
    llmStatus.textContent = "Il modello sta pensando...";

    const systemPrompt =
      "Sei un assistente AI locale, integrato nella GUI TheLight24 Universe. " +
      "Rispondi SEMPRE in italiano, in massimo 3 frasi brevi. " +
      "Se ti viene chiesto di prodotti, ragiona come assistente B2B e-commerce.";

    const fullPrompt = systemPrompt + "\n\nUtente: " + text + "\nAssistente:";

    try {
      const res = await fetch(LLM_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          prompt: fullPrompt,
          n_predict: 96,
          temperature: 0.7,
          top_k: 40,
          top_p: 0.9,
          stop: ["Utente:", "User:", "Assistente:", "Assistant:"]
        })
      });
      const json = await res.json();
      const out = json.content || json.generated_text || json.completion || JSON.stringify(json);
      appendLlmMessage("bot", out.trim());
      llmStatus.textContent = "";
    } catch (e) {
      llmStatus.textContent = "Errore chiamata modello locale.";
      appendLlmMessage("bot", "Non riesco a contattare il modello locale. Verifica che llama-server sia attivo su 127.0.0.1:8081.");
    }
  }

  btnOpenLlm.addEventListener("click", () => {
    showSheet(sheetLlm);
    llmInput.focus();
  });
  btnLlmClose.addEventListener("click", () => hideSheet(sheetLlm));
  btnLlmSend.addEventListener("click", sendLlmMessage);
  llmInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendLlmMessage();
    }
  });

  async function bootstrapUniverse() {
    try {
      restoreSessionFromStorage();
      const authHeaders = buildAuthHeaders();
      const [offersRes, clientsRes, productsRes] = await Promise.all([
        fetch(BASE_URL + "/admin/offers/all", { headers: authHeaders }),
        fetch(BASE_URL + "/admin/clients/all", { headers: authHeaders }),
        fetch(BASE_URL + "/admin/products/all", { headers: authHeaders })
      ]);

      const offersJson = await offersRes.json();
      const clientsJson = await clientsRes.json();
      const productsJson = await productsRes.json();

      discountConfigs = (offersJson.configs || []).map((cfg) => {
        const normalized = { ...cfg, rules: {} };
        Object.entries(cfg.rules || {}).forEach(([seg, rules]) => {
          normalized.rules[seg] = (rules || []).map((r) => ({
            ...r,
            max: r.max === null ? Infinity : r.max
          }));
        });
        return normalized;
      });
      clients = clientsJson.clients || [];
      priceList = productsJson.products || [];

      renderDiscountPreview();
      renderClientsTable();
      refreshPromoClientsSelect();
    } catch (e) {
      console.error("Errore bootstrapUniverse", e);
    } finally {
      updateUserUI();
      ensureDiscountSelectFilled();
      fillClientForm();
      switchAdminTab("clients");
      updateLabels();
    }
  }

  // EXPORT MINIMO
  window.TheLightUniverse = {
    getCurrentProduct: () => (currentEntityType === "product" ? currentEntity : null),
    getCurrentUser: () => currentUser,
    showToast,
    BASE_URL,
    openProductEditor
  };
  bootstrapUniverse();
</script>
</body>
</html>
