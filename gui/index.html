<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>TheLight24 Universe – B2B Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #020617, #000);
      color: #e5e7eb;
      overflow: hidden;
      height: 100dvh;
    }
    #app {
      position: relative;
      width: 100vw;
      height: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
    }
    #universe-canvas {
      position: absolute;
      inset: 0;
      touch-action: none;
    }

    /* Top bar */
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, rgba(15,23,42,0.95), rgba(15,23,42,0.0));
      z-index: 20;
      gap: 6px;
      flex-wrap: wrap;
    }
    #brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    #brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    #brand-sub {
      font-size: 10px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }
    #top-bar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
      flex-wrap: wrap;
    }
    #user-panel {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
    }
    .pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.85);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .pill span.label { opacity: 0.7; }
    .btn {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 0;
      color: #e5e7eb;
      background: #2563eb;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.secondary {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.6);
    }
    .btn:active { transform: scale(0.97); }

    @media (max-width: 480px) {
      #top-bar {
        padding: 4px 6px;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      #brand-title { font-size: 11px; }
      #brand-sub { display: none; }
      #top-bar-right {
        gap: 6px;
        width: 100%;
        justify-content: space-between;
      }
      #user-panel {
        gap: 4px;
        flex: 1 1 auto;
        justify-content: flex-start;
      }
      #btn-cart, #btn-login, #btn-register, #btn-back, #btn-chat-ai {
        padding-inline: 6px;
        font-size: 10px;
      }
      #tier-pill { display: none; }
      #global-controls {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Top-right controls (Indietro + Chat AI) */
    #global-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Bottom info panel */
    #info-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px;
      z-index: 15;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: linear-gradient(to top, rgba(15,23,42,0.98), rgba(15,23,42,0.0));
    }
    #zoom-level { font-size: 11px; opacity: 0.8; }
    #location-path { font-size: 11px; opacity: 0.9; }
    #hint { font-size: 10px; opacity: 0.7; }
    #entity-card {
      margin-top: 4px;
      background: rgba(15,23,42,0.97);
      border-radius: 14px;
      padding: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      display: none;
      flex-direction: column;
      gap: 4px;
    }
    #entity-type {
      font-size: 10px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    #entity-title { font-size: 12px; font-weight: 600; }
    #entity-meta { font-size: 10px; opacity: 0.85; }
    #entity-rating { font-size: 11px; }
    #entity-price-line {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #entity-price {
      font-size: 13px;
      font-weight: 600;
      color: #22c55e;
    }
    #entity-qty {
      width: 60px;
      border-radius: 999px;
      padding: 3px 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
    }
    #entity-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    .tag {
      border-radius: 999px;
      font-size: 9px;
      padding: 2px 6px;
      background: rgba(30,64,175,0.4);
      border: 1px solid rgba(96,165,250,0.5);
    }
    #entity-admin-actions {
      display: none;
      justify-content: flex-end;
      margin-top: 4px;
    }

    /* Floating nav buttons */
    #nav-buttons {
      position: absolute;
      right: 8px;
      bottom: 88px;
      z-index: 16;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .icon-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.92);
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .icon-btn span { font-size: 13px; }

    /* Modal / sheets */
    .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
    }
    .sheet {
      width: 100%;
      max-height: 88dvh;
      background: #020617;
      border-radius: 18px 18px 0 0;
      padding: 10px 14px 14px;
      border: 1px solid #1f2937;
      overflow-y: auto;
    }
    .sheet h2 {
      font-size: 14px;
      margin: 0 0 4px;
    }
    .sheet p {
      font-size: 11px;
      margin: 0 0 8px;
      opacity: 0.8;
    }
    .field {
      margin-bottom: 6px;
    }
    .field label {
      font-size: 11px;
      display: block;
      margin-bottom: 2px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .field textarea {
      min-height: 60px;
      resize: vertical;
    }
    .field small {
      font-size: 9px;
      opacity: 0.6;
    }
    .sheet-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .two-cols {
      display: flex;
      gap: 8px;
    }
    .two-cols .field { flex: 1; }
    @media (max-width: 640px) {
      .two-cols { flex-direction: column; }
    }

    .html-preview {
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 6px 8px;
      font-size: 11px;
      background: #020617;
      max-height: 160px;
      overflow-y: auto;
    }

    /* Cart */
    #cart-list {
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }
    .cart-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(31,41,55,0.8);
    }
    .cart-main { flex: 1; }
    .cart-sku { font-size: 9px; opacity: 0.6; }
    .cart-qty { font-size: 10px; opacity: 0.8; }
    .cart-price { font-size: 11px; font-weight: 600; }
    #cart-total {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      text-align: right;
    }

    #toast {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22,163,74,0.9);
      color: #ecfdf5;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
      z-index: 60;
    }

    /* Chat log */
    .chat-log {
      border-radius: 8px;
      border: 1px solid #374151;
  background: #020617;
  padding: 8px;
  font-size: 11px;
  max-height: 260px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 8px;
}

.chat-msg {
  padding: 6px 8px;
  border-radius: 8px;
  max-width: 100%;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.chat-user {
  align-self: flex-end;
  background: rgba(37, 99, 235, 0.7);
}

.chat-assistant {
  align-self: flex-start;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid #1f2937;
}

.chat-system {
  align-self: center;
  background: transparent;
  color: #9ca3af;
  font-size: 10px;
}

#llm-status-row {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 6px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 10px;
  border: 1px solid rgba(148,163,184,0.4);
  background: rgba(15,23,42,0.85);
  color: #e5e7eb;
}

.status-idle {
  border-color: rgba(148,163,184,0.4);
  background: rgba(148,163,184,0.15);
}

.status-pending {
  border-color: rgba(234,179,8,0.5);
  background: rgba(234,179,8,0.15);
  color: #facc15;
}

.status-ok {
  border-color: rgba(34,197,94,0.5);
  background: rgba(34,197,94,0.15);
  color: #4ade80;
}

.status-error {
  border-color: rgba(248,113,113,0.6);
  background: rgba(248,113,113,0.12);
  color: #fecdd3;
}
  </style>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
</head>
<body>
<div id="app">
  <canvas id="universe-canvas"></canvas>

  <!-- TOP BAR -->
  <div id="top-bar">
    <div id="brand">
      <div id="brand-title">THELIGHT24 UNIVERSE</div>
      <div id="brand-sub">Galaxy of Shops • Touch to navigate</div>
    </div>
    <div id="top-bar-right">
      <div id="user-panel">
        <div class="pill" id="tier-pill">
          <span class="label">Listino:</span>
          <span id="tier-label">ospite</span>
        </div>
        <button class="btn secondary" id="btn-cart">Carrello (0)</button>
        <button class="btn secondary" id="btn-login">Login</button>
        <button class="btn" id="btn-register">Registrati</button>
      </div>
      <!-- TOP RIGHT: INDIETRO + CHAT AI -->
      <!-- CONTROLLI GLOBALI (sempre visibili) -->
      <div id="global-controls">
        <button class="btn secondary" id="btn-back">← Indietro</button>
        <button class="btn" id="btn-chat-ai">✦ Chat AI</button>
      </div>
    </div>
  </div>

  <!-- BOTTOM PANEL -->
  <div id="info-panel">
    <div id="zoom-level">Livello: GALASSIA</div>
    <div id="location-path">Posizione: /</div>
    <div id="hint">Pinch/zoom o tap per esplorare. Tocca sistemi, stelle, pianeti e satelliti per scendere di livello.</div>

    <div id="entity-card">
      <div id="entity-type"></div>
      <div id="entity-title"></div>
      <div id="entity-meta"></div>
      <div id="entity-rating"></div>
      <div id="entity-price-line">
        <div id="entity-price"></div>
        <div id="entity-qty-wrapper" style="display:none; align-items:center; gap:4px;">
          <span style="font-size:10px;opacity:0.7;">Qtà</span>
          <input id="entity-qty" type="number" min="1" step="1" value="1" />
          <button class="btn" id="btn-add-cart" style="font-size:10px;padding-inline:8px;">+ Carrello</button>
        </div>
      </div>
      <div id="entity-tags"></div>
      <div id="entity-admin-actions">
        <button class="btn secondary" id="btn-edit-product" style="font-size:10px;padding-inline:8px;">Modifica scheda</button>
      </div>
    </div>
  </div>

  <!-- FLOATING NAV BUTTONS -->
  <div id="nav-buttons">
    <button class="icon-btn" id="btn-up">
      <span>↑</span><span>Livello su</span>
    </button>
  </div>

  <!-- MODAL: REGISTRAZIONE -->
  <div class="backdrop" id="sheet-register">
    <div class="sheet">
      <h2>Registrazione B2B / B2C</h2>
      <p>Per vedere i prezzi devi creare un account. Dopo la verifica ti assegneremo il listino commerciale più adatto al tuo profilo.</p>

      <div class="field">
        <label>Sei un’azienda o un privato?</label>
        <select id="reg-type">
          <option value="azienda">Azienda</option>
          <option value="privato">Privato</option>
        </select>
      </div>

      <div class="field">
        <label>Ragione sociale / Nome completo</label>
        <input id="reg-name" placeholder="Es. Ormanet S.r.l. / Mario Rossi" />
      </div>

      <div class="field">
        <label>Partita IVA</label>
        <input id="reg-piva" placeholder="ITXXXXXXXXXXX" />
        <small>Obbligatoria per aziende. Per privati puoi lasciare vuoto.</small>
      </div>

      <div class="field">
        <label>Codice SDI / PEC</label>
        <input id="reg-sdi" placeholder="Codice destinatario o PEC" />
      </div>

      <div class="field">
        <label>Regime fiscale</label>
        <select id="reg-regime">
          <option value="ordinario">Ordinario</option>
          <option value="forfettario">Forfettario</option>
          <option value="minimi">Regime dei minimi</option>
          <option value="privato">Privato / no P.IVA</option>
        </select>
      </div>

      <div class="field">
        <label>Indirizzo completo attività</label>
        <textarea id="reg-address" placeholder="Via, numero civico, CAP, città, provincia, nazione"></textarea>
      </div>

      <div class="field">
        <label>Email</label>
        <input id="reg-email" type="email" placeholder="esempio@azienda.it" />
      </div>

      <div class="field">
        <label>Telefono / WhatsApp</label>
        <input id="reg-phone" placeholder="+39…" />
      </div>

      <div class="field">
        <label>Come ci hai conosciuti?</label>
        <input id="reg-source" placeholder="Google, passaparola, Amazon, fiera, agente, ecc." />
      </div>

      <div class="field">
        <label>Link o note visura camerale</label>
        <textarea id="reg-visura" placeholder="URL alla visura o note (es. allegata via email, disponibile su richiesta)."></textarea>
      </div>

      <div class="field">
        <label>Metodo di pagamento preferito</label>
        <select id="reg-payment">
          <option value="bonifico">Bonifico bancario (default)</option>
          <option value="contrassegno">Contrassegno</option>
          <option value="carta">Carta / POS virtuale</option>
          <option value="altro">Altro (da concordare)</option>
        </select>
      </div>

      <div class="field">
        <label>
          <input type="checkbox" id="reg-terms" />
          Accetto termini & condizioni, informativa privacy e condizioni di pagamento.
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-reg-cancel">Annulla</button>
        <button class="btn" id="btn-reg-submit">Crea account</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGIN -->
  <div class="backdrop" id="sheet-login">
    <div class="sheet">
      <h2>Login</h2>
      <p>Accedi con la tua email e la password impostata dopo l’attivazione account.</p>

      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="login-password" type="password" />
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-login-cancel">Annulla</button>
        <button class="btn" id="btn-login-submit">Entra</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CARRELLO -->
  <div class="backdrop" id="sheet-cart">
    <div class="sheet">
      <h2>Carrello</h2>
      <p>Riepilogo articoli selezionati. L’ordine viene inviato come richiesta al reparto commerciale.</p>

      <div id="cart-list"></div>
      <div id="cart-total">Totale: 0,00 €</div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-cart-clear">Svuota</button>
        <button class="btn" id="btn-cart-checkout">Invia richiesta</button>
      </div>
    </div>
  </div>

<!-- MODAL: CHAT LLM -->
  <div class="backdrop" id="sheet-chat-ai">
    <div class="sheet">
      <h2>Chat AI locale</h2>
      <p>Assistente LLM locale. Avvia <code>start_thelight.sh</code> per caricare il modello sulla porta 8081.</p>

      <div id="llm-status-row">
        <span id="llm-status" class="status-badge status-idle">In attesa di connessione al modello locale…</span>
      </div>

      <div id="chat-log" class="chat-log">
        <!-- messaggi -->
      </div>

      <div class="field">
        <label>Messaggio</label>
        <textarea id="chat-input" placeholder="Scrivi qui la tua domanda..."></textarea>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-chat-close">Chiudi</button>
        <button class="btn" id="btn-chat-send">Invia</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PRODUCT EDITOR -->
  <div class="backdrop" id="sheet-product-editor">
    <div class="sheet">
      <h2>Editor scheda prodotto</h2>
      <p>Modifica contenuti, immagini HD e listini partendo dal listino madre.</p>

      <div class="two-cols">
        <div class="field">
          <label>SKU (bloccato)</label>
          <input id="prod-sku" readonly />
        </div>
        <div class="field">
          <label>Nome prodotto</label>
          <input id="prod-name" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>URL immagine HD principale</label>
          <input id="prod-image-hd" placeholder="https://..." />
        </div>
        <div class="field">
          <label>URL immagine thumbnail</label>
          <input id="prod-image-thumb" placeholder="https://..." />
        </div>
      </div>

      <div class="field">
        <label>Gallery immagini (una URL per riga)</label>
        <textarea id="prod-gallery" placeholder="https://img1...\nhttps://img2..."></textarea>
      </div>

      <div class="field">
        <label>Descrizione HTML (sorgente)</label>
        <textarea id="prod-desc-html" placeholder="<h2>Caratteristiche</h2>..."></textarea>
      </div>
      <div class="field">
        <label>Preview descrizione</label>
        <div id="prod-desc-preview" class="html-preview"></div>
      </div>

      <h2>Listini & ricarichi</h2>
      <p>Imposta il listino madre e le % di ricarico per i listini figli. I prezzi vengono ricalcolati automaticamente.</p>

      <div class="two-cols">
        <div class="field">
          <label>Prezzo listino madre (base)</label>
          <input id="prod-base-price" type="number" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Unità di misura (solo nota)</label>
          <input id="prod-unit" placeholder="es. pz, risma, conf, kg" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore +10%"</label>
          <input id="prod-markup-riv10" type="number" step="0.1" />
          <small>Es. 10 = +10% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore +10%</label>
          <input id="prod-price-riv10" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore"</label>
          <input id="prod-markup-riv" type="number" step="0.1" />
          <small>Es. 20 = +20% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore</label>
          <input id="prod-price-riv" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "distributore"</label>
          <input id="prod-markup-dist" type="number" step="0.1" />
          <small>Puoi anche usare valori negativi per sconti (-5 = -5%).</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato distributore</label>
          <input id="prod-price-dist" type="text" readonly />
        </div>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-prod-cancel">Annulla</button>
        <button class="btn" id="btn-prod-save">Salva scheda</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>
</div>

<script>
  // ================== CONFIG ==================
  const BASE_URL = window.location.origin || "http://127.0.0.1:8080";
  const LLM_URL  = `${BASE_URL}/api/llm/chat`;

  // ================== STATO BASE ==================
  let currentUser = {
    logged: false,
    tier: "ospite",
    name: null,
  };

  let zoomLevel = "GALASSIA";
  let currentPath = [];
  let currentEntity = null;
  let currentEntityType = null;
  let cart = [];
  let currentProductPrice = 0;

  // ================== DOM ELEMENTS ==================
  const canvas              = document.getElementById("universe-canvas");
  const tierLabel           = document.getElementById("tier-label");
  const zoomLevelLabel      = document.getElementById("zoom-level");
  const locationPathLabel   = document.getElementById("location-path");
  const toast               = document.getElementById("toast");
  const entityCard          = document.getElementById("entity-card");

  const sheetRegister       = document.getElementById("sheet-register");
  const sheetLogin          = document.getElementById("sheet-login");
  const sheetCart           = document.getElementById("sheet-cart");
  const sheetProduct        = document.getElementById("sheet-product-editor");
  const sheetChat           = document.getElementById("sheet-chat-ai");

  const btnBack             = document.getElementById("btn-back");
  const btnCart             = document.getElementById("btn-cart");
  const btnLogin            = document.getElementById("btn-login");
  const btnRegister         = document.getElementById("btn-register");

  const btnChat             = document.getElementById("btn-chat-ai");
  const btnChatClose        = document.getElementById("btn-chat-close");
  const btnChatSend         = document.getElementById("btn-chat-send");
  const chatInput           = document.getElementById("chat-input");
  const chatLog             = document.getElementById("chat-log");
  const chatStatus          = document.getElementById("chat-status");

  // ================== UTILS UI ==================
  function showSheet(el) {
    if (!el) return;
    el.style.display = "flex";
  }

  function hideSheet(el) {
    if (!el) return;
    el.style.display = "none";
  }

  function showToast(message, ms = 2000) {
    if (!toast) return;
    toast.textContent = message;
    toast.style.display = "block";
    setTimeout(() => {
      toast.style.display = "none";
    }, ms);
  }

  function updateLabels() {
    if (zoomLevelLabel) {
      zoomLevelLabel.textContent = `Livello: ${zoomLevel}`;
    }
    const pathStr = currentPath.length ? "/" + currentPath.join(" / ") : "/";
    if (locationPathLabel) {
      locationPathLabel.textContent = `Posizione: ${pathStr}`;
    }
  }

  function updateUserUI() {
    if (tierLabel) {
      tierLabel.textContent = currentUser.tier || "ospite";
    }
  }

  function resetToGalaxy() {
    zoomLevel = "GALASSIA";
    currentPath = [];
    currentEntity = null;
    currentEntityType = null;
    if (entityCard) entityCard.style.display = "none";
    updateLabels();
  }

  // ================== CHAT UI ==================
  function appendChatMessage(role, text) {
    if (!chatLog) return;
    const div = document.createElement("div");
    div.classList.add("chat-msg");

    if (role === "user") {
      div.classList.add("chat-user");
    } else if (role === "assistant") {
      div.classList.add("chat-assistant");
    } else {
      div.classList.add("chat-system");
    }

    div.textContent = text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function setChatStatus(state) {
    if (!chatStatus) return;
    chatStatus.classList.remove("status-idle", "status-pending", "status-sent");
    if (state === "pending") {
      chatStatus.textContent = "Pending";
      chatStatus.classList.add("status-pending");
    } else if (state === "sent") {
      chatStatus.textContent = "Inviato";
      chatStatus.classList.add("status-sent");
    } else {
      chatStatus.textContent = "Non inviato";
      chatStatus.classList.add("status-idle");
    }
  }

  async function sendChatMessage() {
    if (!chatInput) return;
    const text = chatInput.value.trim();
    if (!text) return;

    chatInput.value = "";
    appendChatMessage("user", text);
    setChatStatus("pending");

    const payload = {
      prompt: `Sei un assistente AI locale, integrato nella GUI TheLight24 Universe. Rispondi in italiano.\n\nUtente: ${text}\nAssistente:`,
      n_predict: 256,
      temperature: 0.7,
      top_k: 40,
      top_p: 0.9
    };

    try {
      const res = await fetch(LLM_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      let reply = "";
      if (data && typeof data.content === "string") {
        reply = data.content;
      } else {
        reply = JSON.stringify(data, null, 2);
      }

      if (!reply) {
        reply = "[Nessuna risposta dal modello]";
      }

      appendChatMessage("assistant", String(reply).trim());
      setChatStatus("sent");
    } catch (e) {
      appendChatMessage("system", "Errore nel contattare il modello su 127.0.0.1:8081");
      setChatStatus("idle");
    }
  }

  // ================== EVENT LISTENERS ==================

  // Apertura modale Chat AI
  if (btnChat && sheetChat) {
    btnChat.addEventListener("click", () => {
      showSheet(sheetChat);
      setChatStatus("idle");
      if (chatInput) chatInput.focus();
    });
  }

  // Chiusura modale Chat AI
  if (btnChatClose && sheetChat) {
    btnChatClose.addEventListener("click", () => {
      hideSheet(sheetChat);
    });
  }

  // Invia da bottone
  if (btnChatSend) {
    btnChatSend.addEventListener("click", sendChatMessage);
  }

  // Invia con Invio
  if (chatInput) {
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });
  }

  // Bottone "Indietro" globale: chiude tutte le modali e resetta mappa
  function globalBack() {
    [sheetRegister, sheetLogin, sheetCart, sheetProduct, sheetChat].forEach(el => {
      if (el) el.style.display = "none";
    });
    if (entityCard) entityCard.style.display = "none";
    resetToGalaxy();
  }

  if (btnBack) {
    btnBack.addEventListener("click", globalBack);
  }

  // ================== EXPORT MINIMO ==================
  window.TheLightUniverse = {
    getCurrentProduct: () => (currentEntityType === "product" ? currentEntity : null),
    getCurrentUser: () => currentUser,
    showToast,
    BASE_URL
  };

  // Init UI base
  updateUserUI();
  updateLabels();
</script>
</body>
</html>
