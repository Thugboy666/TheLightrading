<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>TheLightrading â€“ Seed AI Universe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: dark;
      --bg: radial-gradient(circle at 20% 20%, #0a2540, #050b16 60%);
      --panel: rgba(10, 20, 40, 0.88);
      --accent: #7bd7ff;
      --accent-2: #9af5ff;
      --text: #e8f2ff;
      --muted: #9cb5d1;
      --danger: #ff7a7a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      min-height: 100vh;
    }
    #app {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #universe-canvas {
      position: absolute;
      inset: 0;
      touch-action: none;
      z-index: 0;
    }
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: linear-gradient(90deg, rgba(10,20,40,0.8), rgba(10,20,40,0.25));
      backdrop-filter: blur(12px);
      z-index: 10;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .brand {
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .brand span {
      font-size: 14px;
      color: var(--muted);
    }
    #create-node-btn {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(120deg, rgba(123,215,255,0.25), rgba(10,20,40,0.5));
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 8px 30px rgba(0,0,0,0.35);
    }
    #side-panel {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: min(420px, 95vw);
      background: var(--panel);
      backdrop-filter: blur(16px);
      border-left: 1px solid rgba(255,255,255,0.08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 12;
      box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    }
    #side-panel header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 8px;
    }
    .node-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    .node-hash {
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button.primary, button.ghost {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      background: rgba(123,215,255,0.12);
      cursor: pointer;
      font-weight: 600;
    }
    button.ghost {
      background: transparent;
    }
    button.danger {
      background: rgba(255,122,122,0.1);
      border-color: rgba(255,122,122,0.35);
    }
    #chat-area {
      flex: 1;
      min-height: 0;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 4px;
    }
    .message {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .message .role {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }
    #composer {
      display: flex;
      gap: 8px;
      align-items: stretch;
      margin-top: 6px;
    }
    #message-input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: var(--text);
    }
    #send-btn {
      padding: 0 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: linear-gradient(160deg, #7bd7ff, #6ab7ff);
      color: #041226;
      font-weight: 700;
      cursor: pointer;
    }
    #status-bar {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    #logs {
      max-height: 120px;
      overflow-y: auto;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
    }
    a.link {
      color: var(--accent-2);
      text-decoration: none;
    }
    #placeholder {
      color: var(--muted);
      text-align: center;
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <div id="app">
    <canvas id="universe-canvas"></canvas>
    <div id="top-bar">
      <div class="brand">
        <div>TheLightrading</div>
        <span>Seed AI universe</span>
      </div>
      <button id="create-node-btn">Nuovo nodo</button>
    </div>
    <aside id="side-panel">
      <header>
        <div class="node-title">Seleziona un nodo</div>
        <div class="node-hash">Nessun nodo attivo</div>
        <div class="actions">
          <button class="primary" id="child-node-btn">Nuovo nodo figlio</button>
          <button class="ghost" id="reset-chat-btn">Reset chat nodo</button>
          <a class="link" id="export-link" href="#" download>Export conversazione</a>
        </div>
      </header>
      <div id="chat-area">
        <div id="messages"></div>
        <div id="placeholder">Clicca su una stella per aprire la chat del nodo.</div>
        <div id="composer">
          <input id="message-input" type="text" placeholder="Invia un pensiero..." />
          <button id="send-btn">Invia</button>
        </div>
        <div id="status-bar">
          <div id="status-text">LLM: inattivo</div>
          <div id="cluster-info"></div>
        </div>
      </div>
      <div id="logs"></div>
    </aside>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.164/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.164/examples/jsm/controls/OrbitControls.js";

    const canvas = document.getElementById("universe-canvas");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050b16);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 8, 22);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const ambient = new THREE.AmbientLight(0x7bd7ff, 0.6);
    const directional = new THREE.DirectionalLight(0xffffff, 0.6);
    directional.position.set(6, 10, 6);
    scene.add(ambient, directional);

    const nodesGroup = new THREE.Group();
    scene.add(nodesGroup);

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    let selectedHash = null;

    const statusText = document.getElementById("status-text");
    const nodeTitleEl = document.querySelector(".node-title");
    const nodeHashEl = document.querySelector(".node-hash");
    const messagesEl = document.getElementById("messages");
    const placeholderEl = document.getElementById("placeholder");
    const logsEl = document.getElementById("logs");
    const clusterInfoEl = document.getElementById("cluster-info");
    const exportLink = document.getElementById("export-link");

    async function api(path, options = {}) {
      const res = await fetch(path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || res.statusText);
      }
      return res.json();
    }

    function createStarMesh(color = 0x7bd7ff) {
      const geometry = new THREE.SphereGeometry(0.4, 24, 24);
      const material = new THREE.MeshStandardMaterial({
        color,
        emissive: new THREE.Color(color).multiplyScalar(0.3),
        roughness: 0.4,
        metalness: 0.2,
      });
      const mesh = new THREE.Mesh(geometry, material);
      const glow = new THREE.PointLight(color, 1.2, 8);
      glow.position.copy(mesh.position);
      mesh.add(glow);
      return mesh;
    }

    function clearMessages() {
      messagesEl.innerHTML = "";
    }

    function renderMessages(messages) {
      clearMessages();
      if (!messages.length) {
        placeholderEl.style.display = "block";
        return;
      }
      placeholderEl.style.display = "none";
      messages.forEach((msg) => {
        const el = document.createElement("div");
        el.className = "message";
        el.innerHTML = `<div class="role">${msg.role}</div><div>${msg.content}</div>`;
        messagesEl.appendChild(el);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderLogs(logs) {
      logsEl.innerHTML = logs
        .map((log) => `[${log.level}] ${log.message}`)
        .join("\n");
    }

    async function loadNode(hash) {
      try {
        const [details, messages, logs] = await Promise.all([
          api(`/api/nodes/${hash}`),
          api(`/api/nodes/${hash}/messages`),
          api(`/api/nodes/${hash}/logs`),
        ]);
        const node = details.node;
        nodeTitleEl.textContent = node.title;
        nodeHashEl.textContent = node.hash;
        clusterInfoEl.textContent = node.cluster_hash ? `Cluster ${node.cluster_hash}` : "";
        exportLink.href = `/api/nodes/${hash}/export`;
        renderMessages(messages.messages || []);
        renderLogs(logs.logs || []);
      } catch (err) {
        console.error(err);
        statusText.textContent = `Errore: ${err.message}`;
      }
    }

    async function loadNodes() {
      const data = await api("/api/nodes");
      nodesGroup.clear();
      data.nodes.forEach((node, idx) => {
        const mesh = createStarMesh(idx % 2 === 0 ? 0x7bd7ff : 0x9af5ff);
        mesh.position.set(
          node.position_x ?? (Math.random() - 0.5) * 12,
          node.position_y ?? (Math.random() - 0.5) * 6,
          node.position_z ?? (Math.random() - 0.5) * 12,
        );
        mesh.userData.hash = node.hash;
        nodesGroup.add(mesh);
      });
    }

    function onCanvasClick(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
      raycaster.setFromCamera(pointer, camera);
      const intersects = raycaster.intersectObjects(nodesGroup.children, true);
      if (intersects.length) {
        const mesh = intersects[0].object;
        const hash = mesh.userData.hash || mesh.parent?.userData?.hash;
        if (hash) {
          selectNode(hash);
        }
      }
    }

    async function selectNode(hash) {
      selectedHash = hash;
      statusText.textContent = "LLM: inattivo";
      await loadNode(hash);
    }

    async function ensureSeedNode() {
      const data = await api("/api/nodes");
      if (data.nodes.length === 0) {
        await api("/api/nodes", {
          method: "POST",
          body: JSON.stringify({ title: "Nodo radice", position: { x: 0, y: 0, z: 0 } }),
        });
      }
    }

    async function sendMessage() {
      if (!selectedHash) return;
      const input = document.getElementById("message-input");
      const content = input.value.trim();
      if (!content) return;
      statusText.textContent = "LLM: in corso...";
      const res = await api(`/api/nodes/${selectedHash}/messages`, {
        method: "POST",
        body: JSON.stringify({ content, role: "user" }),
      });
      statusText.textContent = "LLM: completato";
      input.value = "";
      const allMessages = (await api(`/api/nodes/${selectedHash}/messages`)).messages;
      renderMessages(allMessages);
      const logs = (await api(`/api/nodes/${selectedHash}/logs`)).logs;
      renderLogs(logs);
    }

    async function resetChat() {
      if (!selectedHash) return;
      await api(`/api/nodes/${selectedHash}/reset`, { method: "POST" });
      renderMessages([]);
    }

    async function createChildNode() {
      if (!selectedHash) return;
      const angle = Math.random() * Math.PI * 2;
      const distance = 4;
      const pos = { x: Math.cos(angle) * distance, y: (Math.random() - 0.5) * 2, z: Math.sin(angle) * distance };
      const title = `Nodo figlio ${Math.floor(Math.random() * 999)}`;
      await api("/api/nodes", {
        method: "POST",
        body: JSON.stringify({ title, parent_hash: selectedHash, position: pos }),
      });
      await loadNodes();
    }

    document.getElementById("create-node-btn").addEventListener("click", async () => {
      const title = prompt("Titolo del nuovo nodo", "Nuovo nodo di pensiero") || "Nodo";
      await api("/api/nodes", { method: "POST", body: JSON.stringify({ title }) });
      await loadNodes();
    });

    document.getElementById("send-btn").addEventListener("click", sendMessage);
    document.getElementById("message-input").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });
    document.getElementById("reset-chat-btn").addEventListener("click", resetChat);
    document.getElementById("child-node-btn").addEventListener("click", createChildNode);
    renderer.domElement.addEventListener("click", onCanvasClick);

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    async function bootstrap() {
      await ensureSeedNode();
      await loadNodes();
    }

    bootstrap();

    function animate() {
      requestAnimationFrame(animate);
      nodesGroup.children.forEach((mesh, idx) => {
        mesh.rotation.y += 0.003;
        mesh.rotation.x += 0.0015 + idx * 0.0001;
      });
      controls.update();
      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
