<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>TheLight24 Universe – B2B Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #020617, #000);
      color: #e5e7eb;
      overflow: hidden;
      height: 100dvh;
    }
    #app {
      position: relative;
      width: 100vw;
      height: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
    }
    #universe-canvas {
      position: absolute;
      inset: 0;
      touch-action: none;
    }

    /* Top bar */
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, rgba(15,23,42,0.95), rgba(15,23,42,0.0));
      z-index: 20;
      gap: 6px;
    }
    #brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    #brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    #brand-sub {
      font-size: 10px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }
    #user-panel {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
    }
    .pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.85);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .pill span.label { opacity: 0.7; }
    .btn {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 0;
      color: #e5e7eb;
      background: #2563eb;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.secondary {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.6);
    }
    .btn:active { transform: scale(0.97); }

    @media (max-width: 480px) {
      #top-bar { padding: 4px 6px; }
      #brand-title { font-size: 11px; }
      #brand-sub { display: none; }
      #user-panel { gap: 4px; }
      #btn-cart, #btn-login, #btn-register {
        padding-inline: 6px;
        font-size: 10px;
      }
      #tier-pill { display: none; }
    }

    /* Top-right controls (Indietro + Chat AI) */
    #top-right-controls {
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 25;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      pointer-events: none; /* noi riabilitiamo sui bottoni */
    }
    .top-ctrl-btn {
      pointer-events: auto;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .top-ctrl-btn span.icon {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Bottom info panel */
    #info-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px;
      z-index: 15;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: linear-gradient(to top, rgba(15,23,42,0.98), rgba(15,23,42,0.0));
    }
    #zoom-level { font-size: 11px; opacity: 0.8; }
    #location-path { font-size: 11px; opacity: 0.9; }
    #hint { font-size: 10px; opacity: 0.7; }
    #entity-card {
      margin-top: 4px;
      background: rgba(15,23,42,0.97);
      border-radius: 14px;
      padding: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      display: none;
      flex-direction: column;
      gap: 4px;
    }
    #entity-type {
      font-size: 10px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    #entity-title { font-size: 12px; font-weight: 600; }
    #entity-meta { font-size: 10px; opacity: 0.85; }
    #entity-rating { font-size: 11px; }
    #entity-price-line {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #entity-price {
      font-size: 13px;
      font-weight: 600;
      color: #22c55e;
    }
    #entity-qty {
      width: 60px;
      border-radius: 999px;
      padding: 3px 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
    }
    #entity-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    .tag {
      border-radius: 999px;
      font-size: 9px;
      padding: 2px 6px;
      background: rgba(30,64,175,0.4);
      border: 1px solid rgba(96,165,250,0.5);
    }
    #entity-admin-actions {
      display: none;
      justify-content: flex-end;
      margin-top: 4px;
    }

    /* Floating nav buttons */
    #nav-buttons {
      position: absolute;
      right: 8px;
      bottom: 88px;
      z-index: 16;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .icon-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.92);
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .icon-btn span { font-size: 13px; }

    /* Modal / sheets */
    .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
    }
    .sheet {
      width: 100%;
      max-height: 88dvh;
      background: #020617;
      border-radius: 18px 18px 0 0;
      padding: 10px 14px 14px;
      border: 1px solid #1f2937;
      overflow-y: auto;
    }
    .sheet h2 {
      font-size: 14px;
      margin: 0 0 4px;
    }
    .sheet p {
      font-size: 11px;
      margin: 0 0 8px;
      opacity: 0.8;
    }
    .field {
      margin-bottom: 6px;
    }
    .field label {
      font-size: 11px;
      display: block;
      margin-bottom: 2px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .field textarea {
      min-height: 60px;
      resize: vertical;
    }
    .field small {
      font-size: 9px;
      opacity: 0.6;
    }
    .sheet-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .two-cols {
      display: flex;
      gap: 8px;
    }
    .two-cols .field { flex: 1; }
    @media (max-width: 640px) {
      .two-cols { flex-direction: column; }
    }

    .html-preview {
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 6px 8px;
      font-size: 11px;
      background: #020617;
      max-height: 160px;
      overflow-y: auto;
    }

    /* Cart */
    #cart-list {
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }
    .cart-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(31,41,55,0.8);
    }
    .cart-main { flex: 1; }
    .cart-sku { font-size: 9px; opacity: 0.6; }
    .cart-qty { font-size: 10px; opacity: 0.8; }
    .cart-price { font-size: 11px; font-weight: 600; }
    #cart-total {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      text-align: right;
    }

    #toast {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22,163,74,0.9);
      color: #ecfdf5;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
      z-index: 60;
    }

    /* LLM CHAT SHEET */
    #sheet-llm-chat .sheet {
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }
    #llm-chat-log {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 6px 8px;
      font-size: 11px;
      background: #020617;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .llm-msg {
      padding: 4px 6px;
      border-radius: 8px;
      max-width: 92%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .llm-msg.user {
      align-self: flex-end;
      background: rgba(37,99,235,0.15);
      border: 1px solid rgba(59,130,246,0.6);
    }
    .llm-msg.bot {
      align-self: flex-start;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
    }
    #llm-status {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }
    #llm-chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    #llm-chat-input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
    }
    #btn-llm-send {
      font-size: 11px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 0;
      background: #22c55e;
      color: #022c22;
      cursor: pointer;
    }
    
    /* Controlli globali sopra tutto */
#global-controls {
  position: absolute;
  top: 52px; /* sotto la top-bar per non sovrapporsi ai pulsanti auth */
  right: 8px;
  z-index: 80; /* sopra top-bar, nav, sheet normali */
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

@media (max-width: 640px) {
  #global-controls {
    top: 56px;
    right: 6px;
    left: 6px;
    justify-content: flex-end;
  }
}

/* Chat log */
.chat-log {
  border-radius: 8px;
  border: 1px solid #374151;
  background: #020617;
  padding: 8px;
  font-size: 11px;
  max-height: 260px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 8px;
}

.chat-msg {
  padding: 6px 8px;
  border-radius: 8px;
  max-width: 100%;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.chat-user {
  align-self: flex-end;
  background: rgba(37, 99, 235, 0.7);
}

.chat-assistant {
  align-self: flex-start;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid #1f2937;
}

.chat-system {
  align-self: center;
  background: transparent;
  color: #9ca3af;
  font-size: 10px;
}

#chat-status-row {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 6px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 10px;
  border: 1px solid rgba(148,163,184,0.4);
  background: rgba(15,23,42,0.85);
  color: #e5e7eb;
}

.status-idle {
  border-color: rgba(148,163,184,0.4);
  background: rgba(148,163,184,0.15);
}

.status-pending {
  border-color: rgba(234,179,8,0.5);
  background: rgba(234,179,8,0.15);
  color: #facc15;
}

.status-sent {
  border-color: rgba(34,197,94,0.5);
  background: rgba(34,197,94,0.15);
  color: #4ade80;
}
  </style>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
</head>
<body>
<div id="app">
  <canvas id="universe-canvas"></canvas>

  <!-- TOP BAR -->
  <div id="top-bar">
    <div id="brand">
      <div id="brand-title">THELIGHT24 UNIVERSE</div>
      <div id="brand-sub">Galaxy of Shops • Touch to navigate</div>
    </div>
    <div id="user-panel">
      <div class="pill" id="tier-pill">
        <span class="label">Listino:</span>
        <span id="tier-label">ospite</span>
      </div>
      <button class="btn secondary" id="btn-cart">Carrello (0)</button>
      <button class="btn secondary" id="btn-login">Login</button>
      <button class="btn" id="btn-register">Registrati</button>
    </div>
  </div>

  <!-- TOP RIGHT: INDIETRO + CHAT AI -->
<!-- CONTROLLI GLOBALI (sempre visibili) -->
  <div id="global-controls">
    <button class="btn secondary" id="btn-back">← Indietro</button>
    <button class="btn" id="btn-chat-ai">✦ Chat AI</button>
  </div>

  <!-- BOTTOM PANEL -->
  <div id="info-panel">
    <div id="zoom-level">Livello: GALASSIA</div>
    <div id="location-path">Posizione: /</div>
    <div id="hint">Pinch/zoom o tap per esplorare. Tocca sistemi, stelle, pianeti e satelliti per scendere di livello.</div>

    <div id="entity-card">
      <div id="entity-type"></div>
      <div id="entity-title"></div>
      <div id="entity-meta"></div>
      <div id="entity-rating"></div>
      <div id="entity-price-line">
        <div id="entity-price"></div>
        <div id="entity-qty-wrapper" style="display:none; align-items:center; gap:4px;">
          <span style="font-size:10px;opacity:0.7;">Qtà</span>
          <input id="entity-qty" type="number" min="1" step="1" value="1" />
          <button class="btn" id="btn-add-cart" style="font-size:10px;padding-inline:8px;">+ Carrello</button>
        </div>
      </div>
      <div id="entity-tags"></div>
      <div id="entity-admin-actions">
        <button class="btn secondary" id="btn-edit-product" style="font-size:10px;padding-inline:8px;">Modifica scheda</button>
      </div>
    </div>
  </div>

  <!-- FLOATING NAV BUTTONS -->
  <div id="nav-buttons">
    <button class="icon-btn" id="btn-up">
      <span>↑</span><span>Livello su</span>
    </button>
  </div>

  <!-- MODAL: REGISTRAZIONE -->
  <div class="backdrop" id="sheet-register">
    <div class="sheet">
      <h2>Registrazione B2B / B2C</h2>
      <p>Per vedere i prezzi devi creare un account. Dopo la verifica ti assegneremo il listino commerciale più adatto al tuo profilo.</p>

      <div class="field">
        <label>Sei un’azienda o un privato?</label>
        <select id="reg-type">
          <option value="azienda">Azienda</option>
          <option value="privato">Privato</option>
        </select>
      </div>

      <div class="field">
        <label>Ragione sociale / Nome completo</label>
        <input id="reg-name" placeholder="Es. Ormanet S.r.l. / Mario Rossi" />
      </div>

      <div class="field">
        <label>Partita IVA</label>
        <input id="reg-piva" placeholder="ITXXXXXXXXXXX" />
        <small>Obbligatoria per aziende. Per privati puoi lasciare vuoto.</small>
      </div>

      <div class="field">
        <label>Codice SDI / PEC</label>
        <input id="reg-sdi" placeholder="Codice destinatario o PEC" />
      </div>

      <div class="field">
        <label>Regime fiscale</label>
        <select id="reg-regime">
          <option value="ordinario">Ordinario</option>
          <option value="forfettario">Forfettario</option>
          <option value="minimi">Regime dei minimi</option>
          <option value="privato">Privato / no P.IVA</option>
        </select>
      </div>

      <div class="field">
        <label>Indirizzo completo attività</label>
        <textarea id="reg-address" placeholder="Via, numero civico, CAP, città, provincia, nazione"></textarea>
      </div>

      <div class="field">
        <label>Email</label>
        <input id="reg-email" type="email" placeholder="esempio@azienda.it" />
      </div>

      <div class="field">
        <label>Telefono / WhatsApp</label>
        <input id="reg-phone" placeholder="+39…" />
      </div>

      <div class="field">
        <label>Come ci hai conosciuti?</label>
        <input id="reg-source" placeholder="Google, passaparola, Amazon, fiera, agente, ecc." />
      </div>

      <div class="field">
        <label>Link o note visura camerale</label>
        <textarea id="reg-visura" placeholder="URL alla visura o note (es. allegata via email, disponibile su richiesta)."></textarea>
      </div>

      <div class="field">
        <label>Metodo di pagamento preferito</label>
        <select id="reg-payment">
          <option value="bonifico">Bonifico bancario (default)</option>
          <option value="contrassegno">Contrassegno</option>
          <option value="carta">Carta / POS virtuale</option>
          <option value="altro">Altro (da concordare)</option>
        </select>
      </div>

      <div class="field">
        <label>
          <input type="checkbox" id="reg-terms" />
          Accetto termini & condizioni, informativa privacy e condizioni di pagamento.
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-reg-cancel">Annulla</button>
        <button class="btn" id="btn-reg-submit">Crea account</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGIN -->
  <div class="backdrop" id="sheet-login">
    <div class="sheet">
      <h2>Login</h2>
      <p>Accedi con la tua email e la password impostata dopo l’attivazione account.</p>

      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="login-password" type="password" />
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-login-cancel">Annulla</button>
        <button class="btn" id="btn-login-submit">Entra</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CARRELLO -->
  <div class="backdrop" id="sheet-cart">
    <div class="sheet">
      <h2>Carrello</h2>
      <p>Riepilogo articoli selezionati. L’ordine viene inviato come richiesta al reparto commerciale.</p>

      <div id="cart-list"></div>
      <div id="cart-total">Totale: 0,00 €</div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-cart-clear">Svuota</button>
        <button class="btn" id="btn-cart-checkout">Invia richiesta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CHAT LLM -->
  <div class="backdrop" id="sheet-chat-ai">
    <div class="sheet">
      <h2>Chat AI locale</h2>
      <p>Assistente locale per domande in linguaggio naturale.</p>

      <div id="chat-log" class="chat-log">
        <!-- messaggi -->
      </div>

      <div id="chat-status-row">
        <span id="chat-status" class="status-badge status-idle">Non inviato</span>
      </div>

      <div class="field">
        <label>Messaggio</label>
        <textarea id="chat-input" placeholder="Scrivi qui la tua domanda..."></textarea>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-chat-close">Chiudi</button>
        <button class="btn" id="btn-chat-send">Invia</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PRODUCT EDITOR -->
  <div class="backdrop" id="sheet-product-editor">
    <div class="sheet">
      <h2>Editor scheda prodotto</h2>
      <p>Modifica contenuti, immagini HD e listini partendo dal listino madre.</p>

      <div class="two-cols">
        <div class="field">
          <label>SKU (bloccato)</label>
          <input id="prod-sku" readonly />
        </div>
        <div class="field">
          <label>Nome prodotto</label>
          <input id="prod-name" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>URL immagine HD principale</label>
          <input id="prod-image-hd" placeholder="https://..." />
        </div>
        <div class="field">
          <label>URL immagine thumbnail</label>
          <input id="prod-image-thumb" placeholder="https://..." />
        </div>
      </div>

      <div class="field">
        <label>Gallery immagini (una URL per riga)</label>
        <textarea id="prod-gallery" placeholder="https://img1...\nhttps://img2..."></textarea>
      </div>

      <div class="field">
        <label>Descrizione HTML (sorgente)</label>
        <textarea id="prod-desc-html" placeholder="<h2>Caratteristiche</h2>..."></textarea>
      </div>
      <div class="field">
        <label>Preview descrizione</label>
        <div id="prod-desc-preview" class="html-preview"></div>
      </div>

      <h2>Listini & ricarichi</h2>
      <p>Imposta il listino madre e le % di ricarico per i listini figli. I prezzi vengono ricalcolati automaticamente.</p>

      <div class="two-cols">
        <div class="field">
          <label>Prezzo listino madre (base)</label>
          <input id="prod-base-price" type="number" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Unità di misura (solo nota)</label>
          <input id="prod-unit" placeholder="es. pz, risma, conf, kg" />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore +10%"</label>
          <input id="prod-markup-riv10" type="number" step="0.1" />
          <small>Es. 10 = +10% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore +10%</label>
          <input id="prod-price-riv10" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "rivenditore"</label>
          <input id="prod-markup-riv" type="number" step="0.1" />
          <small>Es. 20 = +20% sul listino madre.</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato rivenditore</label>
          <input id="prod-price-riv" type="text" readonly />
        </div>
      </div>

      <div class="two-cols">
        <div class="field">
          <label>% ricarico listino "distributore"</label>
          <input id="prod-markup-dist" type="number" step="0.1" />
          <small>Puoi anche usare valori negativi per sconti (-5 = -5%).</small>
        </div>
        <div class="field">
          <label>Prezzo calcolato distributore</label>
          <input id="prod-price-dist" type="text" readonly />
        </div>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="btn-prod-cancel">Annulla</button>
        <button class="btn" id="btn-prod-save">Salva scheda</button>
      </div>
    </div>
  </div>
  <!-- MODAL: LLM CHAT -->
   <div class="backdrop" id="sheet-llm-chat">
     <div class="sheet">
       <h2>AI Assistant – TheLight24</h2>
       <p>Chat locale con l’assistente AI in esecuzione sul dispositivo.</p>
 
       <div id="llm-chat-log"></div>
       <div id="llm-status"></div>
 
       <div id="llm-chat-input-row">
         <input id="llm-chat-input" type="text" placeholder="Scrivi una domanda (es. suggerimento prodotti HP)..." />
         <button id="btn-llm-send">Invia</button>
       </div>
 
       <div class="sheet-actions">
         <button class="btn secondary" id="btn-llm-close">Chiudi</button>
       </div>
     </div>
   </div>
 
   <div id="toast"></div>
 </div>
 
 <script>
    const BASE_URL = window.location.origin || "http://127.0.0.1:8080"; // stesso host/porta per backend ecom
    const LLM_URL  = `${BASE_URL}/api/llm/chat`; // server Phi-3 su Termux
 
   let currentUser = {
     logged: false,
     tier: "ospite", // ospite | rivenditore10 | rivenditore | distributore
     name: null,
   };
 
   let zoomLevel = "GALASSIA";
   let currentPath = [];
   let currentSystem = null;
   let currentCategory = null;
   let currentSubcategory = null;
   let currentEntity = null;     // sistema / categoria / prodotto corrente
   let currentEntityType = null; // 'system' | 'category' | 'product'
 
   let cart = [];
   let currentProductPrice = 0;
 
   const canvas = document.getElementById("universe-canvas");
   const tierLabel = document.getElementById("tier-label");
   const zoomLevelLabel = document.getElementById("zoom-level");
   const locationPathLabel = document.getElementById("location-path");
   const toast = document.getElementById("toast");
   const chatStatus = document.getElementById("chat-status");
 
    const entityCard = document.getElementById("entity-card");
    async function sendChatMessage() {
      if (!chatInput) return;
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";
      appendChatMessage("user", text);
      setChatStatus("pending");

      const payload = {
        prompt: `Sei un assistente AI locale, integrato nella GUI TheLight24 Universe. Rispondi in italiano.\n\nUtente: ${text}\nAssistente:`,
        n_predict: 256,
        temperature: 0.7,
        top_k: 40,
        top_p: 0.9
      };

      try {
        const res = await fetch(LLM_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        let reply = "";

        // 1) Caso: content è stringa
        if (data && typeof data.content === "string") {
          reply = data.content;
        }
        // 2) Caso: content è array di pezzi (stile llama.cpp nuovo)
        else if (data && Array.isArray(data.content)) {
          reply = data.content
            .map(p => (typeof p === "string" ? p : (p && p.content) || ""))
            .join("");
        }
        // 3) Caso: stile "choices" (tipo OpenAI)
        else if (data && Array.isArray(data.choices) && data.choices.length) {
          const ch = data.choices[0];
          if (typeof ch.text === "string") {
            reply = ch.text;
          } else if (ch.message && typeof ch.message.content === "string") {
            reply = ch.message.content;
          }
        }
        // 4) fallback: buttiamo giù il JSON intero
        else {
          reply = JSON.stringify(data, null, 2);
        }

        if (!reply) {
          reply = "[Nessun testo ricevuto dal modello]";
        }

        appendChatMessage("assistant", String(reply).trim());
        setChatStatus("sent");
      } catch (e) {
        appendChatMessage("system", "Errore nel contattare il servizio AI.");
        setChatStatus("idle");
      }
    }

   function setChatStatus(state) {
     if (!chatStatus) return;
     chatStatus.classList.remove("status-idle", "status-pending", "status-sent");
     if (state === "pending") {
       chatStatus.textContent = "Pending";
       chatStatus.classList.add("status-pending");
     } else if (state === "sent") {
       chatStatus.textContent = "Inviato";
       chatStatus.classList.add("status-sent");
     } else {
       chatStatus.textContent = "Non inviato";
       chatStatus.classList.add("status-idle");
     }
   }
 
   if (btnChat) {
     btnChat.addEventListener("click", () => {
       showSheet(sheetChat);
       setChatStatus("idle");
       if (chatInput) chatInput.focus();
     });
   }
   if (btnChatClose) {
     btnChatClose.addEventListener("click", () => hideSheet(sheetChat));
   }
   if (btnChatSend) {
     btnChatSend.addEventListener("click", sendChatMessage);
   }
   if (chatInput) {
     chatInput.addEventListener("keydown", (e) => {
       if (e.key === "Enter" && !e.shiftKey) {
         e.preventDefault();
         sendChatMessage();
       }
     });
   }
 
   // Bottone indietro globale: chiude modali e resetta la mappa

  // Bottone indietro globale: chiude modali e resetta la mappa
  function globalBack() {
    [sheetRegister, sheetLogin, sheetCart, sheetProduct, sheetChat].forEach(el => {
      if (el) el.style.display = "none";
    });
    entityCard.style.display = "none";
    resetToGalaxy();
  }

  if (btnBack) {
    btnBack.addEventListener("click", globalBack);
  }

  // EXPORT MINIMO
  window.TheLightUniverse = {
    getCurrentProduct: () => (currentEntityType === "product" ? currentEntity : null),
    getCurrentUser: () => currentUser,
    showToast,
    BASE_URL,
    openProductEditor
  };

  updateUserUI();
  updateLabels();
</script>
</body>
</html>